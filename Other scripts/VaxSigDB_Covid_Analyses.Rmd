---
title: "VAX SIG DB"
output: html_notebook
editor_options: 
  markdown: 
    wrap: 72
---

# Libraries

```{r eval=FALSE, echo=TRUE}
library(readr)
library(explore)
library(maditr)
library(GEOquery)
library(Matrix)
library(vegan)
library(circlize)
library(RColorBrewer)
library(celldex)
library(biomaRt)
library(org.Hs.eg.db)
library(plotly)
library(DESeq2)
library(msigdbr)
library(ape)
library(GSVA)
library(here)
library(sva)
library(clusterProfiler)
library(pheatmap)
library(EnhancedVolcano)
library(ggbeeswarm)
library(tidyverse)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(ggsci)
library(factoextra)
library(esquisse)
library(corto)
library(factoextra)
library(reshape2)
library(ComplexHeatmap)
library(janitor)
```

# Gene sets construction

### Blood transcription modules <https://www.nature.com/articles/ni.2789>

```{r}
#Converter ítens de "Module member genes" em linhas em uma tabela longa
btm_annotation_table_long_immune <- BTM_modules %>%
  separate_rows(`Module member genes`, sep = ",") %>% 
  filter(`Module category` == "immune")

#Salvar
write.csv(btm_annotation_table_long_immune, file = "btm_annotation_table_long_immune.csv")

#Display
head(btm_annotation_table_long_immune)

#Calculate Set size
btm_annotation_nested <- btm_annotation_table_long_immune %>%
  group_by(`Module title`) %>% #Somar e agrupar
  mutate(SetSize = n())

#Convert gene symbol column to aggregated rows
btm_annotation_nested <- btm_annotation_nested %>%
  group_by(`Module title`) %>%
  summarize(Genes = paste(`Module member genes`, collapse = ", "), .groups = "drop") %>% 
  left_join(btm_annotation_nested, by = "Module title") %>% 
  filter(Genes != "NA") %>% 
  relocate(Genes, .after="SetSize")

#Salvar
write.csv(btm_annotation_nested, file = "btm_annotation_genes.csv")

#Convert to unique values table
btm_annotation_unique = btm_annotation_nested %>% 
  select(-`Module member genes`)

btm_annotation_unique = btm_annotation_unique %>% 
  distinct() %>% 
  relocate(Genes, .after="SetSize") %>% 
  filter(Genes != "NA")

#salvar
write.csv(btm_annotation_unique, file = "btm_annotation_unique.csv")

#Display
head(btm_annotation_unique)

btm_annotation_table_long_immune
```

### CellMarker

Download database from
"<http://117.50.127.228/CellMarker/CellMarker_download_files/file/Cell_marker_Human.xlsx>"

```{r}
##################### Baixar tabela de marcadores celulares

url <- "http://117.50.127.228/CellMarker/CellMarker_download_files/file/Cell_marker_Human.xlsx" 
f <- tempfile(fileext = ".xlsx")
download.file(url, f)
cell_marker_data <- readxl::read_excel(f, 1)

##################### Sub-agrupar células por sistema imunológico

#Filtrar marcadores e células por tecido (Blood)
cells <- cell_marker_data %>%
    filter(tissue_class == "Blood") %>%
    select(cell_name, marker)

##################### Filtrar células
# Acessar todos os tipos de células no dataset de Blood
cellmarker_celltypes <- unique(cells$cell_name)

# Filtrar apenas os tipos que contêm "B cell" e plasmacell
Bcells_no = cellmarker_celltypes[grep("B cell", cellmarker_celltypes)] #44 outputs
Plasmacells_no = cellmarker_celltypes[grep("plasma", cellmarker_celltypes)] #5 outputs

# Filtrar apenas os tipos que contêm "T cell" e seus subtipos "CD4" e "CD8"
Tcells_no = cellmarker_celltypes[grep("T cell", cellmarker_celltypes)] #93 outputs
TCD4_no = cellmarker_celltypes[grep("CD4", cellmarker_celltypes)] #35 outputs
TCD8_no = cellmarker_celltypes[grep("CD8", cellmarker_celltypes)] #34 outputs
Treg_no = cellmarker_celltypes[grep("Treg", cellmarker_celltypes)] #7 outputs
Thelper_no = cellmarker_celltypes[grep("helper", cellmarker_celltypes)] #17 outputs

# Filtrar outros tipos celulares da resposta imune
Neutrophils_no = cellmarker_celltypes[grep("neutrophil", cellmarker_celltypes)] #7 outputs
Monocyte_no = cellmarker_celltypes[grep("monocyte", cellmarker_celltypes)] #14 outputs
DCells_no = cellmarker_celltypes[grep("dendritic", cellmarker_celltypes)] #25 outputs
Macrophages_no = cellmarker_celltypes[grep("macrophage", cellmarker_celltypes)] #7 outputs
NKcells_no = cellmarker_celltypes[grep("killer", cellmarker_celltypes)] # 11 outputs
Neutrophils_no = cellmarker_celltypes[grep("mastcell", cellmarker_celltypes)] #7 outputs

# Criar variáveis para cada célula para enriquecimento

# Filtrar apenas as células da resposta imune adaptativa
Bcells <- filter(cells, str_detect(cell_name, regex("B cell|plasma cell|plasmablast", ignore_case = TRUE)))
TCD4 <- filter(cells, str_detect(cell_name, regex("CD4", ignore_case = TRUE)))
TCD8 <- filter(cells, str_detect(cell_name, regex("CD8", ignore_case = TRUE)))
Treg <- filter(cells, str_detect(cell_name, regex("Treg", ignore_case = TRUE)))
Thelper <- filter(cells, str_detect(cell_name, regex("helper", ignore_case = TRUE)))


# Filtrar células da resposta imune inata
Neutrophils <- filter(cells, str_detect(cell_name, regex("neutrophil", ignore_case = TRUE)))
Monocyte <- filter(cells, str_detect(cell_name, regex("monocyte", ignore_case = TRUE)))
DCells <- filter(cells, str_detect(cell_name, regex("dendritic", ignore_case = TRUE)))
Macrophages <- filter(cells, str_detect(cell_name, regex("macrophage", ignore_case = TRUE)))
Mastcells <- filter(cells, str_detect(cell_name, regex("mast cell", ignore_case = TRUE)))
NKcells <- filter(cells, str_detect(cell_name, regex("killer", ignore_case = TRUE)))
Platelets <- filter(cells, str_detect(cell_name, regex("Platelet", ignore_case = TRUE)))
Eosinophil <- filter(cells, str_detect(cell_name, regex("Eosinophil", ignore_case = TRUE)))
Basophil <- filter(cells, str_detect(cell_name, regex("Basophil", ignore_case = TRUE)))
Granulocyte <- filter(cells, str_detect(cell_name, regex("Granulocyte", ignore_case = TRUE)))

#Agrupar todos os resultados em Immune cells
Immune_adap = rbind(Bcells, TCD4, TCD8, Treg, Thelper)
Immune_adap$Type = "Adaptive"

Immune_innate = rbind(Neutrophils, Monocyte, DCells, Macrophages, Mastcells, NKcells, Platelets, Eosinophil, Basophil, Granulocyte)
Immune_innate$Type = "Innate"

#Unir tabelas
Immune_cells = rbind(Immune_adap, Immune_innate) 

#Salvar
write.csv(Immune_cells, file = "CellMarker_ImmuneCells.csv")

esquisser(Immune_cells_markersbycells)
```

Top 20 cells by #markers

```{r fig.height=5, fig.width=7}
Immune_cells = readRDS(here("Tables", "CellMarker_ImmuneCells.rds"))
Immune_cells_markersbycells = Immune_cells %>% 
  group_by(cell_name, Type) %>% 
  summarise(n_markers = n()) %>% 
  arrange(desc(n_markers))
Immune_cells_markersbycells_top = Immune_cells_markersbycells[1:20, ]

ggImmune_cells_cellsbyimmune = ggplot(Immune_cells_markersbycells_top) +
  aes(x = reorder(cell_name, n_markers), y = n_markers, fill = Type) +
  scale_fill_npg() +
  geom_col() +
  labs(
    x = "",
    y = "#Markers",
    title = "Top 20 cells by #markers"
  ) +
  coord_flip() +
  theme_minimal() +
  theme(axis.text = element_text(color = "black", size = 10),
        legend.text = element_text(color = "black", size = 10),
        axis.line.x  = element_line(size = 0.5, color ="black"),
        axis.line.y  = element_line(size = 0.5, color ="black"),
        axis.text.x = element_text(angle = 0, vjust = 1, hjust=0.5),
        axis.ticks = element_line(size = 0.5, color ="black"),
        panel.grid.major = element_line(linetype = 2, color = "gray90"),
        panel.grid.minor = element_line(linetype = 2, size = 0, color = "gray90"),
        # panel.grid.x = element_line(linetype = 2, color = "gray75"),
        # panel.grid.y = element_line(linetype = 2, color = "gray75"),
        strip.text = element_text(size = 10, color = "black"),
        legend.direction = "horizontal",
        legend.position = "top") +
  scale_y_continuous(expand = c(0, 0))
ggImmune_cells_cellsbyimmune


ggImmune_cells_cellsbyimmune %>% 
  ggsave(filename = here("Figures", "CellMarker_Top10_cellsbyn_markers.png"), width = 7, height = 5)


```

Number of Cells by immune system

```{r}
Immune_cells_cellsbyimmune = Immune_cells %>% 
  group_by(Type, cell_name) %>% 
  summarise(n_cells = n()) %>% 
  group_by(Type) %>% 
  summarise(n_cells = n())

ggImmune_cells_cellsbyimmune = ggplot(Immune_cells_cellsbyimmune) +
  aes(x = reorder(Type, n_cells), y = n_cells, fill = Type) +
  geom_col() +
  scale_fill_manual(values = c('Innate' = "#989898",
                               'Adaptive' = "#6DF8DF")) +
  labs(
    x = "#Cells",
    y = "Immune system",
    title = "#Cells by immune system"
  ) +
  coord_flip() +
  theme_minimal() +
  geom_text(aes(label = n_cells, y = n_cells), 
            position = position_dodge(width = 0.9), 
            vjust = -0.2, 
            hjust = -0.2, 
            size = 3)
ggsave(ggImmune_cells_cellsbyimmune, file= "CellMarker_nCellsbyimmunesystem.png", width = 10, height = 2)

print(ggImmune_cells_cellsbyimmune)
```

### ImmuneGO

```{r}
organism = "org.Hs.eg.db"
install.packages("GO.db")
BiocManager::install(organism, character.only = TRUE)
library(organism, character.only = TRUE)
library(clusterProfiler)
library(GO.db)

#HGNC symbol to Entrez
x <- org.Hs.egSYMBOL
mapped_genes <- mappedkeys(x)
symbols_entrez <- as.data.frame(x[mapped_genes])

## Entrez to GO
x <- org.Hs.egGO
mapped_genes <- mappedkeys(x)
entrez_geneontology <- as.data.frame(x[mapped_genes])

## GO BP ancestors
go_bp_ancestor = GOBPANCESTOR %>% 
  as.data.frame()
colnames(go_bp_ancestor)[1] <- "go_id"
colnames(go_bp_ancestor)[2] <- "go_ancestor"

## GO ID to terms
go_bp = AnnotationDbi::select(GO.db, columns=c("GOID","TERM"), keys= "BP", keytype= "ONTOLOGY") %>% 
  clean_names() %>% 
  select(go_id = goid, term)

## GO child and ancestor
go_bp_ancestor = go_bp_ancestor %>% 
  inner_join(go_bp %>% rename(go_ancestor = go_id), by = "go_ancestor") %>% 
  rename(term_ancestor = term)

#GO ids to terms
go_bp = AnnotationDbi::select(GO.db, columns=c("GOID","TERM"), keys="BP", keytype="ONTOLOGY") %>% 
  clean_names() %>% 
  rename(go_id = goid) %>% 
  select(-ontology) %>% 
  right_join(entrez_geneontology, by = "go_id") %>% 
  right_join(symbols_entrez, by = "gene_id") %>% 
  clean_names() %>% 
  left_join(go_bp_ancestor, by = "go_id") %>% 
  distinct()

#GO immune process

immunego_go.bp = go_bp %>% 
  filter(term_ancestor == "immune system process") %>% 
  mutate(term = toupper(term))

ImmuneGO_Annotated_Genes_26_2_24 = ImmuneGO_Annotated_GO_8_2_24 %>% 
  select(-"...1") %>% 
  mutate(genes = str_replace_all(genes, "\\s+", "")) %>% 
  separate_rows(genes, sep = ",") %>% 
  full_join(immunego_go.bp %>% select(genes = symbol, process = term), by = join_by("process", "genes")) %>% 
  distinct()

ImmuneGO_Annotated_GO_26_2_24 = ImmuneGO_Annotated_Genes_26_2_24 %>% 
  group_by(process) %>%
  summarize(genes = paste0(genes, collapse = ",")) %>%
  inner_join(ImmuneGO_Annotated_Genes_26_2_24 %>% select(-genes) %>% distinct(), by = "process")

write.csv(ImmuneGO_Annotated_GO_26_2_24, file = "ImmuneGO_Annotated_GO_26_2_24.csv", row.names = F)

write.csv(ImmuneGO_Annotated_Genes_26_2_24, file = "ImmuneGO_Annotated_Genes_26_2_24.csv", row.names = F)

```

Group immune system genes by process and cell

```{r}
ImmuneGO_Annotated_unique = ImmuneGO_Annotated_Genes %>% 
  filter(go_term != "Manual")

#Agrupar genes de todos os processos do sistema imune ----

ImmuneGO_Adaptive <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "Adaptive") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ADAPTIVE IMMUNE SYSTEM",
  `Gene set, short` = "Adaptive immune system",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "Innate") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "INNATE IMMUNE SYSTEM",
  `Gene set, short` = "Innate immune system",
  `Immune system` = "Innate",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Complement <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "Complement") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "COMPLEMENT",
  `Gene set, short` = "Complement immune system",
  `Immune system` = "Complement",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Inflammation <- ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system == "Inflammation") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "INFLAMMATION",
  `Gene set, short` = "Inflammation",
  `Immune system` = "Innate",
  `Immune sub-system` = "Inflammation",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Interferon <- ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system %in% c("Antiviral", "Interferon")) %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ANTIVIRAL & IFN",
  `Gene set, short` = "Antiviral and Interferon",
  `Immune system` = "Innate",
  `Immune sub-system` = "Antiviral and Interferon",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_ARPP = ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system %in% c("PRR", "APC")) %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ARPP",
  `Gene set, short` = "Antigen receptors, processing and presentation",
  `Immune system` = "Innate",
  `Immune sub-system` = "APC",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()


ImmuneGO_Innate_DC <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Dendritic cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "DENDRITIC CELL",
  `Gene set, short` = "Dendritic cell",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Macrophage <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Macrophage") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "MACROPHAGE",
  `Gene set, short` = "Macrophage",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Mastcell <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Mast cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "MAST CELL",
  `Gene set, short` = "Mast cell",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "Mast cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Neutrophil <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Neutrophil") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "NEUTROPHIL",
  `Gene set, short` = "Neutrophil",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "Neutrophil",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Eosinophil <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Eosinophil") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "EOSINOPHIL",
  `Gene set, short` = "Eosinophil",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "Eosinophil",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_NK <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "NK cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "NK CELL",
  `Gene set, short` = "Natural Killer Cell",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "NK cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Innate_Monocyte <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Monocyte") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "MONOCYTE",
  `Gene set, short` = "Monocyte",
  `Immune system` = "Innate",
  `Immune sub-system` = "Cell",
  `Immune tissue` = "APC",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Cellular <- ImmuneGO_Annotated_unique %>% 
  filter(immune_sub_system == "Cellular") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "CELLULAR ADAPTIVE IMMUNE SYSTEM",
  `Gene set, short` = "Cellular adaptive immune system",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Cellular",
  `Immune tissue` = "Cellular",
  `GO.TERM` = "Manual") %>% 
  clean_names()


ImmuneGO_Adap_Tcell <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "T cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "T CELL",
  `Gene set, short` = "T cell",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Cellular",
  `Immune tissue` = "Cellular",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Thelper <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "T helper") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "T HELPER CELLS",
  `Gene set, short` = "T helper cell",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Cellular",
  `Immune tissue` = "Cellular",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Humoral <- ImmuneGO_Annotated_unique %>%
  filter(immune_sub_system == "Humoral") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "HUMORAL ADAPTIVE IMMUNE SYSTEM",
  `Gene set, short` = "Humoral adaptive immune system",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Humoral",
  `Immune tissue` = "Humoral",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Bcell <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "B cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "B CELL",
  `Gene set, short` = "B cell",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Humoral",
  `Immune tissue` = "B cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_Adap_Ig <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "B cell") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "IMMUNOGLOBULIN MEDIATED RESPONSE",
  `Gene set, short` = "Ig-mediated response",
  `Immune system` = "Adaptive",
  `Immune sub-system` = "Humoral",
  `Immune tissue` = "B cell",
  `GO.TERM` = "Manual") %>% 
  clean_names()

ImmuneGO_other <- ImmuneGO_Annotated_unique %>%
  filter(immune_system == "General" |
         immune_tissue == "Leukocyte") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "GENERAL",
  `Gene set, short` = "General",
  `Immune system` = "General",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()


ImmuneGO_antimicrobial <- ImmuneGO_Annotated_unique %>%
  filter(immune_tissue == "Antimicrobial") %>% 
  summarize(set_size = n(), 
            genes = paste(genes, collapse = ",")) %>% 
  mutate(process = "ANTIMICROBIAL",
  `Gene set, short` = "Antimicrobial immune response",
  `Immune system` = "General",
  `Immune sub-system` = "General",
  `Immune tissue` = "General",
  `GO.TERM` = "Manual") %>% 
  clean_names()


# Unite sets -----

ImmuneGO_Annotated_GO = bind_rows(ImmuneGO_Adaptive, 
                            ImmuneGO_Innate, 
                            ImmuneGO_Complement, 
                            ImmuneGO_Inflammation,
                            ImmuneGO_Interferon,
                            ImmuneGO_ARPP,
                            ImmuneGO_Innate_Macrophage,
                            ImmuneGO_Innate_Mastcell,
                            ImmuneGO_Innate_Neutrophil,
                            ImmuneGO_Innate_Eosinophil,
                            ImmuneGO_Innate_NK,
                            ImmuneGO_Innate_Monocyte,
                            ImmuneGO_Adap_Cellular,
                            ImmuneGO_Adap_Tcell,
                            ImmuneGO_Adap_Thelper,
                            ImmuneGO_Adap_Humoral,
                            ImmuneGO_Adap_Bcell,
                            ImmuneGO_Adap_Ig,
                            ImmuneGO_other,
                            ImmuneGO_antimicrobial,
                            ImmuneGO_Innate_DC,
                            ImmuneGO_Annotated_unique) %>% 
  select(process:go_term, set_size:genes) %>% 
  distinct()

ImmuneGO_Annotated_Genes = ImmuneGO_Annotated_GO %>% 
   separate_rows(genes, sep = ",")

# Separate TCR and BCR repertoire genes
TCR_BCR_repertoire = ImmuneGO_Annotated_Genes %>% 
  filter(grepl("^TR", genes) & process == "ADAPTIVE IMMUNE SYSTEM" |
           grepl("^IG", genes) & process == "ADAPTIVE IMMUNE SYSTEM" |
           grepl("^TR", genes) & process == "CELLULAR ADAPTIVE IMMUNE SYSTEM" |
         grepl("^IG", genes) & process == "HUMORAL ADAPTIVE IMMUNE SYSTEM") %>% 
  mutate(process = if_else(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM", "TCR REPERTOIRE", 
                           "BCR REPERTOIRE"),
         gene_set_short = if_else(process == "TCR REPERTOIRE", 
                                  "TCR REPERTOIRE", 
                           "BCR REPERTOIRE"),
         process = if_else(grepl("^TR", genes), "TCR REPERTOIRE", "BCR REPERTOIRE"),
         immune_sub_system = if_else(process == "TCR REPERTOIRE", "Cellular", "Humoral"),
         immune_tissue = if_else(process == "TCR REPERTOIRE", "Cellular", "Humoral"))

immunego_manual = ImmuneGO_Annotated_Genes %>%
  filter(go_term == "Manual") %>% 
  anti_join(TCR_BCR_repertoire %>% select(genes) %>% distinct(), by = "genes") %>% 
  bind_rows()

#Verify if all genes are annotated. If there are no left genes, you are good to go
a = ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual") %>% select(genes) %>% distinct()
ImmuneGO_Annotated_Genes %>% select(process, genes, immune_system) %>% anti_join(a, by = "genes")


#Salvar
write.csv(ImmuneGO_Annotated_GO, file = paste0("ImmuneGO_Annotated_GO_", today(), ".csv"), row.names = F)
saveRDS(ImmuneGO_Annotated_GO, file = paste0("ImmuneGO_Annotated_GO_", today(), ".rds"))
saveRDS(ImmuneGO_Annotated_Genes, file = paste0("ImmuneGO_Annotated_Genes_", today(), ".rds"))

#Display
view(ImmuneGO_Annotated_GO)
view(ImmuneGO_Annotated_Genes)

```

Top 10 gene sets
```{r}
#Top 10 gene sets
ImmuneGO_Annotated_unique_top10 = ImmuneGO_Annotated_GO %>% 
  clean_names() %>% 
  arrange(desc(set_size)) %>% 
  slice_head(n = 20) %>% 
  mutate(immune_system = if_else(gene_set_short == "Adaptive Immune response", "Adaptive", immune_system))

#Gráfico de barras
ImmuneGO_top10_barplot = ggplot(ImmuneGO_Annotated_unique_top10) +
 aes(x = reorder(gene_set_short, set_size), 
     weight = set_size, 
     fill = immune_system) +  # Use reorder para reordenar as barras +
  geom_bar()+
  scale_fill_manual(
    values = c(Adaptive = "#6DF8DF",
    Complement = "#e9edc9",
    General = "#bde0fe",
    Innate = "#989898",
    Undefined = "#edede9")) +
 labs(y = "Set size", title = "ImmuneGO", subtitle = "Top 10 GO, by set size") +
 coord_flip() +
 theme_minimal()

#Salvar
ggsave(ImmuneGO_top10_barplot, file="ImmuneGO_top10_barplot.png", width = 10, height = 6)

#Display
head(ImmuneGO_top10_barplot)
```



### ImmuneGO + BTM

```{r}
btm_annotation_genes = readRDS(here("VaxGO gene sets", "btm_annotation_genes.rds"))
ImmuneGO_Annotated_Genes = readRDS(here("VaxGO gene sets", "ImmuneGO_Annotated_Genes_2024-03-26.rds"))
ImmuneGO_Annotated_GO = read_csv(here("VaxGO gene sets", "ImmuneGO_Annotated_GO_2024_03_26.csv"))

#Unite genes
immunego_btm_genes = ImmuneGO_Annotated_Genes %>% 
              select(genes) %>% 
              distinct() %>% 
              mutate(set = "ImmuneGO") %>% 
  bind_rows(btm_annotation_genes %>% 
              select(genes) %>% 
              distinct() %>% 
              mutate(set = "BTM")) %>% 
  arrange(genes)

immunego_btm_genes_joined = immunego_btm_genes %>% 
  bind_rows(immunego_btm_genes %>% mutate(set = "BTM and ImmuneGO")) %>% 
  distinct()


#Unite subsets
btm_annotation_grouped = btm_annotation_genes %>% 
  group_by(complete_name) %>% 
  rename(process = complete_name) %>% 
  mutate(genes = paste0(genes, collapse = ",")) %>% 
  distinct() %>% 
  mutate(genes = paste0(genes, collapse = ","),
            immune_set = "BTM by Modules") %>% 
    select(process,
           immune_system:cells,
           set_size = module_size,
           genes,
           immune_set)

ImmuneGO_annotation_modules = ImmuneGO_Annotated_GO %>% 
  filter(go_term != "Manual") %>% 
    select(process = gene_set_short, 
           immune_system:immune_tissue,
           set_size, genes) %>% 
    rename(cells = immune_tissue,
           immune_subsystem = immune_sub_system) %>% 
    mutate(immune_set = "ImmuneGO by Modules")

immunego_btm_specific_grouped = btm_annotation_grouped %>% 
  bind_rows(ImmuneGO_annotation_modules)
  
immunego_btm_specific_grouped %>% 
  write_csv(file = here("VaxGO gene sets", "ImmuneGO_BTM_grouped_genesets_specific.csv"))

  
#By immune system
btm_immunesystem = btm_annotation_genes %>% 
  select(immune_system, genes) %>% 
  distinct() %>% 
  rename(process = immune_system) %>% 
  group_by(process) %>% 
  summarize(genes = paste0(genes, collapse = ","),
            set_size = n(),
            process = str_to_upper(process),
            # id = process,
            immune_system = process,
            immune_subsystem = process,
            cells = process,
            complete_name = process,
            annotation_level = "Manual",
            immune_set = "BTM by Immune System") %>% 
  distinct()

#By immune subsystem
btm_immunesubsystem = btm_annotation_genes %>% 
  select(immune_subsystem, genes) %>% 
  distinct() %>% 
  rename(process = immune_subsystem) %>% 
  group_by(process) %>% 
  summarize(genes = paste0(genes, collapse = ","),
            process = str_to_upper(process),
            set_size = n(),
            # id = process,
            immune_system = process,
            immune_subsystem = process,
            cells = process,
            complete_name = process,
            annotation_level = "Manual",
            immune_set = "BTM by Immune Sub-System") %>% 
  distinct() 
#By cell
btm_cells = btm_annotation_genes %>% 
  select(cells, genes) %>%
  distinct() %>% 
  rename(process = cells) %>% 
  group_by(process) %>% 
  summarize(genes = paste0(genes, collapse = ","),
            set_size = n(),
            process = str_to_upper(process),
            # id = process,
            immune_system = process,
            immune_subsystem = process,
            cells = process,
            annotation_level = "Manual",
            complete_name = process,
            immune_set = "BTM by Immune Cell") %>% 
  distinct() 
#Merge
btm_manual = bind_rows(btm_immunesystem,
          btm_immunesubsystem,
          btm_cells) %>% 
  arrange(complete_name) %>% 
  select(complete_name, everything()) %>% 
  distinct()

btm_manual_grouped = bind_rows(btm_manual,
                               btm_annotation_grouped) %>% 
  distinct()


#Merge ImmuneGO and BTM main processes
immunego_btm_manual_grouped = btm_manual %>% 
  select(process, genes, immune_set, set_size) %>% 
  mutate(immune_set = "BTM") %>% 
  bind_rows(ImmuneGO_Annotated_GO %>% 
              filter(go_term == "Manual") %>% 
              select(process, genes, set_size) %>% 
              mutate(immune_set = "ImmuneGO")) %>% 
  arrange(process) %>% 
  mutate(process = case_when(process == "ADAPTIVE" ~ "ADAPTIVE IMMUNE SYSTEM",
                              process == "ALL" ~ "IMMUNE SYSTEM",
                              process == "GENERAL" ~ "LEUKOCYTES",
                              process == "CELLS" ~ "LEUKOCYTES",
                              process == "DCS" ~ "DENDRITIC CELL",
                              process == "APP" ~ "ARPP",
                              process == "CELLULAR" ~ "CELLULAR ADAPTIVE IMMUNE SYSTEM",
                              process == "DCS, MYELOID" ~ "DENDRITIC CELL",
                              process == "GENERIC" ~ "LEUKOCYTES",
                              process == "HUMORAL" ~ "HUMORAL ADAPTIVE IMMUNE SYSTEM",
                              process == "INNATE" ~ "INNATE IMMUNE SYSTEM",
                              process == "INTERFERON" ~ "ANTIVIRAL & IFN",
                              process == "NK" ~ "NK CELL",
                              process == "B CELL, PLASMA CELL" ~ "B CELL",
                              process == "PLASMA CELL" ~ "B CELL",
                              process == "PRR" ~ "ARPP",
                              process == "SIGNALING" ~ "SIGNALING",
                              process == "TH2" ~ "T CELL",
                              process == "TH1" ~ "T CELL",
                              process == "T HELPER CELLS" ~ "T CELL",
                              TRUE ~ process
                              )) %>% 
  distinct() %>% 
  bind_rows(
    immunego_btm_specific_grouped)

immunego_btm_manual_grouped_genes = immunego_btm_manual_grouped %>%
  separate_rows(genes, sep = ",") %>% 
  distinct()

immunego_btm_manual_grouped_genes = immunego_btm_manual_grouped_genes %>% 
  bind_rows(
    immunego_btm_manual_grouped_genes %>% 
      mutate(immune_set = "BTM and ImmuneGO") %>% 
      distinct()
  )
  
  
immunego_btm_manual_grouped %>% 
  write_csv(file = here("VaxGO gene sets", "ImmuneGO_BTM_grouped_genesets.csv"))

immunego_btm_manual_grouped_genes %>% 
  write_csv(file = here("VaxGO gene sets", "ImmuneGO_BTM_grouped_genes.csv"))
  
```

Plot relative frequency of genes by main process
```{r fig.height=5, fig.width=7}

#Get exclusive genes
immunego_only_genes = immunego_btm_manual_grouped_genes %>% 
  filter(immune_set == "ImmuneGO") %>% 
  select(-immune_set, -set_size) %>% 
  anti_join(immunego_btm_manual_grouped_genes %>% 
            filter(immune_set == "BTM"),
            by = "genes") %>% 
  mutate(immune_set = "ImmuneGO only") %>% 
  distinct()

btm_only_genes = immunego_btm_manual_grouped_genes %>% 
  filter(immune_set == "BTM") %>% 
  select(-immune_set, -set_size) %>% 
  anti_join(immunego_btm_manual_grouped_genes %>% 
            filter(immune_set == "ImmuneGO"),
            by = "genes") %>% 
  mutate(immune_set = "BTM only") %>% 
  distinct()

btm_immune_joined_stats = immunego_only_genes %>% 
  bind_rows(btm_only_genes) %>% 
  distinct() %>% 
  mutate(immune_set = "BTM and ImmuneGO") %>% 
  select(process, genes, immune_set) %>% 
  distinct() %>% 
  group_by(process) %>% 
  distinct() %>% 
  mutate(ntotal=n()) %>% 
  ungroup() %>% 
  select(process, ntotal) %>% 
  distinct() %>% 
  inner_join(immunego_only_genes %>% 
               bind_rows(btm_only_genes), by = "process") %>% 
  group_by(process, immune_set) %>% 
  mutate(n = n(),
         genes = paste0(genes, collapse = ",")) %>% 
  select(-genes) %>% 
  distinct() %>% 
  ungroup() %>% 
  mutate(n_perc = (n/ntotal) * 100)

btm_immune_joined_stats_plot = btm_immune_joined_stats %>% 
  filter(!process %in% c("LYMPHOCYTE", 
                         "IMMUNOGLOBULIN MEDIATED RESPONSE",
                         "MYELOID CELL", 
                         "SIGNALING", 
                         "IMMUNE SYSTEM")) %>%
  mutate(process = str_to_title(process),
         process = fct_relevel(process, 
                               "Leukocytes",
                               "Adaptive Immune System",
                               "Innate Immune System",
                               "Complement"	,
                               "Cellular Adaptive Immune System",
                               "Humoral Adaptive Immune System",
                               )) %>% 
 ggplot() +
  aes(x = n_perc, y = fct_rev(process), fill = immune_set) +
  geom_bar(stat = "summary", fun = "sum", position = "fill") +
  scale_fill_manual(values = c("BTM only" = "#5e60ce",
                               "ImmuneGO only" = "#00A087FF")) +
  theme_minimal() +
  theme(legend.position = "right",
        strip.text.x = element_text(color = "black", size = 12), 
        axis.text.x = element_text(color = "black", size = 10),
        axis.text.y = element_text(vjust = 0.5, size = 10, color = "black"),
        axis.line = element_line(size = 0.5, colour = "black", linetype=1),
        axis.ticks = element_line(size = 0.5, color = "black")) +
  labs(x = "%Coverage",
       y = "",
       fill = "Immune set",
       subtitle = "Merged data",
       title = "ImmuneGO and BTM main processes genes") +
  scale_x_continuous(expand = c(0,0)) +
  geom_text(aes(label = paste0(round(n_perc, 0))), 
            position = position_fill(vjust = 0.5), 
            size = 3, 
            color = "white",
            fontface = "bold") 

btm_immune_joined_stats_plot %>% 
  ggsave(filename = here("Figures", "ImmuneGO_BTM_Joined_Stats_barplot.png"),
         width = 10,
         height = 7)

btm_immune_joined_stats_plot
```


### VAX MSigDB


```{r}
#Importar arquivo
VaxSigDB_genesets = VAX_GeneSets_Annotated_26_10_23

# Divida os dados em blocos de informações para cada vacina
vaccines_att <- split(VaxSigDB_genesets$Col2, VaxSigDB_genesets$Col1)

# Combine data
VAX_Genesets <- bind_rows(lapply(vaccines_att, function(x) data.frame(t(x))), .id = "V")

# Name a new index column
colnames(VAX_Genesets) <- paste0("V", seq_len(ncol(VAX_Genesets)))

# Transpose
rownames(VAX_Genesets) <- VAX_Genesets$V1
VAX_Genesets = VAX_Genesets %>% 
  t() %>%
  as.data.frame()

#Order columns
VAX_Genesets = VAX_Genesets %>% 
  select(STANDARD_NAME, everything()) %>% 
  filter(STANDARD_NAME != "STANDARD_NAME") 
rownames(VAX_Genesets) = VAX_Genesets$SYSTEMATIC_NAME
VAX_Genesets = VAX_Genesets %>% select(STANDARD_NAME, 
                                       DESCRIPTION_BRIEF,
                                       DESCRIPTION_FULL,
                                       PMID,
                                       AUTHORS,
                                       SYSTEMATIC_NAME,
                                       GENE_SYMBOLS,
                                       everything())

#Anotar novas colunas
VAX_Genesets <- VAX_Genesets %>%
  mutate(
    SAMPLE_SOURCE = ifelse(
      grepl("pbmc|peripheral blood mononuclear cell|peripheral blood mononuclear cells", DESCRIPTION_FULL, ignore.case = TRUE) |
      grepl("pbmc|peripheral blood mononuclear cell|peripheral blood mononuclear cells", DESCRIPTION_BRIEF, ignore.case = TRUE),
      "PBMC",
      ifelse(
        grepl("whole blood", DESCRIPTION_FULL, ignore.case = TRUE) |
        grepl("whole blood", DESCRIPTION_BRIEF, ignore.case = TRUE) |
        grepl("_BLOOD", STANDARD_NAME, ignore.case = TRUE)  ,
        "WHOLE BLOOD",
        "OTHER")),
    REGULATION = ifelse(
      grepl("up", DESCRIPTION_BRIEF, ignore.case = TRUE),
      "UP",
      ifelse(
        grepl("down", DESCRIPTION_BRIEF, ignore.case = TRUE),
        "DOWN",
        "UNKNOWN")))

#Reordenar colunas
VAX_Genesets = VAX_Genesets %>% select(SAMPLE_SOURCE, REGULATION, everything())

# Salvar
write.csv(VAX_Genesets, file = "VAXSigDB_Annotated.csv") #Continuar a anotação no Google Sheets

head(VAX_Genesets)
```

 Long table with Gene symbols

```{r}
############## Long table with Gene symbols

VAX_Genesets = VAXSigDB_Annotated

VAX_Genes <- VAX_Genesets %>%
  mutate(GENE = GENE_SYMBOLS) %>% 
  separate_rows(GENE, sep = ",") %>% 
  select(GENE, everything()) %>%
  group_by(STANDARD_NAME) %>%
  mutate(SetSize = n()) %>% 
  relocate(SetSize, .after = GENE_SYMBOLS)

VAX_GeneSets_annotated <- VAX_Genes %>%
  select(-GENE) %>% 
  distinct()

#Salvar
write.csv(VAX_Genes, file = "VAX_Genes_Annotated_RAW.csv")
write.csv(VAX_GeneSets_annotated, file = "VAX_Genesets_Annotated_RAW.csv")

#Display
head(VAX_GeneSets_annotated)
```

Filtering

```{r}
unique(VAX_GeneSets_annotated$STUDY_TYPE) 
#"CORRELATION"
#"VACCINE"
#"SUBSET"
#"CHALLENGE"

unique(VAX_GeneSets_annotated$STUDY_SUBTYPE)
# "ANTIBODY"				
# "VAC ONLY"				
# "BOOSTER"				
# "VAC VS CTRL"				
# "SIGNATURE"				
# "ADVERSE EVENT"			
# "COMPARISON"				
# "RESPONDER VS NON RESPONDER"				
# "AGE"				
# "RESPONDER"				
# "ADJUVANT"				
# "NON RESPONDER"				
# "ANTIMICROBIAL ACTIVITY"				
# "CELLS"				
# "CHALLENGE"				
# "TOP DEGS"				
# "PROTECTION"				
# "TRAINING SET"				
# "EXON ANALYSIS"				
# "DOSE"				
# "VAC VS OTHER"


# Subset de vacinas para as seguintes análises comparativas
VAX_GeneSets_Blood_PBMC_VAC = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("VACCINE"))

# Subset de vacinas com resultados de comparações entre vacinas, adjuvantes, idade e sexo
VAX_GeneSets_Blood_PBMC_CORR = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("CORRELATION"))

# Subset com resultados de correlações com resposta inata, celular e humoral
VAX_GeneSets_Blood_PBMC_SUBSETS = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("SUBSET"))


# Subset de vacinas com genes associados a eventos adversos
VAX_GeneSets_Blood_PBMC_CHALLENGE = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("CHALLENGE"))

VAX_GeneSets_Blood_PBMC_VAC.stats = VAX_GeneSets_Blood_PBMC_VAC %>% 
  group_by(VACCINE, PLATFORM, REGULATION, `TARGET_PATHOGEN_DISEASE`, MICROBE_TYPE) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count))

```




## Analysis


### Descriptive
Exclusive genes by set
```{r}
ImmuneGO_BTM_genes <- readRDS(file = here("Tables", "ImmuneGO_BTM_genes.rds"))

immunego_genes_total = ImmuneGO_BTM_genes %>%
  group_by(immune_set) %>% 
  summarize(n_genes = n()) %>% 
  filter(immune_set %in% c("BTM", "ImmuneGO"))

immunego_genes_total %>% 
  summarize(immune_set,
            n_genes,
            n_genes_perc = n_genes/sum(n_genes)*100,
            n_genes_perc = n_genes_perc %>% round(1)) %>% 
  mutate(label = paste0(immune_set, "\n", "(", n_genes_perc, "%, ", n_genes, ")")) %>% 
  pivot_longer(cols = -c(immune_set, label),
               names_to = "var",
               values_to = "value") %>% 
 filter(var %in% "n_genes_perc") %>%
 ggplot() +
  aes(x = var, y = value, fill = immune_set) +
  geom_col(show.legend = F) +
  geom_text(aes(label = label), 
            vjust = -2,
            color = "white") +
  scale_fill_npg() +
  coord_polar(theta = "y") +

  labs(title = "Immune set by genes") +
  theme_void()
  
```


Exclusive genes by set in immune processes
```{r fig.height=7, fig.width=7}
immunego_genes_total_process = ImmuneGO_BTM_genes %>%
  filter(is.na(immune_system)) %>% 
  group_by(immune_set, process) %>% 
  summarize(n_genes = n()) %>% 
  filter(immune_set %in% c("BTM", "ImmuneGO")) %>% 
  group_by(process) %>% 
  summarize(immune_set,
            process,
            n_genes,
            n_genes_total = sum(n_genes),
            n_genes_perc = n_genes/sum(n_genes)*100,
            n_genes_perc = n_genes_perc %>% round(1)) %>%
  mutate(label = paste0(immune_set, "\n", "(", n_genes_perc, "%, ", n_genes, ")"))


### Percentage
immunego_genes_total_process %>% 
  ungroup() %>% 
  arrange(process, immune_set, -n_genes_perc) %>% 
  
  # pivot_longer(cols = -c(immune_set, label, process),
  #              names_to = "var",
  #              values_to = "value") %>% 
 # filter(var %in% "n_genes_perc") %>%
 ggplot() +
  aes(y = process, x = n_genes_perc, fill = immune_set) +
  geom_col(show.legend = T) +
  scale_fill_npg() +
  labs(title = "Immune set by genes",
       x = "Percentage",
       y = "") +
  theme_minimal() 
  # facet_wrap(~process, nrow = 5)


### Total
immunego_genes_total_process %>% 
  mutate(process = case_when(process == "INNATE IMMUNE SYSTEM" ~ "INNATE",
                             process == "ADAPTIVE IMMUNE SYSTEM" ~ "ADAPTIVE",
                             process == "HUMORAL ADAPTIVE IMMUNE SYSTEM" ~ "HUMORAL ADAP.",
                             process == "CELLULAR ADAPTIVE IMMUNE SYSTEM" ~ "CELLULAR ADAP.",
                             process == "IMMUNOGLOBULIN MEDIATED RESPONSE" ~ "Ig-MEDIATED RESPONSE",
                             TRUE ~ process)) %>% 
  ungroup() %>% 
  arrange(process, immune_set, -n_genes_perc) %>% 
  
  # pivot_longer(cols = -c(immune_set, label, process),
  #              names_to = "var",
  #              values_to = "value") %>% 
 # filter(var %in% "n_genes_perc") %>%
 ggplot() +
  aes(y = process %>% 
        fct_reorder(n_genes_total), x = n_genes, fill = immune_set) +
  geom_col(show.legend = T) +
  scale_fill_npg() +
  labs(title = "Immune set by genes",
       x = "Total genes",
       y = "",
       fill = "Immune set") +
  theme_minimal() +
  theme(axis.text = element_text(color = "black", size = 10),
        legend.text = element_text(color = "black", size = 10),
        axis.line.x  = element_line(size = 0.5, color ="black"),
        axis.line.y  = element_line(size = 0.5, color ="black"),
        axis.text.x = element_text(angle = 0, vjust = 1, hjust=0.5),
        axis.ticks = element_line(size = 0.5, color ="black"),
        panel.grid.major = element_line(linetype = 2, color = "gray90"),
        panel.grid.minor = element_line(linetype = 2, size = 0, color = "gray90"),
        # panel.grid.x = element_line(linetype = 2, color = "gray75"),
        # panel.grid.y = element_line(linetype = 2, color = "gray75"),
        strip.text = element_text(size = 10, color = "black"),
        legend.direction = "horizontal",
        legend.position = "top") +
  scale_x_continuous(expand = c(0,0))
  
```

Most shared genes

```{r}
library(dplyr)
ImmuneGO_BTM_genes %>% 
  select(-immune_set) %>% 
  distinct() %>% 
  filter(is.na(immune_system)) %>% 
  group_by(genes) %>% 
  summarize(genes,
            n_shared = n()) %>% 
  distinct() %>% 
  arrange(-n_shared)
  
```

Cell marker

Most genes by cells
```{r}
Immune_cells = readRDS(here("Tables", "CellMarker_ImmuneCells.rds"))

Immune_cells = readRDS(here("Tables", "CellMarker_ImmuneCells.rds"))
Immune_cells_markersbycells = Immune_cells %>% 
  group_by(cell_name, Type) %>% 
  summarise(n_markers = n()) %>% 
  arrange(desc(n_markers))
Immune_cells_markersbycells_top = Immune_cells_markersbycells[1:20, ]

ggImmune_cells_cellsbyimmune = ggplot(Immune_cells_markersbycells_top) +
  aes(x = reorder(cell_name, n_markers), y = n_markers, fill = Type) +
  scale_fill_npg() +
  geom_col() +
  labs(
    x = "",
    y = "#Markers",
    title = "Top 20 cells by #markers"
  ) +
  coord_flip() +
  theme_minimal() +
  theme(axis.text = element_text(color = "black", size = 10),
        legend.text = element_text(color = "black", size = 10),
        axis.line.x  = element_line(size = 0.5, color ="black"),
        axis.line.y  = element_line(size = 0.5, color ="black"),
        axis.text.x = element_text(angle = 0, vjust = 1, hjust=0.5),
        axis.ticks = element_line(size = 0.5, color ="black"),
        panel.grid.major = element_line(linetype = 2, color = "gray90"),
        panel.grid.minor = element_line(linetype = 2, size = 0, color = "gray90"),
        # panel.grid.x = element_line(linetype = 2, color = "gray75"),
        # panel.grid.y = element_line(linetype = 2, color = "gray75"),
        strip.text = element_text(size = 10, color = "black"),
        legend.direction = "horizontal",
        legend.position = "top") +
  scale_y_continuous(expand = c(0, 0))
ggImmune_cells_cellsbyimmune


ggImmune_cells_cellsbyimmune %>% 
  ggsave(filename = here("Figures", "CellMarker_Top10_cellsbyn_markers.png"), width = 7, height = 5)

```

```{r}
Immune_cells = readRDS(here("Tables", "CellMarker_ImmuneCells.rds"))
Immune_cells_markers = Immune_cells %>% 
  select(marker, cell_name) %>%
  group_by(marker) %>% 
  summarise(n_cells = n(),
            cells = str_c(cell_name, collapse = ", ")) %>% 
  arrange(desc(n_cells))

Immune_cells_markers %>% 
  slice_head(n = 20) %>% 
  ggplot() +
   aes(x = n_cells, y = reorder(marker, n_cells)) +
  scale_fill_npg() +
  geom_col() +
  labs(
    x = "",
    y = "#Markers",
    title = "Top 20 cells by #markers"
  ) +
  theme_minimal() +
  theme(axis.text = element_text(color = "black", size = 10),
        legend.text = element_text(color = "black", size = 10),
        axis.line.x  = element_line(size = 0.5, color ="black"),
        axis.line.y  = element_line(size = 0.5, color ="black"),
        axis.text.x = element_text(angle = 0, vjust = 1, hjust=0.5),
        axis.ticks = element_line(size = 0.5, color ="black"),
        panel.grid.major = element_line(linetype = 2, color = "gray90"),
        panel.grid.minor = element_line(linetype = 2, size = 0, color = "gray90"),
        # panel.grid.x = element_line(linetype = 2, color = "gray75"),
        # panel.grid.y = element_line(linetype = 2, color = "gray75"),
        strip.text = element_text(size = 10, color = "black"),
        legend.direction = "horizontal",
        legend.position = "top") +
  scale_x_continuous(expand = c(0, 0))
```




### Overlapping genes

Input

```{r}
# Gene set data.
ImmuneGO_BTM_genes

data = ImmuneGO_BTM_genes %>% 
  filter(is.na(immune_system)) %>% 
 select(process, genes)

filename = "ImmuneGO_BTM"
```

Function

```{r}
# Function for overlapping -------
overlap_genes <- function(cond1, cond2, data) {
  genes_cond1 <- data$genes[data$process == cond1]
  genes_cond2 <- data$genes[data$process == cond2]
  
  genes_shared <- intersect(genes_cond1, genes_cond2)
  
  genes_notshared_cond1 <- setdiff(genes_cond1, genes_cond2)
  genes_notshared_cond2 <- setdiff(genes_cond2, genes_cond1)
  
  total_genes_cond1 <- length(genes_cond1)
  total_genes_cond2 <- length(genes_cond2)
  
  percentage_shared_cond1 <- length(genes_shared) / total_genes_cond1 * 100
  percentage_shared_cond2 <- length(genes_shared) / total_genes_cond2 * 100
  
  shared_genes <- data.frame(
    Cond1 = cond1,
    Cond2 = cond2,
    Shared = length(genes_shared),
    NotShared_cond1 = length(genes_notshared_cond1),
    NotShared_cond2 = length(genes_notshared_cond2),
    Total_Genes_Cond1 = total_genes_cond1,
    Total_Genes_Cond2 = total_genes_cond2,
    Genes_Names = paste(genes_shared, collapse = ", "),
    Percentage_Shared_Cond1 = percentage_shared_cond1,
    Percentage_Shared_Cond2 = percentage_shared_cond2
  )
  
  return(shared_genes)
}
```

Perform calculations

```{r}

conflicted::conflicts_prefer(base::intersect)
conflicted::conflicts_prefer(base::setdiff)
conflicted::conflicts_prefer(stats::fisher.test)
conflicted::conflicts_prefer(dplyr::rename)


# Perform calculations
unique_cond <- unique(data$process) # List sets
shared_genes_df <- data.frame() # Store data

for (i in 1:(length(unique_cond) - 1)) {
  for (j in (i + 1):length(unique_cond)) {
    resultado_temp <- overlap_genes(unique_cond[i], unique_cond[j], data)
    shared_genes_df <- bind_rows(shared_genes_df, resultado_temp)
  }
}

# Fisher's exact test
fisher_exact_test <- function(shared, notshared1, notshared2) {
  cont_table <- matrix(c(shared, notshared1, notshared2, 0), nrow = 2)
  results_fisher <- fisher.test(cont_table)
  return(results_fisher$p.value)
}
shared_genes_df = shared_genes_df %>%
  mutate(pvalue = pmap_dbl(list(Shared, NotShared_cond1, NotShared_cond2), fisher_exact_test)) %>% 
  mutate("-log(p)" = -log10(pvalue))


#Mirror table
shared_genes_df2 = shared_genes_df %>% 
  rename(Cond1_temp = Cond1, Cond2_temp = Cond2) %>%
  rename(Cond1 = Cond2_temp, Cond2 = Cond1_temp)

shared_genes_df_mirror = shared_genes_df %>% 
  bind_rows(shared_genes_df2) %>% 
  mutate(Percentage_Shared_Cond1 = round(Percentage_Shared_Cond1, 2),
         Percentage_Shared_Cond2 = round(Percentage_Shared_Cond2, 2))
  
#Jaccard distance
jaccard.matrix <- data %>%
  mutate(present = 1) %>% 
  distinct() %>% 
  pivot_wider(names_from = genes, values_from = present, values_fill = 0) %>%
  column_to_rownames(var = "process") %>%
  vegdist(binary = TRUE, method = "jaccard", diag = TRUE, upper = TRUE) %>%
  as.matrix() %>%
  {1 - .}

shared_genes_df_mirror = jaccard.matrix %>% 
  as.data.frame() %>% 
  rownames_to_column("Cond1") %>% 
  pivot_longer(cols = -"Cond1",
               names_to = "Cond2",
               values_to = "jaccard_distance") %>% 
  inner_join(shared_genes_df_mirror, by = join_by(Cond1, Cond2)) %>% 
  mutate(jaccard_distance = round(jaccard_distance, 3))

#Save
write_csv(shared_genes_df_mirror, 
          file = here("Tables", paste0(filename, "_sharedgenes_Fisher_Jaccard.csv")))

```
Heatmap

Jaccard distance

```{r fig.height=10, fig.width=12}

filename = "ImmuneGO_BTM"

shared_genes_df_mirror = read_csv(file = here("Tables", "ImmuneGO_BTM_sharedgenes_Fisher_Jaccard.csv"))

matrix_data = shared_genes_df_mirror %>% 
  mutate(Cond1 = case_when(Cond1 == "INNATE IMMUNE SYSTEM" ~ "INNATE",
                             Cond1 == "ADAPTIVE IMMUNE SYSTEM" ~ "ADAPTIVE",
                             Cond1 == "HUMORAL ADAPTIVE IMMUNE SYSTEM" ~ "HUMORAL ADAP.",
                             Cond1 == "CELLULAR ADAPTIVE IMMUNE SYSTEM" ~ "CELLULAR ADAP.",
                             Cond1 == "IMMUNOGLOBULIN MEDIATED RESPONSE" ~ "Ig-MEDIATED RESPONSE",
                             TRUE ~ Cond1)) %>% 
  mutate(Cond2 = case_when(Cond2 == "INNATE IMMUNE SYSTEM" ~ "INNATE",
                             Cond2 == "ADAPTIVE IMMUNE SYSTEM" ~ "ADAPTIVE",
                             Cond2 == "HUMORAL ADAPTIVE IMMUNE SYSTEM" ~ "HUMORAL ADAP.",
                             Cond2 == "CELLULAR ADAPTIVE IMMUNE SYSTEM" ~ "CELLULAR ADAP.",
                             Cond2 == "IMMUNOGLOBULIN MEDIATED RESPONSE" ~ "Ig-MEDIATED RESPONSE",
                             TRUE ~ Cond2)) %>% 
  maditr::dcast(Cond1 ~ Cond2, 
        value.var = "jaccard_distance", 
        fun.aggregate = mean) %>% 
  column_to_rownames("Cond1") %>%
  mutate_if(is.character, as.numeric) %>% 
  as.matrix() 

dim(matrix_data)

# col_fun <- colorRamp2(c(0, 1), c("white", "#d90429"))
# Quantile interpolation
quartiles <- quantile(matrix_data, probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
# col_fun <- colorRamp2(quartiles, c("white", "#a8dadc", "#457b9d", "#d90429", "#1d3557"))
col_fun <- colorRamp2(quartiles, c("white", "#a8dadc", "#457b9d", "#EFC000FF", "#d90429"))
# col_fun <- colorRamp2(quartiles, c("white", "#E8E79AFF", "#8CBF9AFF", "#477B95FF", "#011C40FF"))


mat = matrix_data
width_image = 30
height_image = 20
width = unit(15, "cm")
height = unit(15, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray1", lwd = 0)



fileimageheatmap_grouped = paste0(filename, sep ="_", "Jaccard_Heatmap.png")

png(
  file = here("Figures", fileimageheatmap_grouped),
  width = width_image,
  height = height_image,
  units = "cm",
  res = 900
)

heatmap_plot_all = Heatmap(mat,
                        # top_annotation = ha,
                        # left_annotation = row_ha,
                        
                        show_row_names = TRUE, 
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        name = "Jaccard distance", #Legend
                        col = col_fun, #color
                         cell_fun = function(j, i, x, y, width, height, fill) {
  if (!is.na(mat[i, j]) && mat[i, j] > 0.05) {
    grid.text(sprintf("%.2f", mat[i, j]), x, y, gp = gpar(fontsize = 5))
  }
},
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        cluster_rows = TRUE,
                        rect_gp = rect_gp,
                        row_names_gp = row_names_gp,
                        # row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        na_col = "black",
                        column_split = NULL, #Split group clusters
                        #column_km = 3,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, 
                        height = height
)

draw(heatmap_plot_all, annotation_legend_side = "left")

dev.off()

heatmap_plot_all
```











# VAX Sig DB

Os estudos foram filtrados pelo tamanho do conjunto de genes
compartilhados (GSSize \> 10 ou \>50) e com pvalue (\<0.25).

Os dados foram anotados no R e depois avaliados manualmente no excel.

```{r}
#Importar arquivo
VaxSigDB_genesets = VAX_GeneSets_Annotated_26_10_23

# Divida os dados em blocos de informações para cada vacina
vaccines_att <- split(VaxSigDB_genesets$Col2, VaxSigDB_genesets$Col1)

# Combine data
VAX_Genesets <- bind_rows(lapply(vaccines_att, function(x) data.frame(t(x))), .id = "V")

# Name a new index column
colnames(VAX_Genesets) <- paste0("V", seq_len(ncol(VAX_Genesets)))

# Transpose
rownames(VAX_Genesets) <- VAX_Genesets$V1
VAX_Genesets = VAX_Genesets %>% 
  t() %>%
  as.data.frame()

#Order columns
VAX_Genesets = VAX_Genesets %>% 
  select(STANDARD_NAME, everything()) %>% 
  filter(STANDARD_NAME != "STANDARD_NAME") 
rownames(VAX_Genesets) = VAX_Genesets$SYSTEMATIC_NAME
VAX_Genesets = VAX_Genesets %>% select(STANDARD_NAME, 
                                       DESCRIPTION_BRIEF,
                                       DESCRIPTION_FULL,
                                       PMID,
                                       AUTHORS,
                                       SYSTEMATIC_NAME,
                                       GENE_SYMBOLS,
                                       everything())

#Anotar novas colunas
VAX_Genesets <- VAX_Genesets %>%
  mutate(
    SAMPLE_SOURCE = ifelse(
      grepl("pbmc|peripheral blood mononuclear cell|peripheral blood mononuclear cells", DESCRIPTION_FULL, ignore.case = TRUE) |
      grepl("pbmc|peripheral blood mononuclear cell|peripheral blood mononuclear cells", DESCRIPTION_BRIEF, ignore.case = TRUE),
      "PBMC",
      ifelse(
        grepl("whole blood", DESCRIPTION_FULL, ignore.case = TRUE) |
        grepl("whole blood", DESCRIPTION_BRIEF, ignore.case = TRUE) |
        grepl("_BLOOD", STANDARD_NAME, ignore.case = TRUE)  ,
        "WHOLE BLOOD",
        "OTHER")),
    REGULATION = ifelse(
      grepl("up", DESCRIPTION_BRIEF, ignore.case = TRUE),
      "UP",
      ifelse(
        grepl("down", DESCRIPTION_BRIEF, ignore.case = TRUE),
        "DOWN",
        "UNKNOWN")))

#Reordenar colunas
VAX_Genesets = VAX_Genesets %>% select(SAMPLE_SOURCE, REGULATION, everything())

# Salvar
write.csv(VAX_Genesets, file = "VAXSigDB_Annotated.csv") #Continuar a anotação no Google Sheets

head(VAX_Genesets)

############## Long table with Gene symbols

VAX_Genesets = VAXSigDB_Annotated

# Separar genes por linhas e somar numero de genes
VAX_Genes <- VAX_Genesets %>%
  mutate(GENE = GENE_SYMBOLS) %>% 
  separate_rows(GENE, sep = ",") %>% 
  select(GENE, everything()) %>%
  group_by(STANDARD_NAME) %>% #Somar e agrupar
  mutate(SetSize = n()) %>% 
  relocate(SetSize, .after = GENE_SYMBOLS)

VAX_GeneSets_annotated <- VAX_Genes %>%
  select(-GENE) %>% #Retirar coluna
  distinct() #Retirar linhas repetidas

#Salvar
write.csv(VAX_Genes, file = "VAX_Genes_Annotated_RAW.csv")
write.csv(VAX_GeneSets_annotated, file = "VAX_Genesets_Annotated_RAW.csv")

#Display
head(VAX_GeneSets_annotated)
```

# Descriptive statistics

```{r}
########## Descriptive statistics
vaccines = VAX_GeneSets_annotated %>% 
  group_by(VACCINE, PLATFORM, `TARGET_PATHOGEN_DISEASE`, MICROBE_TYPE) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count))

pathogens = VAX_GeneSets_annotated %>% 
  group_by(`TARGET_PATHOGEN_DISEASE`, MICROBE_TYPE) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count))

platforms = VAX_GeneSets_annotated %>% 
  group_by(PLATFORM) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count))


#By vaccines -----
vaccine_hist = ggplot(vaccines) +
  aes(x = reorder(VACCINE, Count),
      y = Count,
      fill = `MICROBE_TYPE`) + 
  ggtitle("VAX MSigDB - Vaccines, by platform and target") +
  geom_col() +
  geom_text(aes(label = Count), vjust = 0, hjust = 2, size = 3) +
  coord_flip() +
  theme_minimal() + 
  labs(fill = "Vaccine target type") +
  theme(plot.title = element_text(face = "bold", colour = "black", size = (20)),
  legend.title = element_text(face = "bold"),
  axis.title = element_text(size = (10), colour = "black"),
  axis.text = element_text(colour = "black", size = (10))) +
  facet_wrap(vars(PLATFORM), scales = "free") + 
  scale_fill_manual(values = c('VIRUS'= "#d00000",
                               'BACTERIUM' = "#16E0BD",
                               'PARASITE' = "#118ab2",
                              'MENINGOCOCCUS'	= "#16E0BD",
                             'PNEUMOCOCCUS'	= "#44C199",
                             'TUBERCULOSIS'	= "#99e2b4",
                             'F TULARENSIS'	= "#90e0ef",
                             'LEISHMANIA'	= "#118ab2",
                             'MALARIA' = "#3f37c9",
                             'EBOV'	= "#d00000",
                             'HBV'	= "#e85d04",
                             'HBV, HAV'	= "#f48c06",
                             'HIV'	= "#a4133c",
                             'HPV'	= "#f27059",
                             'INFLUENZA'	= "#ffa69e",
                             'MEASLES'	= "#c65b7c",
                             'MMR'	= "#f9b5ac",
                             'SMALLPOX'	= "#ff8c42",
                             'VEEV'	= "#e01e37",
                             'VZV'	= "#ff9b85",
                             'YF'	= "#f38375"))


ggsave(vaccine_hist, file = "VAXSigDB_Vaccines_platforms_pathogens_1.png", width = 25, height = 8)

# By platforms-----

platforms_hist = ggplot(platforms) +
  aes(x = reorder(`PLATFORM`, Count),
      y = Count,
      fill = `PLATFORM`) + 
  ggtitle("VAX MSigDB - Vaccine platforms") +
  geom_col() +
  geom_text(aes(label = Count), vjust = 0, hjust = 0, size = 3) +
  coord_flip() +
  theme_minimal() + 
  labs(fill = "Platform") +
  theme(plot.title = element_text(face = "bold", colour = "black", size = (20)),
  legend.title = element_text(face = "bold"),
  axis.title = element_text(size = (10), colour = "black"),
  axis.text = element_text(colour = "black", size = (10))) +
  #facet_wrap(vars(PLATFORM), scales = "free") + 
  scale_fill_manual(values = c('IN'= "#1e6091",
                               'LA' = "#16E0BD",
                               'VV' = "#34a0a4",
                               'CONJ' = "#76c893",
                               'VLP' = "#b5e48c", 
                               'SU' = "#2ec4b6",
                               'LA and IV' = "#cbf3f0",
                               'SUB' = "#00bbf9",
                               'PEP' = "#c0fdff"))

ggsave(platforms_hist, file = "VAXSigDB_Platforms_hist_1.png", width = 10, height = 5)


# By pathogens ----
pathogens_hist = ggplot(pathogens) +
  aes(x = reorder(`TARGET_PATHOGEN_DISEASE`, Count),
      y = Count,
      fill = `MICROBE_TYPE`) + 
  ggtitle("VAX MSigDB - Vaccines, by platform and target") +
  geom_col() +
  geom_text(aes(label = Count), vjust = 0, hjust = 0, size = 3) +
  coord_flip() +
  theme_minimal() + 
  labs(fill = "Vaccine target type") +
  theme(plot.title = element_text(face = "bold", colour = "black", size = (20)),
  legend.title = element_text(face = "bold"),
  axis.title = element_text(size = (10), colour = "black"),
  axis.text = element_text(colour = "black", size = (10))) +
  #facet_wrap(vars(PLATFORM), scales = "free") + 
  scale_fill_manual(values = c('VIRUS'= "#d00000",
                               'BACTERIUM' = "#16E0BD",
                               'PARASITE' = "#118ab2",
                              'MENINGOCOCCUS'	= "#16E0BD",
                             'PNEUMOCOCCUS'	= "#44C199",
                             'TUBERCULOSIS'	= "#99e2b4",
                             'F TULARENSIS'	= "#90e0ef",
                             'LEISHMANIA'	= "#118ab2",
                             'MALARIA' = "#3f37c9",
                             'EBOV'	= "#d00000",
                             'HBV'	= "#e85d04",
                             'HBV, HAV'	= "#f48c06",
                             'HIV'	= "#a4133c",
                             'HPV'	= "#f27059",
                             'INFLUENZA'	= "#ffa69e",
                             'MEASLES'	= "#c65b7c",
                             'MMR'	= "#f9b5ac",
                             'SMALLPOX'	= "#ff8c42",
                             'VEEV'	= "#e01e37",
                             'VZV'	= "#ff9b85",
                             'YF'	= "#f38375"))

ggsave(pathogens_hist, file = "VAXSigDB_Pathogens_hist_1.png", width = 10, height = 5)

```

## Subsetting

```{r}
unique(VAX_GeneSets_annotated$STUDY_TYPE) 
#"CORRELATION"
#"VACCINE"
#"SUBSET"
#"CHALLENGE"

unique(VAX_GeneSets_annotated$STUDY_SUBTYPE)
# "ANTIBODY"				
# "VAC ONLY"				
# "BOOSTER"				
# "VAC VS CTRL"				
# "SIGNATURE"				
# "ADVERSE EVENT"			
# "COMPARISON"				
# "RESPONDER VS NON RESPONDER"				
# "AGE"				
# "RESPONDER"				
# "ADJUVANT"				
# "NON RESPONDER"				
# "ANTIMICROBIAL ACTIVITY"				
# "CELLS"				
# "CHALLENGE"				
# "TOP DEGS"				
# "PROTECTION"				
# "TRAINING SET"				
# "EXON ANALYSIS"				
# "DOSE"				
# "VAC VS OTHER"


# Subset de vacinas para as seguintes análises comparativas
VAX_GeneSets_Blood_PBMC_VAC = VAX_GeneSets_annotateds_Atate_RA %>%   filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("VACCINE"))

# Subset de vacinas com resultados de comparações entre vacinas, adjuvantes, idade e sexo
VAX_GeneSets_Blood_PBMC_CORR = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("CORRELATION"))

# Subset com resultados de correlações com resposta inata, celular e humoral
VAX_GeneSets_Blood_PBMC_SUBSETS = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("SUBSET"))

# Subset de vacinas com genes associados a eventos adversos
VAX_GeneSets_Blood_PBMC_CHALLENGE = VAX_GeneSets_annotated %>% 
  filter(SAMPLE_SOURCE %in% c("PBMC", "WHOLE BLOOD"), 
         STUDY_TYPE %in% c("CHALLENGE"))

VAX_GeneSets_Blood_PBMC_VAC.stats = VAX_GeneSets_Blood_PBMC_VAC %>% 
  group_by(VACCINE, PLATFORM, REGULATION, `TARGET_PATHOGEN_DISEASE`, MICROBE_TYPE) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count))

```

## Venn diagram

```{r}
############### VENN DIAGRAM
#Input
data = VAX_Genes_Annotated_RAW %>%
  as.data.frame() %>% 
  mutate(VACCINE_REG_TIME = paste0(VACCINE, "_", `DATE-TIME`, "_", REGULATION))

```

```{r}
# Determine overlapping genes between vaccines 
overlap_genes <- function(cond1, cond2, data) {
  genes_cond1 <- data$GENE[data$VACCINE_REG_TIME == cond1] #Trocar coluna
  genes_cond2 <- data$GENE[data$VACCINE_REG_TIME == cond2] #Trocar coluna
  genes_shared <- intersect(genes_cond1, genes_cond2)
  genes_notshared_cond1 <- setdiff(genes_cond1, genes_cond2)
  genes_notshared_cond2 <- setdiff(genes_cond2, genes_cond1)
  
  total_genes_cond1 <- length(genes_cond1)
  total_genes_cond2 <- length(genes_cond2)
  
  percetage_shared_cond1 <- length(genes_shared) / total_genes_cond1 * 100
  percentage_shared_cond2 <- length(genes_shared) / total_genes_cond2 * 100
  
  shared_genes <- data.frame(
    Cond1 = cond1,
    Cond2 = cond2,
    Shared = length(genes_shared),
    NotShared_cond1 = length(genes_notshared_cond1),
    NotShared_cond2 = length(genes_notshared_cond2),
    Total_Genes_Cond1 = total_genes_cond1,
    Total_Genes_Cond2 = total_genes_cond2,
    Genes_Names = paste(genes_shared, collapse = ","),
    Percentage_ared_d = perentage_shared_cond1,
  nd2 = 2
  )
  
  return(shared_genes)
}
# Obtenha uma lista de todas as vacinas únicas
unique_cond <- unique(data$VACCINE_REG_TIME)

# Inicialize um dataframe para armazenar os resultados
shared_genes_df <- data.frame()

# Calcular a sobreposição e porcentagem para cada par de vacinas
for (i in 1:(length(unique_cond) - 1)) {
  for (j in (i + 1):length(unique_cond)) {
    resultado_temp <- overlap_genes(unique_cond[i], unique_cond[j], data)
    shared_genes_df <- bind_rows(shared_genes_df, resultado_temp)
  }
}

# Função para realizar o teste exato de Fisher
fisher_exact_test <- function(shared, notshared1, notshared2) {
  cont_table <- matrix(c(shared, notshared1, notshared2, 0), nrow = 2)
  results_fisher <- fisher.test(cont_table)
  return(results_fisher$p.value)
}

# Aplicar a função a cada linha da tabela de resultados
shared_genes_df$value- mapply(fisher_exact_test, 
                                    saed_genes_df$Shared, 
                                    shared_genes_df$NotShared_cond1, 
                                    shared_genes_df$NotShared_cond2)


# Calcular qvalue (BH) e -log(FDR)
shared_genes_df <- shared_genes_df %>%
  mutate(qvalue = qvalue(pvalue)$qvalues)

#Duplicar e trocar colunas (Vacina 1 e Vacina 2)
shared_genes_df2 = shared_genes_df
shared_genes_df2[, c("Cond1", "Cond2")] <- shared_genes_df2[, c("Cond2", "Cond1")]

#Unir datasets com os dados espelhados
shared_genes_df_mirror = rbind(shared_genes_df, shared_genes_df2)

#Converter NA, NaNe inf em 0
shared_genes_df_mirror[is.na(shared_genes_df_mirror)] <- 0
shared_genes_df_mirror<- replace(shared_genes_df_mirror, shared_genes_df_mirror == "Inf", 0)

#Arredondar porcentagens
shared_genes_df_mirror = shared_genes_df_mirror %>%
  mutate(Percentage_Shared_n, o(erceage_Shared_Cond1, 2),
         Percentage_Shared_Cond2 = round(Percentage_Shared_Cond2, 2))

#Salvar resultados
write.csv(shared_genes_df_mirror, file = "AigD_sharedenes.csv") #Alterar

```

##Heatmap

### VAC ONLY

#### TOTAL SHARED

```{r}
VaxDB_sharedgenes = shared_genes_df_mirror
filename = "VAXSigDB_sharedgenes_VAC_ONLY_DOWN_DOWN" 

ann_data = data %>% 
  clean_names() %>% 
  select(vaccine_reg_time, microbe_type, 
         pathogen = target_pathogen_disease, 
         platform, 
         vaccine, 
         age_category, 
         date_time:time, 
         study_type,
         study_subtype) %>% 
  filter(age_category == "ADULT",
         study_subtype == "VAC ONLY") %>% 
  select(!c(age_category, study_type, study_subtype)) %>% 
  distinct()


matrix =  VAXSigDB_sharedgenes %>% 
  select(Cond1, Cond2, Shared) %>% 
  filter(grepl("_DOWN", Cond1) & grepl("_DOWN", Cond2)) %>% 
  pivot_wider(names_from = "Cond2", 
              values_from = oue,
              values_fn = mean) %>% 
 oumn_to_rownames(var="Cond1") %>% 
  as.matrix() %>% 
  round(0)

dim(matrix)

ann_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "vaccine_reg_time") %>% 
  rename(vaccine_reg_time = '.') %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = T) %>% 
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% 
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames(var= "vaccine_reg_time") %>% 
  mutate_all(as.factor) %>% 
  mutate(
    time = if_else(time == "ANY", "0", time),
    time = as.numeric(time),
    day_total = round(if_else(date == "H", time / 24, time), 0),
    week = if_else(date == "M", time * 4, time),
    week = day_total/7,
    week = round(week, 0),
    month = round(week/4),
    day_month = case_when(
      day_total >= 30 & day_total <= 60 ~ day_total / 2,
      day_total > 60 & day_total <= 90 ~ day_total / 3,
      TRUE ~ day_total),
    day_month = round(day_month, 0),
    month = as.factor(month)) %>% 
  distinct() %>% 
  select(-vaccine, -time, -day_total, -date_time, -date) %>% 
  relocate(week, .before = day_month) %>% 
  filter(microbe_type != "NA")

matrix_rowsordered = matrix %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F, all.y = F) %>% 
  arrange(vaccine_reg_time) %>% 
  select(!microbe_type:time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_rows_cols_ordered = matrix_rowsordered %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F) %>% 
  select(!microbe_type:time) %>% 
  rename_all(~sub("_DOWN$", "", .)) %>% # Retirar up or down
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% # Retirar up or down
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  as.matrix()

dim(matrix_rows_cols_ordered)
dim(ann_heatmap)


colfun = coloRamp(c(, 0), c("white", "#10BD"))

#Criar heatmap annotation
col_ha = HeatmapAnnotation(df = ann_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left")
row_ha = rowAnnotation(df = ann_heatmap, col = ann_vaxsig_colors)


#TOTAL GENES (with values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=50, height=40,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_hetmp_leend = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                        grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 6))}, #valor das células
                        heatmap_legend_aa = lt(diretion = hoint"),
                        name = "Total genes", #Legend
                        o = col_fn, color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = , fontface = ""),
                        column_names_rot = ,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        #row_names_gp = gpar(fontsize = ),
                        #row_split = , #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 4, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(30, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()


#TOTAL GENES (no values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "NO_VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=50, height=40,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(30, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()
```

#### IDENTITY COND 1

```{r}
VAXSigDB_sharedgenes = shared_genes_df_mirror
filename = "VAXSigDB_sharedgenes_DOWN_DOWN_IDENTITY_COND1"

ann_data = data %>% 
  clean_names() %>% 
  select(vaccine_reg_time, microbe_type, 
         pathogen = target_pathogen_disease, 
         platform, 
         vaccine, 
         age_category, 
         date_time:time, 
         study_type,
         study_subtype) %>% 
  filter(age_category == "ADULT",
         study_subtype == "VAC ONLY") %>% 
  select(!c(age_category, study_type, study_subtype)) %>% 
  distinct()


matrix =  VAXSigDB_sharedgenes %>% 
  select(Cond1, Cond2, Percentage_Shared_Cond1) %>% 
  filter(grepl("_DOWN", Cond1) & grepl("_DOWN", Cond2)) %>% 
  pivot_wider(names_from = "Cond2", 
              values_from = "Percentage_Shared_Cond1",
              values_fn = mean) %>% 
  column_to_rownames(var="") %>% 
  as.matrix() %>% 
  round(0)

dim(matrix)

ann_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "vaccine_reg_time") %>% 
  rename(vaccine_reg_time = '.') %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = T) %>% 
  mutate(vaccine_reg_time = sub("_UP$", "", vaccine_reg_time)) %>% 
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames(var= "vaccine_reg_time") %>% 
  mutate_all(as.factor) %>% 
  mutate(
    time = if_else(time == "ANY", "0", time),
    time = as.numeric(time),
    day_total = round(if_else(date == "H", time / 24, time), 0),
    week = if_else(date == "M", time * 4, time),
    week = day_total/7,
    week = round(week, 0),
    month = round(week/4),
    day_month = case_when(
      day_total >= 30 & day_total <= 60 ~ day_total / 2,
      day_total > 60 & day_total <= 90 ~ day_total / 3,
      TRUE ~ day_total),
    day_month = round(day_month, 0),
    month = as.factor(month)) %>% 
  distinct() %>% 
  select(-vaccine, -time, -day_total, -date_time, -date) %>% 
  relocate(week, .before = day_month) %>% 
  filter(microbe_type != "NA")

matrix_rowsordered = matrix %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F, all.y = F) %>% 
  arrange(vaccine_reg_time) %>% 
  select(!microbe_type:time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_rows_cols_ordered = matrix_rowsordered %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F) %>% 
  select(!microbe_type:time) %>% 
  rename_all(~sub("_DOWN$", "", .)) %>% # Retirar up or down
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% # Retirar up or down
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  as.matrix()

dim(matrix_rows_cols_ordered)
dim(ann_heatmap)


col_fun <- colorRamp2(c(0, 100), c("white", "#16E0BD"))

#Criar heatmap annotation
col_ha = HeatmapAnnotation(df = ann_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left")
row_ha = rowAnnotation(df = ann_heatmap, col = ann_vaxsig_colors)


#TOTAL GENES (with values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=50, height=40,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                        grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 6))}, #valor das células
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 4, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 4, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(30, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()


#TOTAL GENES (no values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "NO_VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=50, height=40,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(30, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()
```

#### IDENTITY COND 2

```{r}
VAXSigDB_sharedgenes = shared_genes_df_mirror
filename = "VAXSigDB_sharedgenes_DOWN_DOWN_IDENTITY_COND2"

ann_data = data %>% 
  clean_names() %>% 
  select(vaccine_reg_time, microbe_type, 
         pathogen = target_pathogen_disease, 
         platform, 
         vaccine, 
         age_category, 
         date_time:time, 
         study_type,
         study_subtype) %>% 
  filter(age_category == "ADULT",
         study_subtype == "VAC ONLY") %>% 
  select(!c(age_category, study_type, study_subtype)) %>% 
  distinct()


matrix =  VAXSigDB_sharedgenes %>% 
  select(Cond1, Cond2, Percentage_Shared_Cond2) %>% 
  filter(grepl("_DOWN", Cond1) & grepl("_DOWN", Cond2)) %>% 
  pivot_wider(names_from = "Cond1", 
              values_from = "Percentage_Shared_Cond2",
              values_fn = mean) %>% 
  column_to_rownames(var="Cond2") %>% 
  as.matrix() %>% 
  round(0)

dim(matrix)

ann_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "vaccine_reg_time") %>% 
  rename(vaccine_reg_time = '.') %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = T) %>% 
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% 
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames(var= "vaccine_reg_time") %>% 
  mutate_all(as.factor) %>% 
  mutate(
    time = if_else(time == "ANY", "0", time),
    time = as.numeric(time),
    day_total = round(if_else(date == "H", time / 24, time), 0),
    week = if_else(date == "M", time * 4, time),
    week = day_total/7,
    week = round(week, 0),
    month = round(week/4),
    day_month = case_when(
      day_total >= 30 & day_total <= 60 ~ day_total / 2,
      day_total > 60 & day_total <= 90 ~ day_total / 3,
      TRUE ~ day_total),
    day_month = round(day_month, 0),
    month = as.factor(month)) %>% 
  distinct() %>% 
  select(-vaccine, -time, -day_total, -date_time, -date) %>% 
  relocate(week, .before = day_month) %>% 
  filter(microbe_type != "NA")

matrix_rowsordered = matrix %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F, all.y = F) %>% 
  arrange(vaccine_reg_time) %>% 
  select(!microbe_type:time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_rows_cols_ordered = matrix_rowsordered %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F) %>% 
  select(!microbe_type:time) %>% 
  rename_all(~sub("_DOWN$", "", .)) %>% # Retirar up or down
  mutate(vaccine_reg_time = sub("_UP$", "", vaccine_reg_time)) %>% # Retirar up or down
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  as.matrix()

dim(matrix_rows_cols_ordered)
dim(ann_heatmap)




col_fun <- colorRamp2(c(0, 100), c("white", "#16E0BD"))

#Criar heatmap annotation
col_ha = HeatmapAnnotation(df = ann_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left")
row_ha = rowAnnotation(df = ann_heatmap, col = ann_vaxsig_colors)


#TOTAL GENES (with values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=50, height=40,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                        grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 6))}, #valor das células
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "IDENTITY", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 4, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 4, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(30, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()


#TOTAL GENES (no values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "NO_VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=50, height=40,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "IDENTITY", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(30, "cm"), 
                        height = unit(30, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()
```

### CORRELATION ANTIBODIES

```{r}
VAXSigDB_sharedgenes = shared_genes_df_mirror
filename = "VAXSigDB_sharedgenes_UP_UP_Antibodies"

ann_data = data %>% 
  clean_names() %>% 
  select(vaccine_reg_time, microbe_type, 
         pathogen = target_pathogen_disease, 
         platform, 
         vaccine, 
         age_category, 
         date_time:time, 
         study_type,
         study_subtype) %>% 
  distinct() %>% 
  filter(age_category == "ADULT",
         study_subtype == "ANTIBODY") %>% 
  select(!c(age_category, study_type, study_subtype))

matrix =  VAXSigDB_sharedgenes %>% 
  select(Cond1, Cond2, Shared) %>% 
  filter(grepl("_UP", Cond1) & grepl("_UP", Cond2)) %>% 
  pivot_wider(names_from = "Cond2", 
              values_from = "Shared",
              values_fn = mean) %>% 
  column_to_rownames(var="Cond1") %>% 
  as.matrix() %>% 
  round(0)

dim(matrix)

ann_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "vaccine_reg_time") %>% 
  rename(vaccine_reg_time = '.') %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = T) %>% 
  mutate(vaccine_reg_time = sub("_UP$", "", vaccine_reg_time)) %>% 
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames(var= "vaccine_reg_time") %>% 
  mutate_all(as.factor) %>% 
  mutate(
    time = if_else(time == "ANY", "0", time),
    time = as.numeric(time),
    day_total = round(if_else(date == "H", time / 24, time), 0),
    week = if_else(date == "M", time * 4, time),
    week = day_total/7,
    week = round(week, 0),
    month = round(week/4),
    day_month = case_when(
      day_total >= 30 & day_total <= 60 ~ day_total / 2,
      day_total > 60 & day_total <= 90 ~ day_total / 3,
      TRUE ~ day_total),
    day_month = round(day_month, 0),
    month = as.factor(month)) %>% 
  distinct() %>% 
  select(-vaccine, -time, -day_total, -date_time, -date) %>% 
  relocate(week, .before = day_month) %>% 
  filter(microbe_type != "NA")

matrix_rowsordered = matrix %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F, all.y = F) %>% 
  arrange(vaccine_reg_time) %>% 
  select(!microbe_type:time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_rows_cols_ordered = matrix_rowsordered %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F) %>% 
  select(!microbe_type:time) %>% 
  rename_all(~sub("_UP$", "", .)) %>% # Retirar up or down
  mutate(vaccine_reg_time = sub("_UP$", "", vaccine_reg_time)) %>% # Retirar up or down
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  as.matrix()

dim(matrix_rows_cols_ordered)
dim(ann_heatmap)



col_fun <- colorRamp2(c(0, 100), c("white", "#16E0BD"))

#Criar heatmap annotation
col_ha = HeatmapAnnotation(df = ann_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left")
row_ha = rowAnnotation(df = ann_heatmap, col = ann_vaxsig_colors)


#TOTAL GENES (with values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=30, height=30,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                        grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 6))}, #valor das células
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 4, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 4, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(10, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()


#TOTAL GENES (no values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "NO_VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=30, height=30,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(10, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()
```

#### IDENTITY COND 1

```{r}
VAXSigDB_sharedgenes = shared_genes_df_mirror
filename = "VAXSigDB_sharedgenes_DOWN_DOWN_Antibodies_Cond1"

ann_data = data %>% 
  clean_names() %>% 
  select(vaccine_reg_time, microbe_type, 
         pathogen = target_pathogen_disease, 
         platform, 
         vaccine, 
         age_category, 
         date_time:time, 
         study_type,
         study_subtype) %>% 
  distinct() %>% 
  filter(age_category == "ADULT",
         study_subtype == "ANTIBODY") %>% 
  select(!c(age_category, study_type, study_subtype))

matrix =  VAXSigDB_sharedgenes %>% 
  select(Cond1, Cond2, Percentage_Shared_Cond1) %>% 
  filter(grepl("_DOWN", Cond1) & grepl("_DOWN", Cond2)) %>% 
  pivot_wider(names_from = "Cond2", 
              values_from = "Percentage_Shared_Cond1",
              values_fn = mean) %>% 
  column_to_rownames(var="Cond1") %>% 
  as.matrix() %>% 
  round(0)

dim(matrix)

ann_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "vaccine_reg_time") %>% 
  rename(vaccine_reg_time = '.') %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = T) %>% 
  mutate(vaccine_reg_time = sub("_UP$", "", vaccine_reg_time)) %>% 
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames(var= "vaccine_reg_time") %>% 
  mutate_all(as.factor) %>% 
  mutate(
    time = if_else(time == "ANY", "0", time),
    time = as.numeric(time),
    day_total = round(if_else(date == "H", time / 24, time), 0),
    week = if_else(date == "M", time * 4, time),
    week = day_total/7,
    week = round(week, 0),
    month = round(week/4),
    day_month = case_when(
      day_total >= 30 & day_total <= 60 ~ day_total / 2,
      day_total > 60 & day_total <= 90 ~ day_total / 3,
      TRUE ~ day_total),
    day_month = round(day_month, 0),
    month = as.factor(month)) %>% 
  distinct() %>% 
  select(-vaccine, -time, -day_total, -date_time, -date) %>% 
  relocate(week, .before = day_month) %>% 
  filter(microbe_type != "NA")

matrix_rowsordered = matrix %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F, all.y = F) %>% 
  arrange(vaccine_reg_time) %>% 
  select(!microbe_type:time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_rows_cols_ordered = matrix_rowsordered %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F) %>% 
  select(!microbe_type:time) %>% 
  rename_all(~sub("_DOWN$", "", .)) %>% # Retirar up or down
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% # Retirar up or down
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  as.matrix()

dim(matrix_rows_cols_ordered)
dim(ann_heatmap)

#Criar heatmap annotation
col_ha = HeatmapAnnotation(df = ann_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left")
row_ha = rowAnnotation(df = ann_heatmap, col = ann_vaxsig_colors)


#TOTAL GENES (with values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=30, height=30,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                        grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 6))}, #valor das células
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 4, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 4, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(10, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()


#TOTAL GENES (no values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "NO_VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=30, height=30,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(10, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()
```

#### IDENTITY COND 1

```{r}
VAXSigDB_sharedgenes = shared_genes_df_mirror
filename = "VAXSigDB_sharedgenes_DOWN_DOWN_Antibodies_COND2"

ann_data = data %>% 
  clean_names() %>% 
  select(vaccine_reg_time, microbe_type, 
         pathogen = target_pathogen_disease, 
         platform, 
         vaccine, 
         age_category, 
         date_time:time, 
         study_type,
         study_subtype) %>% 
  distinct() %>% 
  filter(age_category == "ADULT",
         study_subtype == "ANTIBODY") %>% 
  select(!c(age_category, study_type, study_subtype))

matrix =  VAXSigDB_sharedgenes %>% 
  select(Cond1, Cond2, Percentage_Shared_Cond2) %>% 
  filter(grepl("_DOWN", Cond1) & grepl("_DOWN", Cond2)) %>% 
  pivot_wider(names_from = "Cond1", 
              values_from = "Percentage_Shared_Cond2",
              values_fn = mean) %>% 
  column_to_rownames(var="Cond2") %>% 
  as.matrix() %>% 
  round(0)

dim(matrix)

ann_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "vaccine_reg_time") %>% 
  rename(vaccine_reg_time = '.') %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = T) %>% 
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% 
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames(var= "vaccine_reg_time") %>% 
  mutate_all(as.factor) %>% 
  mutate(
    time = if_else(time == "ANY", "0", time),
    time = as.numeric(time),
    day_total = round(if_else(date == "H", time / 24, time), 0),
    week = if_else(date == "M", time * 4, time),
    week = day_total/7,
    week = round(week, 0),
    month = round(week/4),
    day_month = case_when(
      day_total >= 30 & day_total <= 60 ~ day_total / 2,
      day_total > 60 & day_total <= 90 ~ day_total / 3,
      TRUE ~ day_total),
    day_month = round(day_month, 0),
    month = as.factor(month)) %>% 
  distinct() %>% 
  select(-vaccine, -time, -day_total, -date_time, -date) %>% 
  relocate(week, .before = day_month) %>% 
  filter(microbe_type != "NA")

matrix_rowsordered = matrix %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F, all.y = F) %>% 
  arrange(vaccine_reg_time) %>% 
  select(!microbe_type:time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  mutate_if(is.character, as.numeric) %>% 
  as.matrix()

matrix_rows_cols_ordered = matrix_rowsordered %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "vaccine_reg_time") %>% 
  merge(ann_data, by = "vaccine_reg_time", all.x = F) %>% 
  select(!microbe_type:time) %>% 
  rename_all(~sub("_DOWN$", "", .)) %>% # Retirar up or down
  mutate(vaccine_reg_time = sub("_DOWN$", "", vaccine_reg_time)) %>% # Retirar up or down
  arrange(vaccine_reg_time) %>% 
  distinct() %>% 
  column_to_rownames("vaccine_reg_time") %>% 
  as.matrix()

dim(matrix_rows_cols_ordered)
dim(ann_heatmap)

#Criar heatmap annotation
col_ha = HeatmapAnnotation(df = ann_heatmap, 
                       col = ann_vaxsig_colors, 
                       annotation_name_side = "left")
row_ha = rowAnnotation(df = ann_heatmap, col = ann_vaxsig_colors)


#TOTAL GENES (with values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=30, height=30,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                        grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = 6))}, #valor das células
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 4, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 4, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(10, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()


#TOTAL GENES (no values)
mat = matrix_rows_cols_ordered 

fileimageheatmap_ungrouped= paste0(filename, sep ="_", "NO_VALUES_Complexheatmap.png")

png(file = fileimageheatmap_ungrouped, width=30, height=30,units="cm",res=900)

heatmap_plot_all = Heatmap(mat,
                        top_annotation = col_ha,
                        left_annotation = row_ha,
                        na_col = "black",
                        show_row_names = TRUE,
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        name = "Total genes", #Legend
                        col = col_fun, #color
                        column_title = fileimageheatmap_ungrouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = gpar(fontsize = 8),
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = gpar(fontsize = 10),
                        #row_split = 2, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        #column_split = 2, #Split group clusters
                        column_gap = unit(8, "mm"),
                        show_column_dend = FALSE,
                        show_row_dend = FALSE,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = unit(10, "cm"), 
                        height = unit(10, "cm")
)

draw(heatmap_plot_all, annotation_legend_side = "left", heatmap_legend_side = "left")

dev.off()
```

## ORA VAXGO com ImmuneIMMUNE GO

*Qual a relação entre os genes de cada dataset?*

```{r}
#Input
VAX_Genes_Annotated_RAW = VAX_Genes_Annotated_RAW %>% 
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")"))

degs_all_updown_vax_immunego = VAX_Genes_Annotated_RAW %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene) %>% 
  inner_join(ImmuneGO_Annotated_Genes_8_1_24 %>% 
               select(genes), by = "genes") %>% 
  distinct()

degs_all_updown_covid = degs_updown_p_05_vac_infected %>% 
  as.data.frame() %>% 
  select(condition:direction_wide) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(ImmuneGO_genes) %>% 
  distinct() %>% 
  select(condition, genes)

degs_all_updown_covid_other = bind_rows(degs_all_updown_vax_immunego, degs_all_updown_covid) %>% 
  select(condition, genes) %>% 
  distinct()

Immune_GO_T2G = ImmuneGO_Annotated_Genes%>% 
  filter(go_term == "Manual",
         !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE", "ADAPTIVE IMMUNE SYSTEM", "INNATE IMMUNE SYSTEM")) %>% 
  select(process, genes)
```

```{r}
# Função para realizar a análise GSEA para uma condição específica
perform_ORA <- function(df, Immune_GO_T2G) {
  resultados <- list()
  
  # Obter condições únicas na coluna "condition"
  condicoes <- df$condition %>% 
    unique() %>% 
    as.character()
  
  for (condicao in condicoes) {
    # Selecionar DEGs para a condição atual
    degs_condicao <- df %>% 
      filter(condition == condicao) %>%
      select(genes) %>%
      distinct()

    # Preparar gene list
    gene_list_ora <- degs_condicao$genes

    ############ IMMUNE GO
    immune_GO_ORA <- tryCatch({
      enricher(gene_list_ora, 
               TERM2GENE = Immune_GO_T2G, 
               minGSSize = 1,
               maxGSSize = 1000,
               pvalueCutoff = 0.25,
               pAdjustMethod = "BH") %>% 
        as.data.frame() %>% 
        arrange(qvalue) %>% 
        mutate(condition = condicao,
               ora_enrichment = "ImmuneGO")
    }, error = function(e) {
      return(NULL)  # Retorna NULL caso ocorra o erro
    })

    if (!is.null(immune_GO_ORA)) {
      resultados[[paste(condicao, "ImmuneGO", sep = "_")]] <- immune_GO_ORA
    }
  }

  # Combinar todos os resultados em um único dataframe
  resultado_final <- bind_rows(resultados)

  return(resultado_final)
}

# Exemplo de uso
df_resultados <- perform_ORA(degs_all_updown_covid_other, Immune_GO_T2G)

# Visualizar os resultados
print(df_resultados)

#Anotar
VAX_immune_GO_ORA = df_resultados %>% 
  clean_names() %>% 
  select(process = id, gene_ratio:ora_enrichment) %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  distinct() %>% 
  select(process:ora_enrichment) %>% 
  distinct() %>% 
  mutate(log_q = -log10(qvalue))

write.csv(VAX_immune_GO_ORA, file = "VAX_immune_GO_ORA.csv")

view(VAX_immune_GO_ORA)
```

### Heatmap

```{r}
####### INPUT
data_2 = VAX_immune_GO_ORA
filename_2 = "VAX_immune_"


######## Matrix
matrix = data_2 %>% 
  filter(qvalue <= 0.25) %>% 
  select(condition, process, log_q) %>% #Percentage_Shared_Cond1
  pivot_wider(names_from = "condition", 
              values_from = "log_q",  #Percentage_Shared_Cond1
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames(var="process") %>% 
  as.matrix() %>% 
  round(2)

######## Annotations
ann_vaccines_reference = data_2 %>% 
  inner_join(VAX_Genes_Annotated_RAW, by = "condition") %>% 
  select(condition, platform, target_pathogen_disease, microbe_type, date, time) %>% 
  distinct()

#Columns
ann_cols_heatmap = 

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap, by = "condition") %>% 
  select(!c(platform:day_month)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame()%>%  
  mutate_if(is.character, as.numeric) %>%
  replace(is.na(.), 0) %>% 
  as.matrix() 

ann_cols_heatmap = ann_cols_heatmap %>% 
  column_to_rownames("condition")


#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
```

```{r}
################## Colors

#VAX SIG DB
ann_vaxsig_colors = list(
  platform = c('IN'= "#e5e5e5", 
               'VV' = "#72efdd",
               'RNA' = "#56cfe1",
               "VLP" = "#D7B0EE",
               "LA" =  "#5e60ce",
               "CONJ" = "#015BA0", 
               'SU' = "#b5179e"),
  target_pathogen_disease = c('MENINGOCOCCUS'	= "#16E0BD",
                             'PNEUMOCOCCUS'	= "#44C199",
                             'TUBERCULOSIS'	= "#99e2b4",
                             'F TULARENSIS'	= "#90e0ef",
                             'LEISHMANIA'	= "#118ab2",
                             'MALARIA' = "#3f37c9",
                             'EBOV'	= "#d00000",
                             'HBV'	= "#e85d04",
                             'HBV, HAV'	= "#f48c06",
                             'HIV'	= "#a4133c",
                             'HPV'	= "#f27059",
                             'INFLUENZA'	= "#ffa69e",
                             'MEASLES'	= "#c65b7c",
                             'MMR'	= "#f9b5ac",
                             'SMALLPOX'	= "#ff8c42",
                             'VEEV'	= "#e01e37",
                             'VZV'	= "#ff9b85",
                             'YF'	= "#f38375"),
  microbe_type = c("VIRUS" = "#d00000",
                   'BACTERIUM' = "#16E0BD",
                   'PARASITE' = "#118ab2"),
  week = c("0" = "#ECF8FA",
           "1" = "#caf0f8",
           "2" = "#6CD5EA",
           "3" = "#0087BF",
           "4" = "#015BA0", 
           ">4" = "#03045e"),
  month = c("1" = "#caf0f8",
            "0" = "#6CD5EA",
           "2" = "#015BA0")
  )

```

```{r}
################# Plotar

#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")


# Values colors
col_fun <- colorRamp2(c(0, 0.6, 1, 1.3, 2), c("white", "#caf0f8", "#6CD5EA", "#0087BF", "#03045e"))

file = "VAC_ONLY"
mat = matrix_data
width_image = 40
height_image = 20
width = unit(20, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 8)
row_names_gp = gpar(fontsize = 8)

file = paste0("VAXSig_ORA_ImmuneGO_", file)



###### CLUSTERIZED

# NO value labels

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, width = width_image, height = height_image, units="cm", res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 0),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        column_split = NULL, #Split column clusters 
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")
dev.off()


# WITH value labels

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap_VALUES.png")

png(file = fileimageheatmap_grouped, width = width_image, height = height_image, units="cm", res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        cell_fun = function(j, i, x, y, width, height, fill) {
                                            if(mat[i, j] > 1)
                                            grid.text(sprintf("%.1f", mat[i, j]), 
                                                      x, y, 
                                                      gp = gpar(fontsize = 5))},
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 0),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        column_split = NULL, #Split column clusters 
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")
dev.off()
```

```{r}
# WITH values
fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap_VALUES.png")

png(file = fileimageheatmap_grouped, width=width_image, height=height_image,units="cm",res=800)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        row_title = "",
                        show_column_names = TRUE,
                        cell_fun = function(j, i, x, y, width, height, fill) {
                                            if(matrix_data_cols_rows_ordered[i, j] > 1)
                                            grid.text(sprintf("%.1f", matrix_data_cols_rows_ordered[i, j]), 
                                                      x, y, 
                                                      gp = gpar(fontsize = 5))},
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 8, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 0),
                        cluster_rows = FALSE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        column_split = NULL, #Split column clusters 
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = FALSE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")
dev.off()

```

# COVID-19 vaccines comparison

### VENN DIAGRAM

```{r}
# Input files ------

immunego = ImmuneGO_Annotated_Genes_28_2_24 # ImmuneGO Annotation
degs_updown_p_05_vac_infected = all_degs_p_05_vac_infected_19_12_23 # DEGs
ann_vaccines_covid_other = ann_vaccines_vaxsig_covid #Conditions annotation
VAX_Genes_Annotated_RAW_2 = VAX_Genes_Annotated_RAW # VAX MSigDB DEGs 


# Processing
VAX_Genes_Annotated_RAW_3 = VAX_Genes_Annotated_RAW_2 %>% 
  clean_names() %>% 
  filter(study_subtype == "VAC ONLY",
         sample_source == "PBMC") %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, everything())

degs_all_updown_vax = VAX_Genes_Annotated_RAW_3 %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene) %>% 
  distinct()

degs_all_updown_covid= degs_updown_p_05_vac_infected %>% 
  as.data.frame() %>% 
  select(condition:direction) %>% 
  filter(direction %in% c("UP", "DOWN")) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  distinct() %>% 
  select(condition, genes)

degs_all_updown_covid_other = bind_rows(degs_all_updown_vax, degs_all_updown_covid) %>% 
  distinct()

degs_all_updown_covid_other = degs_all_updown_covid_vax_other

degs_all_updown_covid_other_immune = degs_all_updown_covid_other %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct()

degs_all_updown_covid_other_nonimmune = degs_all_updown_covid_other %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct()

write.csv(degs_all_updown_covid_other, file = "degs_all_updown_covid_vax_other.csv")
write.csv(degs_all_updown_covid_other_immune, file = "degs_all_updown_covid_vax_other_immune.csv")
write.csv(degs_all_updown_covid_other_nonimmune, file = "degs_all_updown_covid_vax_other_nonimmune.csv")
```

```{r}
#Input
data = degs_all_updown_covid_other_nonimmune %>% 
  rename(geneset = condition) %>% 
  select(geneset, genes)

filename = "degs_all_updown_covid_other_nonimmune"
  
```

```{r}
# Função para calcular a sobreposição entre pares de vacinas e a porcentagem de genes compartilhados
overlap_genes <- function(cond1, cond2, data) {
  genes_cond1 <- data$genes[data$geneset == cond1] #Trocar coluna
  genes_cond2 <- data$genes[data$geneset == cond2] #Trocar coluna
  genes_shared <- intersect(genes_cond1, genes_cond2)
  genes_notshared_cond1 <- setdiff(genes_cond1, genes_cond2)
  genes_notshared_cond2 <- setdiff(genes_cond2, genes_cond1)
  
  total_genes_cond1 <- length(genes_cond1)
  total_genes_cond2 <- length(genes_cond2)
  
  percentage_shared_cond1 <- length(genes_shared) / total_genes_cond1 * 100
  percentage_shared_cond2 <- length(genes_shared) / total_genes_cond2 * 100
  
  shared_genes <- data.frame(
    Cond1 = cond1,
    Cond2 = cond2,
    Shared = length(genes_shared),
    NotShared_cond1 = length(genes_notshared_cond1),
    NotShared_cond2 = length(genes_notshared_cond2),
    Total_Genes_Cond1 = total_genes_cond1,
    Total_Genes_Cond2 = total_genes_cond2,
    Genes_Names = paste(genes_shared, collapse = ","),
    Percentage_Shared_Cond1 = percentage_shared_cond1,
    Percentage_Shared_Cond2 = percentage_shared_cond2
  )
  
  return(shared_genes)
}
# Obtenha uma lista de todas as vacinas únicas
unique_cond <- unique(data$geneset)
shared_genes_df <- data.frame()

for (i in 1:(length(unique_cond) - 1)) {
  for (j in (i + 1):length(unique_cond)) {
    resultado_temp <- overlap_genes(unique_cond[i], unique_cond[j], data)
    shared_genes_df <- bind_rows(shared_genes_df, resultado_temp)
  }
}

# Fisher's exact test and Benjamini-Hochberg multiple tests
fisher_exact_test <- function(shared, notshared1, notshared2) {
  cont_table <- matrix(c(shared, notshared1, notshared2, 0), nrow = 2)
  results_fisher <- fisher.test(cont_table)
  return(results_fisher$p.value)
}

shared_genes_df$pvalue <- mapply(fisher_exact_test, 
                                    shared_genes_df$Shared, 
                                    shared_genes_df$NotShared_cond1, 
                                    shared_genes_df$NotShared_cond2)

shared_genes_df <- shared_genes_df %>%
  filter(pvalue <= 1) %>% 
  mutate(qvalue = qvalue(pvalue)$pvalue)

#Duplicar e trocar colunas (Vacina 1 e Vacina 2)
shared_genes_df2 = shared_genes_df
shared_genes_df2[, c("Cond1", "Cond2")] <- shared_genes_df2[, c("Cond2", "Cond1")]
shared_genes_df_mirror = rbind(shared_genes_df, shared_genes_df2)

shared_genes_df_mirror[is.na(shared_genes_df_mirror)] <- 0
shared_genes_df_mirror<- replace(shared_genes_df_mirror, shared_genes_df_mirror == "Inf", 0)

shared_genes_df_mirror = shared_genes_df_mirror %>%
  mutate(Percentage_Shared_Cond1 = round(Percentage_Shared_Cond1, 2),
         Percentage_Shared_Cond2 = round(Percentage_Shared_Cond2, 2))

#Salvar resultados
write.csv(shared_genes_df_mirror, file = paste0(filename, "_shared.csv"))

```

Other comparisons

```{r}
############# VACCINE
#Use "vax_degs_up_VAXSigDB_sharedgenes_ann.csv" for comparing UP degs with UP degs from other conditions

#VAC ONLY
shared_genes_ann_vac = shared_genes_df_mirror_ann %>%
  select(vac_condition, vaccine_condition, vac_ref, Cond2:sample_source, pmid, gene_symbols:participants) %>% 
  filter(study_type == "VACCINE", 
         sample_source == "PBMC",
         !(vaccine_condition %in% c("BBIBP", "ZF2001"))) 

# vac_only_up = shared_genes_ann_vac %>%
#   filter(study_subtype == "VAC ONLY",
#          regulation == 'UP')

vac_only_down = shared_genes_ann_vac %>%
  filter(study_subtype == "VAC ONLY",
         regulation == 'DOWN')

#RESPONDER

vac_responder_up = shared_genes_ann_vac %>%
  filter(study_subtype == "RESPONDER VS NON RESPONDER",
         regulation == 'UP')

vac_responder_down = shared_genes_ann_vac %>% 
  filter(study_subtype == "RESPONDER VS NON RESPONDER",
         regulation == 'DOWN')

# CELLULAR RESPONSE

vac_responder_cell_up = shared_genes_ann_vac %>% 
  filter(study_subtype == "CELL",
         regulation == 'UP')

vac_responder_cell_down = shared_genes_ann_vac %>% 
  filter(study_subtype == "CELL",
         regulation == 'DOWN')

############# CORRELATION
shared_genes_ann_corr = shared_genes_df_mirror_ann %>% 
  select(vac_condition, vaccine_condition, vac_ref, Cond2:sample_source, pmid, gene_symbols:previous_vaccinationarticipants) %>% 
  filter(study_type == "CORRELATION", 
         sample_source == "PBMC",
         !(vaccine_condition %in% c("BBIBP", "ZF2001")))

# ADVERSE EVENT
corr_AE_up = shared_genes_ann_corr %>%
  filter(study_subtype == "ADVERSE EVENT",
         regulation == 'UP')

corr_AE_down = shared_genes_ann_corr %>%
  filter(study_subtype == "ADVERSE EVENT",
         regulation == 'DOWN')

# ANTIBODY
corr_antibody_up = shared_genes_ann_corr %>%
  filter(study_subtype == "ANTIBODY",
         regulation == 'UP')

corr_antibody_down = shared_genes_ann_corr %>% 
  filter(study_subtype == "ANTIBODY",
         regulation == 'POSITIVE')

corr_antibody_positive = shared_genes_ann_corr %>%
  filter(study_subtype == "ANTIBODY",
         regulation == 'NEGATIVE')

corr_antibody_negative = shared_genes_ann_corr %>% 
  filter(study_subtype == "ANTIBODY",
         regulation == 'NEGATIVE')


# CELL
corr_cell_up = shared_genes_ann_corr %>%
  filter(study_subtype == "CELL",
         regulation == 'UP')

corr_cell_down = shared_genes_ann_corr %>% 
  filter(study_subtype == "CELL",
         regulation == 'POSITIVE')

corr_cell_positive = shared_genes_ann_corr %>% 
  filter(study_subtype == "CELL",
         regulation == 'UP')

corr_cell_negative = shared_genes_ann_corr %>% 
  filter(study_subtype == "CELL",
         regulation == 'NEGATIVE')

```

Heatmap

```{r}
table = degs_all_updown_covid_other_immune_shared
filename = "ImmuneGO_Genes" 

# table = degs_all_updown_covid_other_nonimmune_shared
# filename = "NonImmune_Genes" 



# INPUT ------
data = table %>% 
  filter(qvalue <0.25) %>% 
  inner_join(ann_vaccines_covid_other %>% 
               select(Cond1 = condition, everything()), by = "Cond1") %>% 
  inner_join(ann_vaccines %>% 
               select(Cond2 = condition, everything()), by = "Cond2") %>% 
  clean_names() %>% 
  rename(vac_ref = cond1, vac_condition = cond2)

# Matrix ------
matrix = data %>%
  filter(qvalue <= 0.10) %>% 
  select(vac_condition, vac_ref, shared) %>% 
  pivot_wider(names_from = vac_condition, values_from = shared, values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames(var="vac_ref") %>%
  as.matrix() %>%
  round(0)

# Annotations -------
ann_vaccines_covid = ann_vaccines_covid_other %>% 
  filter(covid_other == "COVID")
ann_vaccines_other = ann_vaccines_covid_other %>% 
  filter(covid_other == "OTHER")

# Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "process") %>% 
  rename(vac_condition = '.') %>% 
  merge(ann_vaccines_covid, by.x = "vac_condition", by.y = "condition", all.y = F) %>% 
  select(vac_condition, type, vaccine, week) %>% #ordenar colunas para anotação
  distinct() %>% 
  column_to_rownames(var = "vac_condition") %>% 
  mutate_all(as.factor)

# Rows
ann_rows_heatmap = matrix %>%  
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  distinct() %>% 
  inner_join(ann_vaccines_other, by = "condition") %>% 
  mutate_all(as.factor) %>%
  arrange(condition) %>%
  distinct() %>% 
  column_to_rownames(var= "condition") %>% 
  select(vaccine:infection) %>% 
  select(microbe_type, type, week)

# Arrange cols and rows in matrix
matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>%
  rownames_to_column("condition") %>% 
  inner_join(ann_rows_heatmap %>% 
               rownames_to_column("condition") %>% 
               select(condition),
             by = "condition") %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  mutate_if(is.character, as.numeric) %>%
  replace(is.na(.), 0) %>% 
  as.matrix()


#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_rows_heatmap)
dim(ann_cols_heatmap)

```

Plot
```{r}

#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = rowAnnotation(df =  ann_rows_heatmap, 
                       col = ann_vaxsig_colors)

# Values colors
col_fun <- colorRamp2(c(0, max(matrix_data)), c("white", "#ed6a5a"))


mat = matrix_data
width_image = 40
height_image = 30
width = unit(20, "cm")
height = unit(15, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
file = paste0("VAXSig_", filename_2)

fileimageheatmap_grouped = paste0(filename, sep ="_", "Complexheatmap_ALL_CLUSTERED.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image,
    units="cm", res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(title = "Shared", direction = "vertical"),
                        col = col_fun, #color
                        cell_fun = function(j, i, x, y, width, height, fill) {
                                            if(mat[i, j] > 0)
                                            grid.text(sprintf("%.f", mat[i, j]), 
                                                      x, y, 
                                                      gp = gpar(fontsize = 8))},
                        row_title = "",
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 90,
                        column_names_gp = column_names_gp,
                        rect_gp = gpar(col = "gray90", lwd = 1),
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        column_split = NULL, #Split column clusters 
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        column_dend_reorder = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot,
     merge_legend = TRUE,
     annotation_legend_side = "right", 
     heatmap_legend_side = "right")
dev.off()

```

### Clustering all vs all

```{r}

# INPUT ------
matrix = shared_genes_df_mirror %>% 
  filter(qvalue <0.10) %>% 
  inner_join(ann_vaccines_covid_other %>% 
               select(Cond1 = condition, everything()), by = "Cond1") %>% 
  inner_join(ann_vaccines_covid_other %>% 
               select(Cond2 = condition, everything()), by = "Cond2") %>% 
  clean_names() %>% 
  rename(vac_ref = cond1, vac_condition = cond2) %>%
  filter(qvalue <= 0.10) %>% 
  select(vac_condition, vac_ref, shared) %>% 
  pivot_wider(names_from = vac_condition, values_from = shared, values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames(var="vac_ref") %>%
  as.matrix() %>%
  round(0)


#Hierarchical clustering | https://rpubs.com/TX-YXL/662586
library(dendextend)
library(ggdendro)


cluster = matrix %>% 
  dist() %>% 
  hclust(method = 'complete') %>% 
  as.dendrogram() -> dend

my_colors <- ann_vaccines_covid_other %>% 
 mutate(color = case_when(
    type == "VLP" ~ "#D7B0EE",
    type == "LA" ~ "#ffb703",
    type == "CONJ" ~ "#015BA0",
    type == "IN" ~ "#76c893",
    type == "VV" ~ "#5e60ce",
    type == "RNA" ~ "#56cfe1",
    type == "SU" ~ "#b5e48c",
    type == "I" ~ "#f72585",
    TRUE ~ NA_character_))

my_colors %>% select(condition, color) %>% 
  write_tsv("covid_others_colors.tsv")

png(paste0(filename, "_covid_other_allvsall_shared_dendrogram.png"), width = 800, height = 1000)
par(mar=c(5,5,1,12))
dend %>%
  set("labels_col", value = c("black"), k=10) %>%
  set("branches_k_color", value = c("black"), k = 10) %>%
  plot(horiz=TRUE, axes=TRUE)
dev.off()



```

### ORA COVID vs. VAXGO com ImmuneGO

*Qual a relação entre os genes de cada dataset?*

```{r}
#Input
degs_all_updown_covid = degs_updown_p_05_vac_infected %>% 
   as.data.frame() %>% 
   select(condition:direction) %>% 
   filter(direction %in% c("UP", "DOWN")) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
   distinct() %>% 
  select(condition, genes)

VAX_Genes_Annotated_RAW = VAX_Genes_Annotated_RAW %>% 
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")"))

ann_vaccines_covid_other 

degs_all_updown_vax_immunego = VAX_Genes_Annotated_RAW %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene) %>% 
  inner_join(ImmuneGO_Annotated_Genes_8_1_24 %>% 
               select(genes), by = "genes") %>% 
  distinct()

degs_all_updown_covid_other = bind_rows(degs_all_updown_vax_immunego, degs_all_updown_covid) %>% 
  distinct()

Immune_GO_T2G = ImmuneGO_Annotated_Genes %>% 
  filter(go_term == "Manual",
         !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE", "ADAPTIVE IMMUNE SYSTEM", "INNATE IMMUNE SYSTEM")) %>% 
  select(process, genes)
```

```{r}
# Função para realizar a análise GSEA para uma condição específica
perform_ORA <- function(df, Immune_GO_T2G) {
  resultados <- list()
  
  # Obter condições únicas na coluna "condition"
  condicoes <- df$condition %>% 
    unique() %>% 
    as.character()
  
  for (condicao in condicoes) {
    # Selecionar DEGs para a condição atual
    degs_condicao <- df %>% 
      filter(condition == condicao) %>%
      select(genes) %>%
      distinct()

    # Preparar gene list
    gene_list_ora <- degs_condicao$genes

    ############ IMMUNE GO
    immune_GO_ORA <- tryCatch({
      enricher(gene_list_ora, 
               TERM2GENE = Immune_GO_T2G, 
               minGSSize = 1,
               maxGSSize = 1000,
               pvalueCutoff = 0.25,
               pAdjustMethod = "BH") %>% 
        as.data.frame() %>% 
        arrange(qvalue) %>% 
        mutate(condition = condicao,
               ora_enrichment = "ImmuneGO")
    }, error = function(e) {
      return(NULL)  # Retorna NULL caso ocorra o erro
    })

    if (!is.null(immune_GO_ORA)) {
      resultados[[paste(condicao, "ImmuneGO", sep = "_")]] <- immune_GO_ORA
    }
  }

  # Combinar todos os resultados em um único dataframe
  resultado_final <- bind_rows(resultados)

  return(resultado_final)
}

df_resultados <- perform_ORA(degs_all_updown_covid_other, Immune_GO_T2G)
print(df_resultados)

#Anotar
immune_GO_ORA_covid_other = df_resultados %>% 
  clean_names() %>% 
  select(process = id, gene_ratio:ora_enrichment) %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  distinct() %>% 
  mutate(log_q = -log10(qvalue))

write.csv(immune_GO_ORA_covid_other, file = "COVID_VAX_immune_GO_ORA.csv")

view(immune_GO_ORA_covid_other)
```

#### Heatmap

```{r}
####### INPUT
data_2 = immune_GO_ORA_covid_other
  
filename_2 = "immune_GO_ORA_covid_other"

######## Matrix
matrix = data_2 %>% 
  filter(qvalue <= 0.25) %>% 
  select(condition, process, log_q) %>% #Percentage_Shared_Cond1
  pivot_wider(names_from = "condition", 
              values_from = "log_q",  #Percentage_Shared_Cond1
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames(var="process") %>% 
  as.matrix() %>% 
  round(2)

######## Annotations
ann_cols = matrix %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("condition") %>% 
  select(condition) %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") 

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame()%>%  
  mutate_if(is.character, as.numeric) %>%
  replace(is.na(.), 0) %>% 
  as.matrix() 

#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols)
```



```{r}
################# Plotar

#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")


# Values colors
col_fun <- colorRamp2(c(0, 2), c("white", "#ED6A5A"))


# Parameters
file = filename_2
mat = matrix_data
width_image = 50
height_image = 20
width = unit(25, "cm")
height = unit(7, "cm")
column_names_gp = gpar(fontsize = 9)
row_names_gp = gpar(fontsize = 9)
rect_gp = gpar(col = "gray90", lwd = 0.5)

###### CLUSTERIZED ALL VS ALL

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, width = width_image, height = height_image, units="cm", res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        show_row_names = TRUE,
                        row_names_side = "left",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical",
                                                    title = "-log(FDR)"),
                        col = col_fun, #color
                        cell_fun = function(j, i, x, y, w, h, fill) {
                              if (mat[i, j] >= 2) {
                                grid.text("***", x, y, gp = gpar(fontsize = 8))
                              } else if (mat[i, j] > 1.5) {
                                grid.text("**", x, y, gp = gpar(fontsize = 9))
                              } else if (mat[i, j] >= 1) {
                                grid.text("*", x, y, gp = gpar(fontsize = 8))
                              } else {
                                grid.text("", x, y)
                              }
                            },
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp, #Grande = 6, Pequeno 15
                        row_dend_width = unit(5, "cm"), #Altura do dendrograma
                        row_split = NULL, #Split row clusters
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width, # 20 para pequeno e grande
                        height = height # 20 para pequeno, 60 para grande
)

draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left",
          merge_legend = TRUE)
dev.off()


```

## GENES COVID vs. VAXGO com ImmuneGO

*Qual a relação entre os genes de cada dataset?*

```{r}
# Gene sets for annotation
OtherGOs_Annotated_Genes = OtherGOs_Annotated_Genes %>% 
  filter(annotation == "Major process",
         term != "Immune system") %>% 
    anti_join(ImmuneGO_Annotated_Genes %>% 
                select(genes) %>% distinct(), 
              by = "genes")

# VAX Genes  ------
VAX_Genes_Annotated_RAW = VAX_Genes_Annotated_RAW %>% 
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")"))

#ImmuneGO
degs_all_updown_vax_immunego = VAX_Genes_Annotated_RAW %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene, regulation) %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% 
               select(genes), by = "genes") %>% 
  distinct()

# Not Immune
degs_all_updown_vax_notimmune = VAX_Genes_Annotated_RAW %>%
  clean_names() %>% 
  mutate(condition = paste0(vaccine, " (", date_time, ")")) %>% 
  select(condition, genes = gene, regulation) %>% 
  inner_join(OtherGOs_Annotated_Genes %>% 
               select(genes), by = "genes") %>% 
  distinct()

# Covid-19 conditions ----
degs_all_updown = degs_updown_p_05_vac_infected

#Immune
degs_all_updown_covid_immune = degs_all_updown %>% 
  as.data.frame() %>% 
  select(condition:padj) %>% 
  mutate(direction = case_when(log2fold_change >= 1 ~ "UP",
                               log2fold_change <= -1 ~ "DOWN",
                               TRUE ~ "NEUTRAL")) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct() %>% 
  filter(vaccine != "I", 
         gse_id != "GSE189039") %>% 
  select(condition, genes, regulation = direction)  %>% 
  distinct()

# Not immune
degs_all_updown_covid_notimmune = degs_all_updown %>% 
  as.data.frame() %>% 
  select(condition:padj) %>% 
    mutate(direction = case_when(log2fold_change >= 1 ~ "UP",
                               log2fold_change <= -1 ~ "DOWN",
                               TRUE ~ "NEUTRAL")) %>% 
  inner_join(ann_vaccines, by = "condition") %>% 
  inner_join(OtherGOs_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  distinct() %>% 
  filter(vaccine != "I", 
         gse_id != "GSE189039") %>% 
  # select(condition, genes, regulation = direction)  %>% 
  distinct()


# Bind Immune ------
degs_all_updown_covid_other = bind_rows(degs_all_updown_vax_immunego, degs_all_updown_covid_immune) %>% 
  distinct()


covid_other_immunego_genes = degs_all_updown_covid_other %>% 
  distinct() %>% 
  filter(regulation %in% c("UP", "DOWN")) %>% 
  mutate(regulation_numeric = case_when(
    regulation %in% c("UP") ~ 1,
    regulation %in% c("DOWN") ~ -1,
    TRUE ~ as.numeric(regulation)
  )) %>% 
  distinct()

saveRDS(covid_other_immunego_genes, file = "covid_other_immunego_genes.rds")



# Bind not-immune ----
degs_all_updown_covid_other_notimmune = bind_rows(degs_all_updown_vax_notimmune, degs_all_updown_covid_notimmune) %>% 
  distinct()

covid_other_notimmune_genes = degs_all_updown_covid_other_notimmune %>% 
  anti_join(ImmuneGO_Annotated_Genes %>% select(genes) %>% distinct(), by = "genes") %>% 
  inner_join(OtherGOs_Annotated_Genes %>% select(process = term, genes) %>% filter(), by = "genes") %>% 
  distinct() %>% 
  filter(regulation %in% c("UP", "DOWN")) %>% 
  mutate(regulation_numeric = case_when(
    regulation %in% c("UP") ~ 1,
    regulation %in% c("DOWN") ~ -1,
    TRUE ~ as.numeric(regulation))) %>% 
  distinct()

saveRDS(covid_other_notimmune_genes, file = "covid_other_notimmune_genes.rds")


```

```{r}
###### Gene sets Immune GO ------

Immune_GO_genes_All = covid_other_immunego_genes 

Immune_GO_genes_Innate = Immune_GO_genes_All %>%
   filter(process == "INNATE IMMUNE SYSTEM")
Immune_GO_genes_Adaptive = Immune_GO_genes_All %>%
   filter(process == "ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Complement = Immune_GO_genes_All %>%
   filter(process == "COMPLEMENT IMMUNE SYSTEM")

# Sistema inato
Immune_GO_genes_Inflammation = Immune_GO_genes_All %>%
  filter(process == "INFLAMMATION")
Immune_GO_genes_ARPP = Immune_GO_genes_All %>%
  filter(process == "ARPP")
Immune_GO_genes_IFN = Immune_GO_genes_All %>%
  filter(process == "ANTIVIRAL AND INTERFERON")
Immune_GO_genes_Neutrophil = Immune_GO_genes_All %>%
  filter(process == "NEUTROPHIL")
Immune_GO_genes_Eosinophil = Immune_GO_genes_All %>%
  filter(process == "EOSINOPHIL")
Immune_GO_genes_Complement = Immune_GO_genes_All %>%
  filter(process == "COMPLEMENT IMMUNE SYSTEM")
Immune_GO_genes_Monocytes = Immune_GO_genes_All %>%
  filter(process == "MONOCYTES")
Immune_GO_genes_DC = Immune_GO_genes_All %>%
  filter(process == "DENDRITIC CELLS")
Immune_GO_genes_Macro = Immune_GO_genes_All %>%
  filter(process == "MACROPHAGES")
Immune_GO_genes_NK = Immune_GO_genes_All %>%
  filter(process == "NK CELL")

# Sistema adaptativo
Immune_GO_genes_Cellular = Immune_GO_genes_All %>%
  filter(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Humoral = Immune_GO_genes_All %>%
  filter(process == "HUMORAL ADAPTIVE IMMUNE SYSTEM")
Immune_GO_genes_Tcells = Immune_GO_genes_All %>%
  filter(process == "T CELLS")
Immune_GO_genes_Bcells = Immune_GO_genes_All %>%
  filter(process == "B CELLS")
Immune_GO_genes_Ig = Immune_GO_genes_All %>%
  filter(process == "IMMUNOGLOBULIN MEDIATED IMMUNE RESPONSE")

```

#### Heatmap

```{r}
####### INPUT
data_2 = Immune_GO_genes_All
filename_2 = paste0("Immune_GO_genes_All", "_VAX_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  filter(rowSums(. != 0) > 1) %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>%
              filter(go_term == "Manual",
                     !process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE")), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")


# Rows Not immune -----
# ann_rows_notimmune = matrix_data %>%
#   as.data.frame() %>%
#   rownames_to_column("genes") %>%
#   left_join(ann_genes %>%
#                select(process = term, genes = symbol, annotation) %>%
#                filter(annotation == "Major process",
#                       process != "Immune system"), by = "genes") %>%
#   select(genes, process) %>%
#   distinct() %>%
#   group_by(genes) %>%
#   mutate(i_process = row_number()) %>%
#   pivot_wider(., names_from = "i_process", values_from = "process") %>%
#   column_to_rownames("genes") %>%
#   t() %>%
#   as.data.frame() %>%
#   rownames_to_column("index") %>%
#   arrange(desc(index)) %>%
#   column_to_rownames("index") %>%
#   t() %>%
#   as.data.frame() %>%
#   replace(is.na(.), ".")


#Verificar dimensões do dataset
dim(matrix_data)
dim(ann_cols_heatmap)
# dim(ann_rows_notimmune)
dim(ann_rows_immune)

```

Sizes: 1. Cellular adaptive immune system: width = unit(25, "cm"),
height = unit(60, "cm") #254 genes 2. Humoral adaptive immune system:
width = unit(25, "cm"), height = unit(30, "cm") #51 genes 3. T cells:
width = unit(25, "cm"), height = unit(60, "cm") #221 genes 4. B cells:
width = unit(25, "cm"), height = unit(50, "cm") #146 genes 5. Ig
mediated: width = unit(25, "cm"), height = unit(10, "cm") #146 genes 6.
Inflammation: width = unit(25, "cm"), height = unit(10, "cm") 7. ARPP:
width = unit(25, "cm"), height = unit(30, "cm") 60 genes 8. IFN: width =
unit(25, "cm"), height = unit(30, "cm") 93 genes 9. DC: width = unit(25,
"cm"), height = unit(20, "cm") #29 genes 10. Macrophages: width =
unit(25, "cm"), height = unit(25, "cm") \# 52 genes 11. Neutrophils:
width = unit(25, "cm"), height = unit(40, "cm") \# 70 genes 12.
Eosinophil: width = unit(25, "cm"), height = unit(10, "cm") \# 42 genes
13. Complement: width = unit(25, "cm"), height = unit(10, "cm") \# 40
genes 13. Monocytes: width = unit(25, "cm"), height = unit(15, "cm") \#
48 genes 15. All immune genes: width_image = 60, height_image = 70,
width = unit(30, "cm"), height = unit(60, "cm"), row_split = 7,
column_split = 2

More refs:
<https://debrowser.readthedocs.io/en/master/heatmap/heatmap.html>

### All genes

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 50
width = unit(30, "cm")
height = unit(40, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 0)
rect_gp = gpar(col = "gray80", lwd = 0)
row_split = 2
column_split = 2


fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        col = col_fun, #color
                        name = "L2FC",
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(5, "cm"),
                        row_split = row_split,
                        column_split = column_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "right",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

dev.off()

```

Get row clusters

```{r}
r.dend <- row_dend(heatmap_plot)  #Extract row dendrogram
rcl.list <- row_order(heatmap_plot)  #Extract clusters (output is a list)
lapply(rcl.list, function(x) length(x))  #check/confirm size cluster

gene_cluster <- NULL
for (i in 1:length(rcl.list)) {
  a <- row.names(mat[row_order(heatmap_plot)[[i]], ])
  gene_cluster <- rbind(gene_cluster, data.frame(genes = a, cluster = paste0("cluster ", i), gene_set = "Immune genes"))
}
write.csv(gene_cluster, file = paste0(file, "_clustered_genes.csv"), row.names = F)
```

### Cluster 1 Immune genes

```{r}
####### INPUT
data_2 = Immune_GO_genes_All %>% 
  inner_join(gene_cluster %>% filter(cluster == "cluster 1") %>% select(genes), by = "genes")
filename_2 = paste0("Immune_GO_genes_cluster1", "_VAX_COVID")
```

```{r}
######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`))


#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_immune)

```

More refs:
<https://debrowser.readthedocs.io/en/master/heatmap/heatmap.html>

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 50
height_image = 50
width = unit(30, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 12)
row_names_gp = gpar(fontsize = 12)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                       left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                       name = "L2FC",
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = 2,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left",
     merge_legend = TRUE)

heatmap_plot

dev.off()

```


### Inflammation

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "left")

row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 50
width = unit(30, "cm")
height = unit(40, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 0)
rect_gp = gpar(col = "gray80", lwd = 0)
row_split = 2
column_split = 2


fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "vertical"),
                        col = col_fun, #color
                        name = "L2FC",
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(5, "cm"),
                        row_split = row_split,
                        column_split = column_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "right",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

dev.off()

```



#### Not immune
```{r}
################# NOT Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_notimmune,
                       col = col_process_notimmune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 60
height_image = 50
width = unit(30, "cm")
height = unit(40, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 0)
rect_gp = gpar(col = "gray80", lwd = 0)
row_split = 7

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(5, "cm"),
                        row_split = row_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = T,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

heatmap_plot

dev.off()
```















# Random forest genes
## 50 most shared genes

```{r}
#### Immune -----
ann_vaccines_covid_other = ann_vaccines_vaxsig_covid

stats_1 = degs_all_updown_covid_vax_other_immune %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  group_by(genes, covid_other) %>% 
  summarise(n_conditions = n()) %>% 
  filter(all(c("COVID", "OTHER") %in% covid_other)) %>% 
  arrange(desc(n_conditions), genes) %>% 
  group_by(genes) %>% 
  pivot_wider(., names_from = "covid_other", values_from = n_conditions) %>% 
  arrange(desc(OTHER)) %>% 
  ungroup() %>% 
  slice_head(n = 50) %>% 
  pivot_longer(-genes, names_to = "covid_other", values_to = "n_conditions")


stats_1 = degs_all_updown_covid_vax_other_immune %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  group_by(genes, covid_other) %>% 
  summarise(n_conditions = n()) %>% 
  filter(all(c("COVID", "OTHER") %in% covid_other)) %>% 
  arrange(desc(n_conditions), genes) %>% 
  group_by(genes) %>% 
  pivot_wider(., names_from = "covid_other", values_from = n_conditions) %>% 
  arrange(desc(OTHER)) %>% 
  ungroup() %>% 
  slice_head(n = 50) %>% 
  pivot_longer(-genes, names_to = "covid_other", values_to = "n_conditions")

stats_1 %>% 
  select(genes) %>% 
  distinct()

ggplot_stats1 = ggplot(stats_1) +
  aes(x = reorder(genes, n_conditions), fill = covid_other, weight = n_conditions) +
  geom_bar() +
  theme_minimal() +
  scale_fill_manual(
    values = c(COVID = "#56cfe1",
    OTHER = "#343a40")
  ) +
  theme_minimal() +
  labs(fill = "Covid or non-covid") +
  xlab("Genes") + 
  ylab("Number of shared conditions") +
  theme(legend.position = "right",
        axis.text.x = element_text(vjust = 1.5, hjust=1, size = 12),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  # geom_text(aes(label = n_conditions, y = n_conditions), 
  #           position = position_dodge(width = 0.9), 
  #           vjust = 0.2, 
  #           hjust = -0.2, 
  #           size = 1,
  #           angle = 90) +
  ggtitle("Genes shared") +
  coord_flip()

ggsave(ggplot_stats1, file = "Covid_Vax_genes_shared_column.png", width = 10, height = 10)


# Subset the 50 most shared genes
covid_other_immune_genes_50_mostshared_all = stats_1 %>% 
  select(genes) %>% 
  distinct() %>% 
  inner_join(degs_all_updown_covid_vax_other_immune %>% 
               select(condition, genes), by = "genes")
```

```{r}
#### Not Immune -----
stats_2 = covid_other_notimmune_genes %>% 
  select(-process) %>% 
  distinct() %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  group_by(genes, covid_other) %>% 
  summarise(n_conditions = n()) %>% 
  filter(all(c("COVID", "OTHER") %in% covid_other)) %>% 
  arrange(desc(n_conditions), genes) %>% 
  group_by(genes) %>% 
  pivot_wider(., names_from = "covid_other", values_from = n_conditions) %>% 
  arrange(desc(OTHER)) %>% 
  ungroup() %>% 
  slice_head(n = 50) %>% 
  pivot_longer(-genes, names_to = "covid_other", values_to = "n_conditions")

ggplot_stats2 = ggplot(stats_2) +
  aes(x = reorder(genes, n_conditions), fill = covid_other, weight = n_conditions) +
  geom_bar() +
  theme_minimal() +
  scale_fill_manual(
    values = c(COVID = "#56cfe1",
    OTHER = "#343a40")
  ) +
  theme_minimal() +
  labs(fill = "Covid or non-covid") +
  xlab("Genes") + 
  ylab("Number of shared conditions") +
  theme(legend.position = "right",
        axis.text.x = element_text(vjust = 1.5, hjust=1, size = 12),
        axis.text.y = element_text(size = 12, angle = 0, color = "black"),
        panel.grid.minor.y = element_blank(),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 12, face = "bold")) +
  # geom_text(aes(label = n_conditions, y = n_conditions), 
  #           position = position_dodge(width = 0.9), 
  #           vjust = 0.2, 
  #           hjust = -0.2, 
  #           size = 1,
  #           angle = 90) +
  ggtitle("Genes shared") +
  coord_flip()

ggsave(ggplot_stats2, file = "Covid_Vax_Not-Immune_genes_shared_column.png", width = 10, height = 10)

# Subset the 50 most shared genes
covid_other_notimmune_genes_50_mostshared_all = stats_2 %>% 
  select(genes) %>% 
  inner_join(covid_other_notimmune_genes, by = "genes") 

covid_other_notimmune_genes_50_mostshared_all %>% select(genes) %>% distinct()

```

#### Heatmap

```{r}
####### INPUT
data_2 = covid_other_immune_genes_50_mostshared_all
filename_2 = paste0("mmune_GO_genes_All_50", "_VAX_COVID")

######## Matrix
matrix = data_2 %>% 
  select(genes, condition, regulation_numeric) %>%
  pivot_wider(names_from = "condition", 
              values_from = "regulation_numeric", 
              values_fn = mean) %>% 
  replace(is.na(.), 0) %>%
  arrange(genes) %>% 
  column_to_rownames(var="genes") %>% 
  as.matrix()

######## Annotations
ann_vaccines_covid_other_2 = data_2 %>% 
  inner_join(ann_vaccines_covid_other, by = "condition") %>% 
  select(condition, covid_other, microbe_type, disease_vac, type, week) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix %>% 
  colnames() %>% 
  data.frame() %>% 
  filter(. != "genes") %>% 
  rename(condition = '.') %>% 
  inner_join(ann_vaccines_covid_other_2, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition")

matrix_data = matrix %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
  select(!c(covid_other:week)) %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_immune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ImmuneGO_Annotated_Genes %>% filter(go_term == "Manual"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  arrange(genes, factor(process, levels = c("INNATE IMMUNE SYSTEM", "ADAPTIVE IMMUNE SYSTEM")), .by_group = TRUE) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  mutate(index = as.numeric(index)) %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".") %>% 
  mutate(`1` = if_else(`1` == ".", "INNATE IMMUNE SYSTEM", `1`))


# Rows Not immune -----
ann_rows_notimmune = matrix_data %>%
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  left_join(ann_genes %>%
               select(process = term, genes = symbol, annotation) %>%
               filter(annotation == "Major process",
                      process != "Immune system"), by = "genes") %>%
  select(genes, process) %>%
  distinct() %>%
  group_by(genes) %>%
  mutate(i_process = row_number()) %>%
  pivot_wider(., names_from = "i_process", values_from = "process") %>%
  column_to_rownames("genes") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("index") %>%
  arrange(desc(index)) %>%
  column_to_rownames("index") %>%
  t() %>%
  as.data.frame() %>%
  replace(is.na(.), ".")


#Verificar dimensões do dataset
dim(matrix)
dim(matrix_data)
dim(ann_cols_heatmap)
dim(ann_rows_notimmune)
dim(ann_rows_immune)

```

More refs:
<https://debrowser.readthedocs.io/en/master/heatmap/heatmap.html>

```{r}
################# Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = row_ha = HeatmapAnnotation(df = ann_rows_immune,
                       col = col_process_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 50
height_image = 50
width = unit(30, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 12)
row_names_gp = gpar(fontsize = 8)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                       left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = 2,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "left")

heatmap_plot

dev.off()

```

```{r}
################# NOT Immune 
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = ann_vaxsig_colors,
                       annotation_name_side = "right")

row_ha = HeatmapAnnotation(df = ann_rows_notimmune,
                       col = col_process_notimmune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(-1, 0, 1), c("#9bc1bc", "white", "#ed6a5a"))

file = filename_2
mat = matrix_data
width_image = 50
height_image = 50
width = unit(30, "cm")
height = unit(30, "cm")
column_names_gp = gpar(fontsize = 12)
row_names_gp = gpar(fontsize = 8)
rect_gp = gpar(col = "gray80", lwd = 0.5)
row_split = NULL
column_split = 3

fileimageheatmap_grouped = paste0(file, sep ="_", "Complexheatmap.png")

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        show_column_names = TRUE,
                        column_title = fileimageheatmap_grouped,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "white",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = row_split,
                        column_split = column_split,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        clustering_distance_columns = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height,
                        use_raster = F)

heatmap_plot = draw(heatmap_plot)

heatmap_plot

dev.off()
```
