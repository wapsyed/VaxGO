---
title: "VaxGO"
author: "Wasim Syed (@wasimvacinas)"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#ffffff"
      fg: "#000000" 
      primary: "#ffffff"
      base_font:
        google: Montserrat
      code_font:
        google: Montserrat
    source_code: embed 
    navbar:
        - { icon: "fa-instagram", href: "https://instagram.com/wasimvacinas", align: right}
        - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/wapsyed", align: right}
        - { icon: "ion-github", href: "github.com/wapsyed", align: right}
    
runtime: shiny
orientation: columns
---

<style>
  body {
    font-size: 12px;
  }
  
  .form-group,
  .shiny-input-container {
    font-size: 12x; 
  }
  
  .shiny-input-container input,
  .shiny-input-container select,
  .shiny-input-container textarea {
    font-size: 12px;
  }
  
  .btn,
  .btn-primary {
    font-size: 12px; 
  }
  
  .table,
  .table th,
  .table td {
    font-size: 12px; 
  }
</style>



```{r setup, include=FALSE}

# Install packages ------
# install.packages("flexdashboard")
# install.packages("datasets")
# install.packages("knitr")
# devtools::install_github("rstudio/d3heatmap")
# install_github("jokergoo/InteractiveComplexHeatmap")
# install.packages("biclust")
# install.packages("BH")

# Call library ------
library(devtools)
library(GEOquery)
library(Matrix)
library(circlize)
library(RColorBrewer)
library(celldex)
library(biomaRt)
library(org.Hs.eg.db)
library(plotly)
library(DESeq2)
library(msigdbr)
library(ape)
library(GSVA)
library(sva)
library(clusterProfiler)
library(EnhancedVolcano)
library(ggbeeswarm)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(esquisse)
library(ComplexHeatmap)
library(janitor)
library(ggsci)
library(patchwork)
library(ggthemes)
library(here)
library(extrafont)
library(showtext)
library(readxl)
library(scales)
library(tidyverse)
library(flexdashboard)
library(ggheatmap)
library(vegan)
library(InteractiveComplexHeatmap)
library(corto)
library(ggstatsplot)
library(ImmuneSpaceR)
library(plotly)
library(flexdashboard)
library(datasets)
library(d3heatmap)
library(InteractiveComplexHeatmap)
library(biclust)
library(datasets)
library(DT)
library(ggthemes)
library(here)
library(tidyverse)
library(dplyr)
library("org.Hs.eg.db")
library(BH)
library(BiocManager)
library(tidyverse)
library(cytolib)
# options(repos = BiocManager::repositories())
options(repos = c(CRAN = "https://cran.rstudio.com/",
                  BioC = BiocManager::repositories()))

```

# DEGs analysis

## Column {.sidebar data-width=300}

```{r}
#INPUTS

#https://shiny.posit.co/r/gallery/widgets/widget-gallery/ 

############## Upload files ############## 

textInput(inputId = "filename", 
          label = "Project title", 
          value = "my_condition_degs")


fileInput(inputId = "conditions_genes", 
          label = "Upload your DEGs L2FC",
           accept = ".csv")


fileInput(inputId = "annotation_conditions", 
          label = "Upload annotations",
           accept = ".csv")

fileInput(inputId = "normalized_counts", 
          label = "Upload your normalized counts",
           accept = ".csv")

checkboxGroupInput(inputId = "columns_annotation", 
                   label = "Select annotations", 
                   choices = NULL)

# Reactive expression to read the uploaded file
annotations <- reactive({
  req(input$annotation_conditions)
  read.csv(input$annotation_conditions$datapath)
})

# Observe the file input and update the checkbox group choices
observe({
  req(annotations())
  updateCheckboxGroupInput(session, "columns_annotation",
                           choices = names(annotations()))
})

tableOutput("selected_columns")

actionButton("go_1", "Go")

############## Filters 

# DGE analysis
numericInput(inputId = "filter_padj", 
             label = "Adjusted p-value cutoff", 
             value = 0.05, 
             min = 0, max = 1, step = 0.01)

numericInput(inputId = "filter_logfc", 
             label = "Log2 Fold Change cutoff", 
             value = 1, 
             min = 0, max = 10, step = 0.1)

```

## Column

### Genes table

```{r}

# Reactive expression to load and process the file
conditions_genes <- reactive({
  req(input$conditions_genes)
  
  # Load the file
  conditions_genes <- read.csv(input$conditions_genes$datapath) %>% 
    distinct()
  conditions_genes
})

# Reactive expression to filter significant DEGs
degs_sig <- reactive({
  req(conditions_genes(), input$filter_padj)
  
  degs_sig <- conditions_genes() %>%
    filter(padj < input$filter_padj) %>% 
    distinct()
  
  degs_sig
})

# Reactive expression to further filter DEGs and extract gene names
genes <- reactive({
  req(degs_sig())
  
  genes <- degs_sig() %>%
    filter(direction != "NEUTRAL") %>%
    pull(genes)
  
  genes
})

DT::renderDataTable({
  req(input$go_1) # Action button
  req(degs_sig())
  
  # Define input values for the cutoffs
filter_l2fc <- input$filter_logfc
filter_neg_l2fc <- -input$filter_logfc
  
  # Transform the filtered data into a DataTable
degs_sig() %>%
  datatable(options = list(pageLength = 25)) %>%
  formatStyle(
    'log2fold_change',
    backgroundColor = styleInterval(
      c(filter_neg_l2fc, filter_l2fc),
      c('#3399FF', 'white', '#FF6666')
    ),
    fontWeight = 'bold'  # Optional: make the text bold for better visibility
  )
})

```

## Column
### Volcano plot

```{r}
renderPlotly({
    req(input$go_1) # Action button
  req(conditions_genes())
  
  # Prepare the data
  data <- conditions_genes() %>%
    mutate(log_q = -log10(padj))
  
  # Create the volcano plot directly with plotly
  plot_ly(data, x = ~ log2fold_change, 
          y = ~ log_q, 
          text = ~ genes,
          type = 'scatter', 
          mode = 'markers',
           marker = list(
            color=~log2fold_change,
            size=10,
            opacity=.9,
            colorscale=c("#3399FF","white", "#FF6666"),
            colorbar=list(title='L2FC')
        )) %>%
    layout(
      title = "Volcano Plot",
      xaxis = list(title = "Log2 Fold Change"),
      yaxis = list(title = "-Log10 Adjusted P-value"),
      coloraxis = list(colorbar = list(title = 'L2FC')
      ))
})
```

### Bar plot


```{r}
renderPlotly({
    req(input$go_1) # Action button
  req(conditions_genes())
  
  # Prepare the data
  data <- conditions_genes()  %>%
        filter(direction != "NEUTRAL",
           log2fold_change >= input$filter_logfc | log2fold_change <= - input$filter_logfc,
           padj < input$filter_padj) %>% 
    group_by(condition, direction) %>% 
    summarize(n_direct = n()) %>% 
    ungroup()
    
  
  # Create the volcano plot directly with plotly
  plot_ly(data, 
        x = ~condition, 
        y = ~n_direct, 
        color = ~direction, 
        colors = c("#3399FF", "#FF6666"),
        text = ~direction,
        type = 'bar') %>%
  layout(
    title = "DEGs Counts",
    xaxis = list(title = "Condition"),
    yaxis = list(title = "# Genes"),
    barmode = 'group',  
    coloraxis = list(colorbar = list(title = 'Direction'))
  )
})

```


# Over representation analysis

## Column {.sidebar data-width=300}

```{r}
#ORA Parameters

# Tamanho mínimo e máximo do conjunto de genes (Gene Set Size)
numericInput(inputId = "minGSSize", 
             label = "Minimum Gene Set Size", 
             value = 1, 
             min = 1, max = 1000, step = 1)

numericInput(inputId = "maxGSSize", 
             label = "Maximum Gene Set Size", 
             value = 1000, 
             min = 1, max = 10000, step = 1)

# Multiple testing p-value adjustment method
selectInput(inputId = "pAdjustMethod", 
            label = "p-value Adjustment Method", 
            choices = c("BH", "BY", "fdr", "holm", "hochberg", "hommel", "bonferroni"),
            selected = "BH")

# Cutoffs ORA (Over-Representation Analysis)
numericInput(inputId = "pvalueCutoff_ora", 
             label = "ORA p-value Cutoff", 
             value = 0.05, 
             min = 0, max = 1, step = 0.01)

numericInput(inputId = "qvalueCutoff_ora", 
             label = "ORA q-value Cutoff", 
             value = 0.10, 
             min = 0, max = 1, step = 0.01)

# Multiple testing p-value adjustment method
selectInput(inputId = "organism", 
            label = "Organism", 
            choices = c("org.Hs.eg.db", "org.Mm.eg.db"),
            selected = "org.Hs.eg.db")


actionButton("go", "Go")

```

Please, be patient. It may take a while.


## Column {.tabset .tabset-fade}

```{r}
# Load data ------

########## Gene sets ------

######## IMMUNEGO -----
ImmuneGO_Annotated_GO <- read_csv(here("Tables", "ImmuneGO_Annotated_GO_2024-05-28.csv"))

ImmuneGO_annotation = ImmuneGO_Annotated_GO %>% 
  dplyr::select(process, immune_system:immune_tissue) 

ImmuneGO_genes_general = ImmuneGO_Annotated_GO %>% 
  separate_rows(genes, sep = ",") %>% 
  filter(go_term == "Manual",
         !process %in% c("ADAPTIVE IMMUNE SYSTEM",
                         "INNATE IMMUNE SYSTEM",
                         "BCR REPERTOIRE",
                         "TCR REPERTOIRE")) %>% 
  dplyr::select(process, genes)

ImmuneGO_genes_specific = ImmuneGO_Annotated_GO %>% 
  separate_rows(genes, sep = ",") %>% 
  filter(!go_term == "Manual") %>% 
  dplyr::select(process=gene_set_short, genes)

######## CELL MARKER IMMUNE ---------

CellMarker_ImmuneCells = read_csv(here("Tables", "CellMarker_ImmuneCells.csv"))
CellMarker_annotation = CellMarker_ImmuneCells %>% 
  dplyr::select(cell_name, Type) %>% 
  distinct()

CellMarker_genes = CellMarker_ImmuneCells %>% 
  dplyr::select(process = cell_name, genes = marker)

######## VAX MSIGDB --------
VaxSigDB_Gene_sets_Annotated_RAW <- read_csv(here("Tables", "VaxSigDB_Gene_sets_Annotated_RAW.csv"))

#Filters
vaxsig_columns = c("VACCINE", "PLATFORM", "TARGET_PATHOGEN_DISEASE", "MICROBE_TYPE", "STUDY_TYPE", "STUDY_SUBTYPE","DATE-TIME", "DATE", "TIME", "AGE", "AGE_CATEGORY", "SAMPLE_SOURCE", "SYSTEMATIC_NAME", "GENE_SYMBOLS")
filter_vaxsig_samplesource = "PBMC"
filter_vaxsig_studytype = "VACCINE"
filter_vaxsig_studysubtype = "VAC ONLY"

VaxSigDB_Genesets_filtered = VaxSigDB_Gene_sets_Annotated_RAW %>% 
  dplyr::select(vaxsig_columns) %>% 
  filter(SAMPLE_SOURCE == filter_vaxsig_samplesource,
         STUDY_TYPE == filter_vaxsig_studytype,
         STUDY_SUBTYPE == filter_vaxsig_studysubtype) 
#Annotation
VaxSigDB_annotation = VaxSigDB_Genesets_filtered %>% 
  mutate(process = paste0(VACCINE, " (", `DATE-TIME`, ", ", AGE, " YO)")) %>% 
  dplyr::select(process, PLATFORM, TARGET_PATHOGEN_DISEASE, MICROBE_TYPE, DATE, TIME)
#Genes
VaxSigDB_Genes_filtered = VaxSigDB_Genesets_filtered %>% 
  separate_rows(GENE_SYMBOLS, sep = ",") %>% 
  mutate(process = paste0(VACCINE, " (", `DATE-TIME`, ", ", AGE, " YO)")) %>% 
  dplyr::select(process, genes = GENE_SYMBOLS)

######## BTM MODULES --------
btm_annotation_table <- read_csv(here("Tables", "btm_annotation_immune_table_labelled.csv"))

#Filters
filter_btm_category = "immune"
filter_btm_annotationlevel = c("complete", "partial") #Anyone
# filter_btm_annotationlevel = "complete"
# filter_btm_annotationlevel = "partial"

#Annotation
btm_annotation = btm_annotation_table %>% 
  filter(module_category == filter_btm_category,
         annotation_level %in% filter_btm_annotationlevel) %>% 
  dplyr::select(immune_system, immune_subsystem, cells, composite_name)
#Genes
btm_genes = btm_annotation_table %>% 
  filter(module_category == filter_btm_category,
         annotation_level %in% filter_btm_annotationlevel) %>% 
  dplyr::select(process = composite_name, genes = module_member_genes) %>% 
  separate_rows(genes, sep = ",")

#Vaccine Atlas TERMINAR -----
# study <- CreateConnection("IS2")
# 
# dataset <- study$getDataset("demographics", original_view = FALSE)
# VaxAtlas_all_norm_eset <- readRDS(here("Tables", "VaxAtlas_all_norm_eset.rds"))
```

### General ORA
```{r}
#### General Gene ontologies
# Filter non-neutral DEGs
# Reactive expression to filter non-neutral DEGs
df <- reactive({
  req(degs_sig())
  degs_sig() %>%
    filter(direction != "NEUTRAL")
})

# Compute GO enrichment results
ora_results_general <- reactive({
  
  req(input$go) #Action button
  
  req(df())
  
  results <- list()
  
  for (condition_2 in unique(df()$condition)) {
    genes <- df() %>%
      filter(condition == condition_2) %>%
      pull(genes)
    
    go_enrich <- tryCatch({
      enrichGO(gene = genes,
               OrgDb = input$organism, 
               keyType = 'SYMBOL',
               readable = TRUE,
               ont = "BP",
               pvalueCutoff = input$pvalueCutoff_ora, 
               qvalueCutoff = input$qvalueCutoff_ora) %>%
        as.data.frame() %>%
        mutate(condition = condition_2)
    }, error = function(e) {
      return(NULL)
    })
    
    if (!is.null(go_enrich)) {
      results[[condition_2]] <- go_enrich   
    }
  }
  
  ora_results = bind_rows(results) %>%
    rownames_to_column("delete") %>%
    dplyr::select(-"delete") %>%
    clean_names() 
  
  ora_results
  
})

# Display the final results
DT::renderDataTable({
  req(input$go) # Action button
  req(ora_results_general())
  ora_results_general() %>% datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})

```

```{r include=FALSE}
# Function
autoORA <- function(df,
                    TERM2GENE,
                    pAdjustMethod, 
                    pvalueCutoff_ora, 
                    qvalueCutoff_ora,
                    geneset_name) {
  
  # Função interna para aplicar enricher a uma condição específica
  enricher_conditional <- function(condition_2, df, TERM2GENE, pAdjustMethod, pvalueCutoff_ora, qvalueCutoff_ora) {
    genes <- df %>% 
      filter(condition == condition_2) %>% 
      pull(genes)
    
    tryCatch({
      enricher(gene = genes,
               TERM2GENE = TERM2GENE,
               pAdjustMethod = pAdjustMethod,
               pvalueCutoff = pvalueCutoff_ora, 
               qvalueCutoff = qvalueCutoff_ora) %>% 
        as.data.frame() %>%
        mutate(condition = condition_2,
               geneset_name = geneset_name)
    }, error = function(e) {
      NULL
    })
  }
  
  # Aplicar a função interna a cada condição única e combinar os resultados
  ora_results <- df %>%
    distinct(condition) %>%
    pull(condition) %>%
    map_dfr(~ enricher_conditional(.x, df, TERM2GENE, pAdjustMethod, pvalueCutoff_ora, qvalueCutoff_ora))
  
  # Limpar os resultados finais
  ora_results_final <- ora_results %>%
    rownames_to_column("delete") %>%
    dplyr::select(-delete, -Description) %>%
    dplyr::select(condition, geneset_name, everything()) %>% 
    clean_names() %>% 
    rename(process = id)
  
  return(ora_results_final)
}
```

### ImmuneGO General
```{r}
# Reactive expression to perform ORA analyses
ora_results_ImmuneGO_General <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_ImmuneGO_General <- df() %>%
    autoORA(TERM2GENE = ImmuneGO_genes_general,
            geneset_name = "ImmuneGO General",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_ImmuneGO_General())
  ora_results_ImmuneGO_General() %>% 
  datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```

### ImmuneGO specific
```{r}
# Reactive expression to perform ORA analyses
ora_results_ImmuneGO_specific <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_ImmuneGO_specific <- df() %>%
    autoORA(TERM2GENE = ImmuneGO_genes_specific,
            geneset_name = "ImmuneGO Specific",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_ImmuneGO_specific())
  ora_results_ImmuneGO_specific() %>% 
    datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```


### CellMarker immune
```{r}
# Reactive expression to perform ORA analyses
ora_results_Cellmarker_Immune <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_CellMarker_immune <- df() %>%
    autoORA(TERM2GENE = CellMarker_genes,
            geneset_name = "CellMarker Immune",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_Cellmarker_Immune())
  ora_results_Cellmarker_Immune() %>% 
    datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```

### BTM immune
```{r}
# Reactive expression to perform ORA analyses
ora_results_BTM_Immune <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_BTM_immune <- df() %>%
    autoORA(TERM2GENE = btm_genes,
            geneset_name = "BTM Immune",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_BTM_Immune())
  ora_results_BTM_Immune() %>% 
    datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```

### VAX MsigDB
```{r}
# Reactive expression to perform ORA analyses
ora_results_VAX_filtered <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_VAX_filtered <- df() %>%
    autoORA(TERM2GENE = VaxSigDB_Genes_filtered,
            geneset_name = "VAX SigDB filtered",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_VAX_filtered())
  ora_results_VAX_filtered() %>% 
    datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```


# GSEA

## Column {.sidebar data-width=300}
```{r}
#ORA Parameters

# Tamanho mínimo e máximo do conjunto de genes (Gene Set Size)
numericInput(inputId = "minGSSize", 
             label = "Minimum Gene Set Size", 
             value = 1, 
             min = 1, max = 1000, step = 1)

numericInput(inputId = "maxGSSize", 
             label = "Maximum Gene Set Size", 
             value = 1000, 
             min = 1, max = 10000, step = 1)

# Multiple testing p-value adjustment method
selectInput(inputId = "pAdjustMethod", 
            label = "p-value Adjustment Method", 
            choices = c("BH", "BY", "fdr", "holm", "hochberg", "hommel", "bonferroni"),
            selected = "BH")

# Cutoff GSEA
numericInput(inputId = "pvalueCutoff_gsea", 
             label = "GSEA p-value Cutoff", 
             value = 0.25, 
             min = 0, max = 1, step = 0.01)


# Multiple testing p-value adjustment method
selectInput(inputId = "organism", 
            label = "Organism", 
            choices = c("org.Hs.eg.db", "org.Mm.eg.db"),
            selected = "org.Hs.eg.db")

actionButton("go_2", "Go")


```

Please, be patient. It may take a while.

## Column {.tabset .tabset-fade}

```{r include=FALSE}
# Define the autoGSEA function
autoGSEA <- function(df, TERM2GENE, 
                     geneset_name, 
                     minGSSize, 
                     maxGSSize,
                     pvalueCutoff,
                     pAdjustMethod) {
  results <- list()
  
  condicoes <- df %>%
    dplyr::pull(condition) %>%
    unique() %>%
    as.character()
  
  for (condicao in condicoes) {
    degs_condicao <- df %>%
      dplyr::filter(condition == condicao) %>%
      dplyr::select(genes, log2fold_change) %>%
      distinct() %>%
      mutate(rank = rank(log2fold_change, ties.method = "random")) %>%
      arrange(desc(rank))
    
    gene_list_lf2c <- as.vector(degs_condicao$log2fold_change)
    names(gene_list_lf2c) <- degs_condicao$genes
    gene_list_lf2c <- na.omit(gene_list_lf2c)
    gene_list_lf2c <- sort(gene_list_lf2c, decreasing = TRUE)
    
    auto_gsea <- tryCatch({
      GSEA(geneList = gene_list_lf2c,
           TERM2GENE = TERM2GENE,
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff,
           pAdjustMethod = pAdjustMethod) %>%
        as.data.frame() %>%
        arrange(qvalue) %>%
        mutate(condition = condicao,
               gsea_enrichment = geneset_name)
    }, error = function(e) {
      return(NULL)
    })
    
    if (!is.null(auto_gsea)) {
      results[[paste(condicao, geneset_name, sep = "_")]] <- auto_gsea
    }
  }
  
  final_result <- bind_rows(results) %>%
    rename(process = ID) %>%
    dplyr::select(-Description) %>%
    clean_names() %>%
    dplyr::select(condition, everything())
  
  return(final_result)
}
```



### ImmuneGO General
```{r}
# Perform GSEA

# Reactive expression to perform GSEA analyses
gsea_results_ImmuneGO_General <- reactive({
  req(input$go_2)
  req(degs_sig())
  
  degs_sig = degs_sig()
  
  # Perform ORA for ImmuneGO general
  degs_GSEA_ImmuneGO_General <- degs_sig %>%
  dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = ImmuneGO_genes_general, 
           geneset_name = "ImmuneGO General",
           minGSSize = input$minGSSize,
           maxGSSize = input$maxGSSize,
           pvalueCutoff = input$pvalueCutoff_gsea,
           pAdjustMethod = input$pAdjustMethod) 
})

# Render the DataTable
renderDT({
  req(input$go_2)
  req(gsea_results_ImmuneGO_General())
  gsea_results_ImmuneGO_General() %>% 
  datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```


### ImmuneGO specific
```{r}
# Perform GSEA

# Reactive expression to perform GSEA analyses
gsea_results_ImmuneGO_genes_specific <- reactive({
  req(input$go_2)
  req(degs_sig())
  
  degs_sig = degs_sig()
  
  # Perform ORA for ImmuneGO general
  degs_GSEA_ImmuneGO_genes_specific <- degs_sig %>%
  dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = ImmuneGO_genes_specific, 
           geneset_name = "ImmuneGO General",
           minGSSize = input$minGSSize,
           maxGSSize = input$maxGSSize,
           pvalueCutoff = input$pvalueCutoff_gsea,
           pAdjustMethod = input$pAdjustMethod) 
})

# Render the DataTable
renderDT({
  req(input$go_2)
  req(gsea_results_ImmuneGO_genes_specific())
  gsea_results_ImmuneGO_genes_specific() %>% 
  datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```



### CellMarker immune
```{r}
# Perform GSEA

# Reactive expression to perform GSEA analyses
gsea_results_CellMarker <- reactive({
  req(input$go_2)
  req(degs_sig())
  
  degs_sig = degs_sig()
  
  # Perform ORA for ImmuneGO general
  degs_GSEA_CellMarker <- degs_sig %>%
  dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = CellMarker_genes, 
           geneset_name = "CellMarker immune",
           minGSSize = input$minGSSize,
           maxGSSize = input$maxGSSize,
           pvalueCutoff = input$pvalueCutoff_gsea,
           pAdjustMethod = input$pAdjustMethod) 
})

# Render the DataTable
renderDT({
  req(input$go_2)
  req(gsea_results_CellMarker())
  gsea_results_CellMarker() %>% 
  datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```


### BTM immune
```{r}
# Perform GSEA

# Reactive expression to perform GSEA analyses
gsea_results_BTM_Immune  <- reactive({
  req(input$go_2)
  req(degs_sig())
  
  degs_sig = degs_sig()
  
  # Perform ORA for ImmuneGO general
  degs_GSEA_BTM_Immune <- degs_sig %>%
  dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = btm_genes, 
           geneset_name = "BTM Immune",
           minGSSize = input$minGSSize,
           maxGSSize = input$maxGSSize,
           pvalueCutoff = input$pvalueCutoff_gsea,
           pAdjustMethod = input$pAdjustMethod) 
})

# Render the DataTable
renderDT({
  req(input$go_2)
  req(gsea_results_BTM_Immune())
  gsea_results_BTM_Immune() %>% 
  datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```



### Vax MSigDB
```{r}
# Perform GSEA

# Reactive expression to perform GSEA analyses
gsea_results_VaxSigDB_Genes_filtered <- reactive({
  req(input$go_2)
  req(degs_sig())
  
  degs_sig = degs_sig()
  
  # Perform ORA for ImmuneGO general
  degs_GSEA_VaxSigDB_Genes_filtered <- degs_sig %>%
  dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = VaxSigDB_Genes_filtered, 
           geneset_name = "VaxSigDB Filtered",
           minGSSize = input$minGSSize,
           maxGSSize = input$maxGSSize,
           pvalueCutoff = input$pvalueCutoff_gsea,
           pAdjustMethod = input$pAdjustMethod) 
})

# Render the DataTable
renderDT({
  req(input$go_2)
  req(gsea_results_VaxSigDB_Genes_filtered())
  gsea_results_VaxSigDB_Genes_filtered() %>% 
  datatable(extensions = 'Buttons',

                            options = list(
                                paging = TRUE,
                                searching = TRUE,
                                fixedColumns = TRUE,
                                autoWidth = TRUE,
                                ordering = TRUE,
                                dom = 'Blfrtip',
                                buttons = c('copy', 'csv', 'excel')
                            ),

                            class = "display"
                       )
})
```