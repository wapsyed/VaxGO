---
title: "VaxGO - Wasim Syed (@wasimvacinas)"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#ffffff"
      fg: "#000000" 
      primary: "#ffffff"
      base_font:
        google: Montserrat
      code_font:
        google: Montserrat
    source_code: embed 
    navbar:
        - { icon: "fa-instagram", href: "https://instagram.com/wasimvacinas", align: right}
        - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/wapsyed", align: right}
runtime: shiny
orientation: columns
---

<style>
  body {
    font-size: 12px; /* Ajuste este valor conforme necessário */
  }
  
  .form-group,
  .shiny-input-container {
    font-size: 12x; /* Ajuste este valor conforme necessário */
  }
  
  .shiny-input-container input,
  .shiny-input-container select,
  .shiny-input-container textarea {
    font-size: 12px; /* Ajuste este valor conforme necessário */
  }
  
  .btn,
  .btn-primary {
    font-size: 12px; /* Ajuste este valor conforme necessário */
  }
  
  .table,
  .table th,
  .table td {
    font-size: 12px; /* Ajuste este valor conforme necessário */
  }
</style>



```{r setup, include=FALSE}

# Install packages ------
# install.packages("flexdashboard")
# install.packages("datasets")
# install.packages("knitr")
# devtools::install_github("rstudio/d3heatmap")
# install_github("jokergoo/InteractiveComplexHeatmap")
# install.packages("biclust")
# install.packages("BH")

# Call library ------
library(devtools)
library(GEOquery)
library(Matrix)
library(circlize)
library(RColorBrewer)
library(celldex)
library(biomaRt)
library(org.Hs.eg.db)
library(plotly)
library(DESeq2)
library(msigdbr)
library(ape)
library(GSVA)
library(sva)
library(clusterProfiler)
library(EnhancedVolcano)
library(ggbeeswarm)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(esquisse)
library(ComplexHeatmap)
library(janitor)
library(ggsci)
library(patchwork)
library(ggthemes)
library(here)
library(extrafont)
library(showtext)
library(readxl)
library(scales)
library(tidyverse)
library(flexdashboard)
library(ggheatmap)
library(vegan)
library(InteractiveComplexHeatmap)
library(corto)
library(ggstatsplot)
library(ImmuneSpaceR)
library(plotly)
library(flexdashboard)
library(datasets)
library(d3heatmap)
library(InteractiveComplexHeatmap)
library(biclust)
library(datasets)
library(DT)
library(ggthemes)
library(here)
library(tidyverse)
library(dplyr)
library("org.Hs.eg.db")
library(BH)
library(BiocManager)
options(repos = BiocManager::repositories())

```

# DEGs analysis

## Column {.sidebar data-width=300}

```{r}
#INPUTS

#https://shiny.posit.co/r/gallery/widgets/widget-gallery/ 

############## Upload files ############## 

textInput(inputId = "filename", 
          label = "Project title", 
          value = "my_condition_degs")


fileInput(inputId = "conditions_genes", 
          label = "Upload your DEGs L2FC",
           accept = ".csv")


fileInput(inputId = "annotation_conditions", 
          label = "Upload annotations",
           accept = ".csv")

checkboxGroupInput(inputId = "columns_annotation", 
                   label = "Select annotations", 
                   choices = NULL)

# Reactive expression to read the uploaded file
annotations <- reactive({
  req(input$annotation_conditions)
  read.csv(input$annotation_conditions$datapath)
})

# Observe the file input and update the checkbox group choices
observe({
  req(annotations())
  updateCheckboxGroupInput(session, "columns_annotation",
                           choices = names(annotations()))
})

tableOutput("selected_columns")

############## Filters 

# DGE analysis
numericInput(inputId = "filter_padj", 
             label = "Adjusted p-value cutoff", 
             value = 0.05, 
             min = 0, max = 1, step = 0.01)

numericInput(inputId = "filter_logfc", 
             label = "Log2 Fold Change cutoff", 
             value = 1, 
             min = 0, max = 10, step = 0.1)


actionButton("go_1", "Go")

```

## Column

### Genes table

```{r}

# Reactive expression to load and process the file
conditions_genes <- reactive({
  req(input$conditions_genes)
  
  # Load the file
  conditions_genes <- read.csv(input$conditions_genes$datapath)
  conditions_genes
})

# Reactive expression to filter significant DEGs
degs_sig <- reactive({
  req(conditions_genes(), input$filter_padj)
  
  degs_sig <- conditions_genes() %>%
    filter(padj < input$filter_padj)
  
  degs_sig
})

# Reactive expression to further filter DEGs and extract gene names
genes <- reactive({
  req(degs_sig())
  
  genes <- degs_sig() %>%
    filter(direction != "NEUTRAL") %>%
    pull(genes)
  
  genes
})

DT::renderDataTable({
  req(input$go_1) # Action button
  req(degs_sig())
  
  # Transform the filtered data into a DataTable
  degs_sig() %>% datatable(options = list(pageLength = 20))
})

```

## Column
### Volcano plot

Interactive
```{r}
###### Interativo, mas nao funciona
renderPlotly({
    req(input$go_1) # Action button
  req(conditions_genes())
  
  # Prepare the data
  data <- conditions_genes() %>%
    mutate(log_q = -log10(padj))
  
  # Create the volcano plot directly with plotly
  plot_ly(data, 
          x = ~ log2fold_change, 
          y = ~ log_q, 
          color = ~ log2fold_change, 
          colors = "RdBu",
          text = ~ genes,
          type = 'scatter', 
          mode = 'markers',
          marker = list(size = 10, colorbar = list(title = 'L2FC'))) %>%
    layout(
      title = "Volcano Plot",
      xaxis = list(title = "Log2 Fold Change"),
      yaxis = list(title = "-Log10 Adjusted P-value"),
      coloraxis = list(colorbar = list(title = 'L2FC')
      ))
})

```


# Over representation analysis

## Column {.sidebar data-width=300}

```{r}
#GSEA and ORA Parameters

# Tamanho mínimo e máximo do conjunto de genes (Gene Set Size)
numericInput(inputId = "minGSSize", 
             label = "Minimum Gene Set Size", 
             value = 1, 
             min = 1, max = 1000, step = 1)

numericInput(inputId = "maxGSSize", 
             label = "Maximum Gene Set Size", 
             value = 1000, 
             min = 1, max = 10000, step = 1)

# Cutoff GSEA
numericInput(inputId = "pvalueCutoff_gsea", 
             label = "GSEA p-value Cutoff", 
             value = 0.25, 
             min = 0, max = 1, step = 0.01)

# Multiple testing p-value adjustment method
selectInput(inputId = "pAdjustMethod", 
            label = "p-value Adjustment Method", 
            choices = c("BH", "BY", "fdr", "holm", "hochberg", "hommel", "bonferroni"),
            selected = "BH")

# Cutoffs ORA (Over-Representation Analysis)
numericInput(inputId = "pvalueCutoff_ora", 
             label = "ORA p-value Cutoff", 
             value = 0.05, 
             min = 0, max = 1, step = 0.01)

numericInput(inputId = "qvalueCutoff_ora", 
             label = "ORA q-value Cutoff", 
             value = 0.10, 
             min = 0, max = 1, step = 0.01)

# Multiple testing p-value adjustment method
selectInput(inputId = "organism", 
            label = "Organism", 
            choices = c("org.Hs.eg.db", "org.Mm.eg.db"),
            selected = "org.Hs.eg.db")


actionButton("go", "Go")

```

Please, be patient. It may take a while.


## Column {.tabset .tabset-fade}

```{r}
# Load data ------

########## Gene sets ------

######## IMMUNEGO -----
ImmuneGO_Annotated_GO <- read_csv(here("Tables", "ImmuneGO_Annotated_GO_2024-05-28.csv"))

ImmuneGO_annotation = ImmuneGO_Annotated_GO %>% 
  dplyr::select(process, immune_system:immune_tissue) 

ImmuneGO_genes_general = ImmuneGO_Annotated_GO %>% 
  separate_rows(genes, sep = ",") %>% 
  filter(go_term == "Manual",
         !process %in% c("ADAPTIVE IMMUNE SYSTEM",
                         "INNATE IMMUNE SYSTEM",
                         "BCR REPERTOIRE",
                         "TCR REPERTOIRE")) %>% 
  dplyr::select(process, genes)

ImmuneGO_genes_specific = ImmuneGO_Annotated_GO %>% 
  separate_rows(genes, sep = ",") %>% 
  filter(!go_term == "Manual") %>% 
  dplyr::select(process=gene_set_short, genes)

######## CELL MARKER IMMUNE ---------

CellMarker_ImmuneCells = read_csv(here("Tables", "CellMarker_ImmuneCells.csv"))
CellMarker_annotation = CellMarker_ImmuneCells %>% 
  dplyr::select(cell_name, Type) %>% 
  distinct()

CellMarker_genes = CellMarker_ImmuneCells %>% 
  dplyr::select(process = cell_name, genes = marker)

######## VAX MSIGDB --------
VaxSigDB_Gene_sets_Annotated_RAW <- read_csv(here("Tables", "VaxSigDB_Gene_sets_Annotated_RAW.csv"))

#Filters
vaxsig_columns = c("VACCINE", "PLATFORM", "TARGET_PATHOGEN_DISEASE", "MICROBE_TYPE", "STUDY_TYPE", "STUDY_SUBTYPE","DATE-TIME", "DATE", "TIME", "AGE", "AGE_CATEGORY", "SAMPLE_SOURCE", "SYSTEMATIC_NAME", "GENE_SYMBOLS")
filter_vaxsig_samplesource = "PBMC"
filter_vaxsig_studytype = "VACCINE"
filter_vaxsig_studysubtype = "VAC ONLY"

VaxSigDB_Genesets_filtered = VaxSigDB_Gene_sets_Annotated_RAW %>% 
  dplyr::select(vaxsig_columns) %>% 
  filter(SAMPLE_SOURCE == filter_vaxsig_samplesource,
         STUDY_TYPE == filter_vaxsig_studytype,
         STUDY_SUBTYPE == filter_vaxsig_studysubtype) 
#Annotation
VaxSigDB_annotation = VaxSigDB_Genesets_filtered %>% 
  mutate(process = paste0(VACCINE, " (", `DATE-TIME`, ", ", AGE, " YO)")) %>% 
  dplyr::select(process, PLATFORM, TARGET_PATHOGEN_DISEASE, MICROBE_TYPE, DATE, TIME)
#Genes
VaxSigDB_Genes_filtered = VaxSigDB_Genesets_filtered %>% 
  separate_rows(GENE_SYMBOLS, sep = ",") %>% 
  mutate(process = paste0(VACCINE, " (", `DATE-TIME`, ", ", AGE, " YO)")) %>% 
  dplyr::select(process, genes = GENE_SYMBOLS)

######## BTM MODULES --------
btm_annotation_table <- read_csv(here("Tables", "btm_annotation_immune_table_labelled.csv"))

#Filters
filter_btm_category = "immune"
filter_btm_annotationlevel = c("complete", "partial") #Anyone
# filter_btm_annotationlevel = "complete"
# filter_btm_annotationlevel = "partial"

#Annotation
btm_annotation = btm_annotation_table %>% 
  filter(module_category == filter_btm_category,
         annotation_level %in% filter_btm_annotationlevel) %>% 
  dplyr::select(immune_system, immune_subsystem, cells, composite_name)
#Genes
btm_genes = btm_annotation_table %>% 
  filter(module_category == filter_btm_category,
         annotation_level %in% filter_btm_annotationlevel) %>% 
  dplyr::select(process = composite_name, genes = module_member_genes) %>% 
  separate_rows(genes, sep = ",")

#Vaccine Atlas TERMINAR -----
# study <- CreateConnection("IS2")
# 
# dataset <- study$getDataset("demographics", original_view = FALSE)
# VaxAtlas_all_norm_eset <- readRDS(here("Tables", "VaxAtlas_all_norm_eset.rds"))
```

### General ORA
```{r}
#### General Gene ontologies
# Filter non-neutral DEGs
# Reactive expression to filter non-neutral DEGs
df <- reactive({
  req(degs_sig())
  degs_sig() %>%
    filter(direction != "NEUTRAL")
})

# Compute GO enrichment results
ora_results_general <- reactive({
  
  req(input$go) #Action button
  
  req(df())
  
  results <- list()
  
  for (condition_2 in unique(df()$condition)) {
    genes <- df() %>%
      filter(condition == condition_2) %>%
      pull(genes)
    
    go_enrich <- tryCatch({
      enrichGO(gene = genes,
               OrgDb = input$organism, 
               keyType = 'SYMBOL',
               readable = TRUE,
               ont = "BP",
               pvalueCutoff = input$pvalueCutoff_ora, 
               qvalueCutoff = input$qvalueCutoff_ora) %>%
        as.data.frame() %>%
        mutate(condition = condition_2)
    }, error = function(e) {
      return(NULL)
    })
    
    if (!is.null(go_enrich)) {
      results[[condition_2]] <- go_enrich   
    }
  }
  
  ora_results = bind_rows(results) %>%
    rownames_to_column("delete") %>%
    select(-"delete") %>%
    clean_names() 
  
  ora_results
  
})

# Display the final results
DT::renderDataTable({
  req(input$go) # Action button
  req(ora_results_general())
  ora_results_general() %>% datatable()
})

```

```{r include=FALSE}
# Function
autoORA <- function(df,
                    TERM2GENE,
                    pAdjustMethod, 
                    pvalueCutoff_ora, 
                    qvalueCutoff_ora,
                    geneset_name) {
  
  # Função interna para aplicar enricher a uma condição específica
  enricher_conditional <- function(condition_2, df, TERM2GENE, pAdjustMethod, pvalueCutoff_ora, qvalueCutoff_ora) {
    genes <- df %>% 
      filter(condition == condition_2) %>% 
      pull(genes)
    
    tryCatch({
      enricher(gene = genes,
               TERM2GENE = TERM2GENE,
               pAdjustMethod = pAdjustMethod,
               pvalueCutoff = pvalueCutoff_ora, 
               qvalueCutoff = qvalueCutoff_ora) %>% 
        as.data.frame() %>%
        mutate(condition = condition_2,
               geneset_name = geneset_name)
    }, error = function(e) {
      NULL
    })
  }
  
  # Aplicar a função interna a cada condição única e combinar os resultados
  ora_results <- df %>%
    distinct(condition) %>%
    pull(condition) %>%
    map_dfr(~ enricher_conditional(.x, df, TERM2GENE, pAdjustMethod, pvalueCutoff_ora, qvalueCutoff_ora))
  
  # Limpar os resultados finais
  ora_results_final <- ora_results %>%
    rownames_to_column("delete") %>%
    select(-"delete", -Description) %>%
    select(condition, geneset_name, everything()) %>% 
    clean_names() %>% 
    rename(process = id)
  
  return(ora_results_final)
}
```

### ImmuneGO General
```{r}
# Reactive expression to perform ORA analyses
ora_results_ImmuneGO_General <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_ImmuneGO_General <- df() %>%
    autoORA(TERM2GENE = ImmuneGO_genes_general,
            geneset_name = "ImmuneGO General",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_ImmuneGO_General())
  datatable(ora_results_ImmuneGO_General())
})
```

### ImmuneGO specific
```{r}
# Reactive expression to perform ORA analyses
ora_results_ImmuneGO_specific <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_ImmuneGO_specific <- df() %>%
    autoORA(TERM2GENE = ImmuneGO_genes_specific,
            geneset_name = "ImmuneGO Specific",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_ImmuneGO_specific())
  datatable(ora_results_ImmuneGO_specific())
})
```


### CellMarker immune
```{r}
# Reactive expression to perform ORA analyses
ora_results_Cellmarker_Immune <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_CellMarker_immune <- df() %>%
    autoORA(TERM2GENE = CellMarker_genes,
            geneset_name = "CellMarker Immune",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_Cellmarker_Immune())
  datatable(ora_results_Cellmarker_Immune())
})
```

### BTM immune
```{r}
# Reactive expression to perform ORA analyses
ora_results_BTM_Immune <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_BTM_immune <- df() %>%
    autoORA(TERM2GENE = btm_genes,
            geneset_name = "BTM Immune",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_BTM_Immune())
  datatable(ora_results_BTM_Immune())
})
```

### VAX MsigDB
```{r}
# Reactive expression to perform ORA analyses
ora_results_VAX_filtered <- reactive({
  req(input$go)
  req(df())
  
  # Perform ORA for ImmuneGO general
  degs_ORA_VAX_filtered <- df() %>%
    autoORA(TERM2GENE = VaxSigDB_Genes_filtered,
            geneset_name = "VAX SigDB filtered",
            pAdjustMethod = input$pAdjustMethod,
            pvalueCutoff_ora = input$pvalueCutoff_ora,
            qvalueCutoff_ora = input$qvalueCutoff_ora)
})

# Render the DataTable
renderDT({
  req(input$go)
  req(ora_results_VAX_filtered())
  datatable(ora_results_VAX_filtered())
})
```

Column {data-width=200}
-----------

### Download data (.csv)

####
```{r}
######## General ORA
output$download_ora_results_general = downloadHandler(
    filename = function() {
      # Use the filename input value and add the date
      paste("ORA_General_", input$filename, "_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(ora_results_general(), file, row.names = FALSE)
    }
  )


renderUI({downloadButton('download_ora_results_general', 
                         'General GOs', 
                         style="display: block; 
                         width: 20px; 
                         height: 20px;
                         color: white")})
```


####
```{r}
######## ImmuneGO General
output$download_ora_results_ImmuneGO_General = downloadHandler(
    filename = function() {
      # Use the filename input value and add the date
      paste("ORA_ImmuneGO_General_", input$filename, "_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(ora_results_ImmuneGO_General(), file, row.names = FALSE)
    }
  )


renderUI({downloadButton('download_ora_results_ImmuneGO_General', 
                         'ImmuneGO General', 
                         style="display: block; 
                         width: 20px; 
                         height: 20px;
                         color: white")})
```

####
```{r}
######## ImmuneGO specific
output$download_ora_results_ImmuneGO_specific = downloadHandler(
    filename = function() {
      # Use the filename input value and add the date
      paste("ORA_ImmuneGO_Specific_", input$filename, "_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(ora_results_ImmuneGO_specific(), file, row.names = FALSE)
    }
  )


renderUI({downloadButton('download_ora_results_ImmuneGO_specific', 
                         'ImmuneGO Specific', 
                         style="display: block; 
                         width: 20px; 
                         height: 20px;
                         color: white")})
```


####
```{r}
######## CellMarker Immune

#Download button
output$download_ora_results_Cellmarker_Immune= downloadHandler(
    filename = function() {
      # Use the filename input value and add the date
      paste("ORA_CellMarker_Immune_", input$filename, "_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(ora_results_Cellmarker_Immune(), file, row.names = FALSE)
    }
  )

renderUI({downloadButton('download_ora_results_Cellmarker_Immune', 
                         'CellMarker Immune', 
                         
                         style="display: block; 
                         width: 20px; 
                         height: 20px;
                         color: white")})
```


####
```{r}
######## BTM
output$download_ora_results_BTM_Immune = downloadHandler(
    filename = function() {
      # Use the filename input value and add the date
      paste("ORA_BTM_Immune_", input$filename, "_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(ora_results_BTM_Immune(), file, row.names = FALSE)
    }
  )


renderUI({downloadButton('download_ora_results_BTM_Immune', 
                         'BTM Immune', 
                         style="display: block; 
                         width: 20px; 
                         height: 20px;
                         color: white")})

```


####
```{r}
######## Vax Filtered

#Download button
output$download_ora_results_VAX_filtered= downloadHandler(
    filename = function() {
      # Use the filename input value and add the date
      paste("ORA_MSigDBVax_", input$filename, "_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      write.csv(ora_results_VAX_filtered(), file, row.names = FALSE)
    }
  )

renderUI({downloadButton('download_ora_results_VAX_filtered', 
                         'MSigDB Vax', 
                         
                         style="display: block; 
                         width: 20px; 
                         height: 20px;
                         color: white")})
```

