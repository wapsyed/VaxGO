---
title: "VaxGO_scripts"
author: "Wasim Aluisio Prates-Syed"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# 1. Packages

### CRAN packages

```{r eval=FALSE, include=FALSE, echo =FALSE}
#CRAN packages ----------------
# install.packages("ggrepel")
# install.packages("tidyverse")
# install.packages("org.Hs.eg.db")
# install.packages("RColorBrewer")
# install.packages("plotly")
# install.packages("gplots")
# install.packages("tidyverse")
# install.packages("corrr")
# install.packages("ggcorrplot")
# install.packages("FactoMineR")
# install.packages("factoextra")
# install.packages("esquisse")
# install.packages("corto")
# install.packages("flexdashboard")
# install.packages("ggheatmap")
# install.packages("devtools")
# install_github("jokergoo/InteractiveComplexHeatmap")
# install.packages("ggstatsplot")
# install.packages("circlize")
# install.packages("patchwork")
# install.packages("here")

```

### Bioconductor packages
```{r eval=FALSE, include=FALSE, echo =FALSE}
# # Bioconductor packages ------------------------
# install.packages("BiocManager")
# BiocManager::install("org.Hs.eg.db")
# BiocManager::install("deseq2")
# BiocManager::install("biomaRt")
# BiocManager::install("celldex")
# BiocManager::install("NMF")
# BiocManager::install("BiasedUrn")
# BiocManager::install("GSVA")
# BiocManager::install("sva")
# BiocManager::install("clusterProfiler")
# BiocManager::install("ggupset")
# BiocManager::install("msigdbr")
# BiocManager::install("EnhancedVolcano")
# BiocManager::install("AnnotationDbi")
# organism = "org.Hs.eg.db"
# BiocManager::install(organism, character.only = TRUE)
# library(organism, character.only = TRUE)
# BiocManager::install("ImmuneSpaceR")
```

### Load packages
```{r eval=FALSE, include=FALSE, echo =FALSE}
# Call packages -----------------
library(devtools)
library(circlize)
library(RColorBrewer)
library(org.Hs.eg.db)
library(plotly)
library(clusterProfiler)
# library(corrr)
# library(ggcorrplot)
# library(FactoMineR)
# library(factoextra)
library(esquisse)
library(ComplexHeatmap)
library(janitor)
library(ggsci)
library(patchwork)
library(ggthemes)
library(here)
library(readxl)
library(scales)
library(tidyverse)
library(flexdashboard)
library(vegan)
library(InteractiveComplexHeatmap)
library(corto)
```

# 2. Customize themes

## Create your own theme
```{r}
# Import fonts
font_add_google("Montserrat", "montserrat")
font_add_google("Bebas Neue", "bebas")
font_add_google("Arimo", "arimo")
font_add_google("Roboto", "roboto")
font_add_google("Libre Baskerville", "baskerville")
font_add_google("Playfair Display", "playfair")
font_add_google("Arimo", "arimo")
font_add_google("Merriweather", "merriweather")
showtext_auto()
showtext_opts(dpi = 300)


# Custom theme
theme_vaxgo <- function() {
  theme_minimal() +
  theme(
    text = element_text(color = "black", 
                        size = 12,
                        family = "arimo",
                        hjust = -1),
    plot.title = element_text(family = "montserrat",
                              size = 16,
                              face = "bold"),
    plot.subtitle = element_text(family = "arimo",
                                 size = 12),
    axis.text.y = element_text(hjust = 1,
                               color = "black"),
    axis.text.x = element_text(hjust = 0.5,
                               color = "black"),
    axis.title = element_text(size = 12),
    axis.title.x = element_text(hjust = 0.5),
    legend.title = element_text(face = "bold",
                                size = 10),
    legend.text = element_text(size = 8),
    legend.key.size = unit(0.4, 'cm'),
    axis.ticks = element_line(linewidth = 0.5),
    plot.background = element_rect(fill='white', colour='white'),
    plot.caption = element_text(hjust = 0,
                                family = "arimo"),
    panel.grid = element_line(linewidth = 0.1,
                              color = "grey97")
  )
}
```

## Custom palettes

```{r message=FALSE, warning=FALSE}

col_immune = c("ADAPTIVE" = "#bc3908",
          "B CELL" = "#e76f51",
          "HUMORAL" = "#ee8959",
          "IMMUNOGLOBULIN-MEDIATED"= "#f4a261",
          "CELLULAR" = "#e9c46a",
          "T CELLS" = "#ECDDA3",
          "T HELPER CELLS" = "#EDE9BF",
          "COMPLEMENT" = "#734f5a",
          "ANTIVIRAL & IFN" = "#D2E1DF",
          "ARPP" = "#BCD2CF",
          "DENDRITIC CELL" = "#1E5750",
          "EOSINOPHIL" = "#183431",
          "INFLAMMATION" = "#247A70",
          "INNATE" = "#2a9d8f",
          "MAST CELL" = "#A5C2BF",
          "MONOCYTE" = "#7CB6AF",
          "NEUTROPHIL" = "#264653",
          "NK CELL" = "#125961",
          "MACROPHAGE" = "#288C62",
          "GENERAL" = "#babd8d",
          "ANTIMICROBIAL" = "#219ebc"
  )

ann_vaxsig_colors = list(
  Platform = c("VLP" = "#7E6148FF",
           "LA" =  "#E64B35FF",
           "CONJ" = "#F39B7FFF", 
           'IN'= "#00A087FF", #1st Gen  vaccines
           'VV' = "#3C5488FF", #3rd Gen vaccines
           'RNA' = "#4DBBD5FF",
           'SU' = "#8491B4FF",
           'I'= "#DC0000FF",
           "H" = "grey95"),
  type = c("VLP" = "#7E6148FF",
           "LA" =  "#E64B35FF",
           "CONJ" = "#F39B7FFF", 
           'IN'= "#00A087FF", #1st Gen  vaccines
           'VV' = "#3C5488FF", #3rd Gen vaccines
           'RNA' = "#4DBBD5FF",
           'SU' = "#8491B4FF",
           'I'= "#DC0000FF",
           "H" = "grey95"),
  week = c("0" = "#ECF8FA",
           "1" = "#caf0f8",
           "2" = "#6CD5EA",
           "3" = "#0087BF",
           "4" = "#015BA0", 
           "6" = "#03045e",
           "7" = "#03045e",
           "8" = "#03045e"),
  month = c("1" = "#caf0f8",
            "0" = "#6CD5EA",
            "2" = "#015BA0"),
  dose = c(
    "0" = "grey95",
    "1" = "#91D1C2A0",
    "2" = "#00A087FF",
    "3" = "#3C5488FF"),
  date = c(
    "H" = "#F39B7FFF",
    "D" = "#DF8F44FF",
    "M" = "#7E6148FF",
    "ANY" = "black"),
  day = c(
    "0" = "white",
    "1" = "#caf0f8",
    "2" = "#ade8f4",
    "3" = "#90e0ef",
    "4" = "#6CD5EA",
    "5" = "#48cae4",
    "6" = "#00b4d8",
    "7" = "#0096c7",
    "10" = "#0087BF",
    "11" = "#0087BF",
    "14" = "#0077b6",
    "26" = "#015BA0",
    "28" = "#023e8a",
    "51" = "#03045e"),
  "Pathogen" = c('MENINGOCOCCUS'	= "#374E55FF",
                              'PNEUMOCOCCUS'	= "#697B7F",
                              'TUBERCULOSIS'	= "#9BA7AA",
                              'F TULARENSIS'	= "#CDD3D5",
                              'LEISHMANIA'	= "#DF8F44FF",
                              'MALARIA' = "#EFC7A2",
                              'EBOV'	= "#142F36",
                              'HBV'	= "#275E6B",
                              'HBV, HAV'	= "#275E6B",
                              'HIV'	= "#3A8DA0",
                              'HPV'	= "#4DBBD5",
                              'INFLUENZA'	= "#A6DDEA",
                              'MEASLES'	= "#D3EEF5",
                              'MMR'	= "#a2d2ff",
                              'SMALLPOX'	= "#bde0fe",
                              'VEEV'	= "#b8c0ff",
                              'VZV'	= "#94d2bd",
                              'YF'	= "#118ab2"),
  
  "Microbe type" = c("VIRUS" = "#4DBBD5FF",
                   'BACTERIUM' = "#374E55FF",
                   'PARASITE' = "#DF8F44FF"))



#Colors for Flourish
formatted_vector <- paste(names(col_immune), ":", col_immune) %>% 
  cat(., sep = "\n")
```


# 3. Data computation

## Upload files
```{r}
############## Upload files ############## 

#Specific conditions
all_covid_vax_atlas =  read_csv(here("Example","all_degs_p_05_vac_infected_19_12_23.csv"))
degs_all_updown_covid_vax_other = read_csv("Example/degs_all_updown_covid_vax_other.csv") %>% 
  select(-"...1")
ann_vaccines_vaxsig_covid <- read_csv("Example/ann_vaccines_vaxsig_covid.csv")

#Examples
example_condition = read_csv(here("Example","all_degs_p_05_vac_infected_19_12_23.csv")) %>%
  filter(condition == "BNT (V2, D1)")
example_condition %>%
  write_csv(file = here("Example", "Example_DEGs_BNT_V2_D1.csv"))

example_conditions = read_csv(here("Example","all_degs_p_05_vac_infected_19_12_23.csv")) %>%
  filter(vaccine == "BNT", regimen == "HO",disease_vac == "V",infection == 0)
example_conditions %>%
  write_csv(file = here("Example", "Example_DEGs_BNT_multiple.csv"))

example_conditions_allBNT = read_csv(here("Example","all_degs_p_05_vac_infected_19_12_23.csv")) %>%
  filter(vaccine == "BNT")
example_conditions_allBNT %>%
  write_csv(file = here("Example", "Example_DEGs_BNT_AllBNTs.csv"))


# Annotaions
ann_vaccines_samples <- read_csv(here("Example", "Example_annotations_samples.csv"), col_types = cols(`0` = col_skip()))
ann_vaccines_samples %>%
  write_csv(file = here("Example" , "Example_annotations_samples.csv"))


annotation_conditions = read_csv(here("Example", "ann_vaccines_conditions.csv"), 
    col_types = cols(...1 = col_skip()))
# annotation_conditions %>% 
#   write_csv(file = here("Example", "Example_annotations_conditions.csv"))


# Counts
normalized_counts_example = readRDS(here("Example", "all_matrices_normalized_counts.rds")) %>%
  rownames_to_column("genes")

normalized_counts_example %>% 
  write_csv(here("Example", "all_matrices_normalized_counts.csv"))

normalized_counts_example <- normalized_counts_example %>% 
  dplyr::select(genes, A02_0d:A37_7d) 

normalized_counts_example %>%
  write_csv(file = here("Example" , "Example_normalized_counts.csv"))
```
## Prepare gene sets
```{r}
########## Gene sets ------

######## IMMUNEGO
ImmuneGO_Annotated_GO <- read_csv(here("Tables", "ImmuneGO_Annotated_GO_2024-05-28.csv"))

ImmuneGO_annotation = ImmuneGO_Annotated_GO %>% 
 dplyr::select(process,immune_system:immune_tissue) 

ImmuneGO_genes_general = ImmuneGO_Annotated_GO %>% 
  separate_rows(genes, sep = ",") %>% 
  filter(go_term == "Manual",
         !process %in% c("ADAPTIVE IMMUNE SYSTEM",
                         "INNATE IMMUNE SYSTEM",
                         "BCR REPERTOIRE",
                         "TCR REPERTOIRE")) %>% 
 dplyr::select(process, genes)

ImmuneGO_genes_specific = ImmuneGO_Annotated_GO %>% 
  separate_rows(genes, sep = ",") %>% 
  filter(!go_term == "Manual") %>% 
 dplyr::select(process=gene_set_short, genes)

######## CELL MARKER IMMUNE ---------

CellMarker_ImmuneCells = readRDS(here("Tables", "CellMarker_ImmuneCells.rds"))

CellMarker_annotation = CellMarker_ImmuneCells %>% 
 dplyr::select(cell_name, Type) %>% 
  distinct()

CellMarker_genes = CellMarker_ImmuneCells %>% 
 dplyr::select(process = cell_name, genes = marker)

######## VAX MSIGDB --------
VaxSigDB_Gene_sets_Annotated_RAW <- read_csv(here("Tables", "VaxSigDB_Gene_sets_Annotated_RAW.csv"))

#Filters
vaxsig_columns = c("VACCINE", "PLATFORM", "TARGET_PATHOGEN_DISEASE", "MICROBE_TYPE", "STUDY_TYPE", "STUDY_SUBTYPE","DATE-TIME", "DATE", "TIME", "AGE", "AGE_CATEGORY", "SAMPLE_SOURCE", "SYSTEMATIC_NAME", "GENE_SYMBOLS")
filter_vaxsig_samplesource = "PBMC"
filter_vaxsig_studytype = "VACCINE"
filter_vaxsig_studysubtype = "VAC ONLY"

VaxSigDB_Genesets_filtered = VaxSigDB_Gene_sets_Annotated_RAW %>% 
 dplyr::select(vaxsig_columns) %>% 
  filter(SAMPLE_SOURCE == filter_vaxsig_samplesource,
         STUDY_TYPE == filter_vaxsig_studytype,
         STUDY_SUBTYPE == filter_vaxsig_studysubtype) 
#Annotation
VaxSigDB_annotation = VaxSigDB_Genesets_filtered %>% 
  mutate(process = paste0(VACCINE, " (", `DATE-TIME`, ", ", AGE, " YO)")) %>% 
 dplyr::select(process, PLATFORM, TARGET_PATHOGEN_DISEASE, MICROBE_TYPE, DATE, TIME)
#Genes
VaxSigDB_Genes_filtered = VaxSigDB_Genesets_filtered %>% 
  separate_rows(GENE_SYMBOLS, sep = ",") %>% 
  mutate(process = paste0(VACCINE, " (", `DATE-TIME`, ", ", AGE, " YO)")) %>% 
 dplyr::select(process, genes = GENE_SYMBOLS)

######## BTM MODULES --------
btm_annotation_table <- read_csv(here("Tables", "btm_annotation_immune_table_labelled.csv"))

#Filters
filter_btm_category = "immune"
filter_btm_annotationlevel = c("complete", "partial") #Anyone
# filter_btm_annotationlevel = "complete"
# filter_btm_annotationlevel = "partial"

#Annotation
btm_annotation = btm_annotation_table %>% 
  filter(module_category == filter_btm_category,
         annotation_level %in% filter_btm_annotationlevel) %>% 
 dplyr::select(immune_system, immune_subsystem, cells, composite_name)
#Genes
btm_genes = btm_annotation_table %>% 
  filter(module_category == filter_btm_category,
         annotation_level %in% filter_btm_annotationlevel) %>% 
 dplyr::select(process = composite_name, genes = module_member_genes) %>% 
  separate_rows(genes, sep = ",")



#Vaccine Atlas
# study <- CreateConnection("IS2")
# 
# dataset <- study$getDataset("demographics", original_view = FALSE)
# VaxAtlas_all_norm_eset <- readRDS(here("Tables", "VaxAtlas_all_norm_eset.rds"))
# 
# view(VaxAtlas_all_norm_eset)


```


## Inputs
```{r}
######### INPUTS ######### 

# Select data
annotation_conditions = ann_vaccines_vaxsig_covid
example_conditions = degs_all_updown_covid_vax_other

# Select columns for annotation
columns_annotation = c("condition", 
                       "day", 
                       "week", 
                       "dose", 
                       "type", 
                       "disease_vac")

#Name your outputs
filename = "degs_all_updown_covid_vax_other"

############## Filters ############## 
filter_padj = 0.05
filter_logfc = 1
#GSEA and ORA parameters
minGSSize = 1
maxGSSize = 1000
pvalueCutoff_gsea= 0.25
pAdjustMethod = "BH"
pvalueCutoff_ora = 0.05
qvalueCutoff_ora = 0.10
```


## Calculate auto overlap (Multiple conditions)

### Prepare table

#### With L2FC values
```{r}
example_condition
example_conditions
example_conditions_allBNT

#DEGs table 
# Only significant
degs_sig = example_conditions %>% 
  filter(padj < filter_padj,
         log2fold_change > filter_logfc | log2fold_change < -filter_logfc)

degs_sig_example = example_conditions %>% 
  filter(padj < filter_padj,
         log2fold_change > filter_logfc | log2fold_change < -filter_logfc)

# Only up and down
data = example_conditions %>% 
  filter(padj < filter_padj,
         log2fold_change > filter_logfc | log2fold_change < -filter_logfc) %>% 
 dplyr::select(process = condition, genes)

# Data for enrichment analyses
degs = degs_sig_example
df <- degs %>% 
  filter(direction != "NEUTRAL")
genes <- df %>% pull(genes)

```

#### Without L2FC values
```{r}
#DEGs table 
# Only significant
degs_sig = example_conditions

degs_sig_example = example_conditions

# Only up and down
data = example_conditions %>% 
  rename(process = condition)

# Data for enrichment analyses
degs = degs_sig_example
df <- degs
genes <- df %>% pull(genes)

```

### Function for overlapping
```{r}

# Function for overlapping -------
overlap_genes <- function(cond1, cond2, data) {
  genes_cond1 <- data$genes[data$process == cond1]
  genes_cond2 <- data$genes[data$process == cond2]
  
  genes_shared <- intersect(genes_cond1, genes_cond2)
  
  genes_notshared_cond1 <- setdiff(genes_cond1, genes_cond2)
  genes_notshared_cond2 <- setdiff(genes_cond2, genes_cond1)
  
  total_genes_cond1 <- length(genes_cond1)
  total_genes_cond2 <- length(genes_cond2)
  
  percentage_shared_cond1 <- length(genes_shared) / total_genes_cond1 * 100
  percentage_shared_cond2 <- length(genes_shared) / total_genes_cond2 * 100
  
  shared_genes <- data.frame(
    Cond1 = cond1,
    Cond2 = cond2,
    Shared = length(genes_shared),
    NotShared_cond1 = length(genes_notshared_cond1),
    NotShared_cond2 = length(genes_notshared_cond2),
    Total_Genes_Cond1 = total_genes_cond1,
    Total_Genes_Cond2 = total_genes_cond2,
    Genes_Names = paste(genes_shared, collapse = ", "),
    Percentage_Shared_Cond1 = percentage_shared_cond1,
    Percentage_Shared_Cond2 = percentage_shared_cond2
  )
  
  return(shared_genes)
}

```

### Perform calculations
```{r}
# Perform calculations
unique_cond <- unique(data$process) # List sets
shared_genes_df <- data.frame() # Store data

for (i in 1:(length(unique_cond) - 1)) {
  for (j in (i + 1):length(unique_cond)) {
    resultado_temp <- overlap_genes(unique_cond[i], unique_cond[j], data)
    shared_genes_df <- bind_rows(shared_genes_df, resultado_temp)
  }
}

# Fisher's exact test
fisher_exact_test <- function(shared, notshared1, notshared2) {
  cont_table <- matrix(c(shared, notshared1, notshared2, 0), nrow = 2)
  results_fisher <- fisher.test(cont_table)
  return(results_fisher$p.value)
}
shared_genes_df = shared_genes_df %>%
  mutate(pvalue = pmap_dbl(list(Shared, NotShared_cond1, NotShared_cond2), fisher_exact_test)) %>% 
  mutate("-log(p)" = -log10(pvalue))


#Mirror table
shared_genes_df2 = shared_genes_df %>% 
  rename(Cond1_temp = Cond1, Cond2_temp = Cond2) %>%
  rename(Cond1 = Cond2_temp, Cond2 = Cond1_temp)

shared_genes_df_mirror = shared_genes_df %>% 
  bind_rows(shared_genes_df2) %>% 
  mutate(Percentage_Shared_Cond1 = round(Percentage_Shared_Cond1, 2),
         Percentage_Shared_Cond2 = round(Percentage_Shared_Cond2, 2))
  
#Jaccard distance
jaccard.matrix <- data %>%
  mutate(present = 1) %>% 
  distinct() %>% 
  pivot_wider(names_from = genes, values_from = present, values_fill = 0) %>%
  column_to_rownames(var = "process") %>%
  vegdist(binary = TRUE, method = "jaccard", diag = TRUE, upper = TRUE) %>%
  as.matrix() %>%
  {1 - .}

shared_genes_df_mirror = jaccard.matrix %>% 
  as.data.frame() %>% 
  rownames_to_column("Cond1") %>% 
  pivot_longer(cols = -"Cond1",
               names_to = "Cond2",
               values_to = "jaccard_distance") %>% 
  inner_join(shared_genes_df_mirror, by = join_by(Cond1, Cond2)) %>% 
  mutate(jaccard_distance = round(jaccard_distance, 3))

#Save
write_csv(shared_genes_df_mirror, 
          file = here("Example", paste0(filename, "_sharedgenes_Fisher_Jaccard.csv")))
```








## Gene set enrichment analysis (ORA and GSEA)


### Over-representation analysis (ORA)

#### General Gene ontologies
```{r}
# Filter non-neutral DEGs
df <- degs %>% 
  filter(direction != "NEUTRAL")

ora_results <- list()

for (condition_2 in unique(df$condition)) {

    genes <- df %>% 
    filter(condition == condition_2) %>% 
    pull(genes)

  go_enrich <- tryCatch({
    enrichGO(gene = genes,
             OrgDb = organism, 
             keyType = 'SYMBOL',
             readable = T,
             ont = "BP",
             pvalueCutoff = pvalueCutoff_ora, 
             qvalueCutoff = qvalueCutoff_ora) %>% 
      as.data.frame() %>%
      mutate(condition = condition_2)
  }, error = function(e) {
    return(NULL)
  })

  if (!is.null(go_enrich)) {
    ora_results[[condition_2]] <- go_enrich   
  }
}

ora_results_final <- bind_rows(ora_results) %>% 
  rownames_to_column("delete") %>% 
 dplyr::select(-"delete") %>% 
  clean_names()

#Save
write_csv(ora_results_final, file = here("Example", paste0(filename, "_allGOs_ORA.csv")))

ora_results_final
```

#### VaxGO ORA

##### Function
```{r}
# Function
autoORA <- function(df,
                    TERM2GENE,
                    pAdjustMethod, 
                    pvalueCutoff_ora, 
                    qvalueCutoff_ora,
                    geneset_name) {
  
  # Função interna para aplicar enricher a uma condição específica
  enricher_conditional <- function(condition_2, df, TERM2GENE, pAdjustMethod, pvalueCutoff_ora, qvalueCutoff_ora) {
    genes <- df %>% 
      filter(condition == condition_2) %>% 
      pull(genes)
    
    tryCatch({
      enricher(gene = genes,
               TERM2GENE = TERM2GENE,
               pAdjustMethod = pAdjustMethod,
               pvalueCutoff = pvalueCutoff_ora, 
               qvalueCutoff = qvalueCutoff_ora) %>% 
        as.data.frame() %>%
        mutate(condition = condition_2,
               geneset_name = geneset_name)
    }, error = function(e) {
      NULL
    })
  }
  
  # Aplicar a função interna a cada condição única e combinar os resultados
  ora_results <- df %>%
    distinct(condition) %>%
    pull(condition) %>%
    map_dfr(~ enricher_conditional(.x, df, TERM2GENE, pAdjustMethod, pvalueCutoff_ora, qvalueCutoff_ora))
  
  # Limpar os resultados finais
  ora_results_final <- ora_results %>%
    rownames_to_column("delete") %>%
   dplyr::select(-"delete", -Description) %>%
   dplyr::select(condition, geneset_name, everything()) %>% 
    clean_names() %>% 
    rename(process = id)
  
  return(ora_results_final)
}
```

##### Perform ORA
```{r}
#Perform ORA

#ImmuneGO general
degs_ORA_ImmuneGO_General <- df %>%
  autoORA(TERM2GENE = ImmuneGO_genes_general,
          geneset_name = "ImmuneGO General",
          pAdjustMethod,
          pvalueCutoff_ora,
          qvalueCutoff_ora) 

#ImmuneGO specific
degs_ORA_ImmuneGO_Specific<- df %>% 
  autoORA(TERM2GENE = ImmuneGO_genes_specific,
          geneset_name = "ImmuneGO specific",
          pAdjustMethod = pAdjustMethod,
          pvalueCutoff_ora = pvalueCutoff_ora,
          qvalueCutoff_ora = qvalueCutoff_ora)


#CellMarker immune
degs_ORA_Cellmarker_Immune<- df %>% 
  autoORA(TERM2GENE = CellMarker_genes,
          geneset_name = "CellMarker immune",
          pAdjustMethod = pAdjustMethod,
          pvalueCutoff_ora = pvalueCutoff_ora,
          qvalueCutoff_ora = qvalueCutoff_ora) 

#BTM immune
degs_ORA_BTM_Immune<- df %>% 
  autoORA(TERM2GENE = btm_genes,
          geneset_name = "BTM immune",
          pAdjustMethod = pAdjustMethod,
          pvalueCutoff_ora = pvalueCutoff_ora,
          qvalueCutoff_ora = qvalueCutoff_ora)

#MSigDB VAX filtered
degs_ORA_VAX_filtered<- df %>% 
  autoORA(TERM2GENE = VaxSigDB_Genes_filtered,
          geneset_name = "VAX SigDB filtered",
          pAdjustMethod = pAdjustMethod,
          pvalueCutoff_ora = pvalueCutoff_ora,
          qvalueCutoff_ora = qvalueCutoff_ora)

#Unite all
degs_ORA_ready = bind_rows(degs_ORA_ImmuneGO_General,
                            degs_ORA_ImmuneGO_Specific,
                            degs_ORA_Cellmarker_Immune,
                            degs_ORA_BTM_Immune,
                            degs_ORA_VAX_filtered)

#Save
write_csv(degs_ORA_ready, 
          file = here("Example", paste0(filename, "_ORA_VAXGO_", today(), ".csv")))

view(degs_ORA_ready)
```


```{r}
data <- degs_ORA_BTM_Immune %>%
    group_by(condition) %>%
    arrange(condition, desc(-log(qvalue))) %>% 
    slice_head(n = 5) %>%
    ungroup() %>%
  drop_na(qvalue) %>% 
    mutate(process = fct_reorder(process, -log(qvalue)))  # Reordenar o processo
  
  num_conditions <- data %>%
    distinct(condition) %>%
    nrow()
  
  ggplot(data) +
    aes(x = -log(qvalue), y = process) +
    geom_col() +
    facet_wrap(~condition, scales = "free_x", nrow = num_conditions) +
    labs(x = "-log10(q-value)", y = "Process", title = "ORA Results") +
    theme_minimal()


```

### Gene set enrichment analysis (GSEA)

#### VaxGO
##### Function
```{r}
#Function
autoGSEA <- function(df, TERM2GENE, 
                     geneset_name, 
                     minGSSize, 
                     maxGSSize,
                     pvalueCutoff,
                     pAdjustMethod) {
  results <- list()

  condicoes <- df$condition %>% 
    unique() %>% 
    as.character()

  for (condicao in condicoes) {
    degs_condicao <- df %>% 
      filter(condition == condicao) %>%
     dplyr::select(genes, log2fold_change) %>%
      distinct() %>%
      mutate(rank = rank(log2fold_change, ties.method = "random")) %>%
      arrange(desc(rank))
    gene_list_lf2c <- as.vector(degs_condicao$log2fold_change)
    names(gene_list_lf2c) <- degs_condicao$genes
    gene_list_lf2c <- na.omit(gene_list_lf2c)
    gene_list_lf2c <- sort(gene_list_lf2c, decreasing = TRUE)

    auto_gsea <- tryCatch({
      GSEA(geneList = gene_list_lf2c,
           TERM2GENE = TERM2GENE,
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff,
           pAdjustMethod = pAdjustMethod) %>%
        as.data.frame() %>%
        arrange(qvalue) %>%
        mutate(condition = condicao,
               gsea_enrichment = geneset_name)
    }, error = function(e) {
      return(NULL)
    })

    if (!is.null(auto_gsea)) {
      results[[paste(condicao, geneset_name, sep = "_")]] <- auto_gsea
    }
  }
  
  final_result <- bind_rows(results) %>%
    rename(process = ID) %>% 
    rownames_to_column("delete") %>%
   dplyr::select(-"delete", -Description) %>%
    clean_names() %>% 
       dplyr::select(condition, everything()) 

  return(final_result)
}
```


##### Perform GSEA

```{r}
# Perform GSEA
#ImmuneGO general
degs_GSEA_ImmuneGO_General <- degs %>%
 dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = ImmuneGO_genes_general, 
           geneset_name = "ImmuneGO General",
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff_gsea,
           pAdjustMethod = pAdjustMethod) 

#ImmuneGO specific
degs_GSEA_ImmuneGO_Specific<- degs %>%
 dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = ImmuneGO_genes_specific, 
           geneset_name = "ImmuneGO specific",
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff_gsea,
           pAdjustMethod = pAdjustMethod)


#CellMarker immune
degs_GSEA_Cellmarker_Immune<- degs %>%
 dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = CellMarker_genes, 
           geneset_name = "CellMarker immune",
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff_gsea,
           pAdjustMethod = pAdjustMethod) 

#BTM immune
degs_GSEA_BTM_Immune<- degs %>%
 dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = btm_genes, 
           geneset_name = "BTM immune",
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff_gsea,
           pAdjustMethod = pAdjustMethod) 

#MSigDB VAX filtered
degs_GSEA_VAX_filtered<- degs %>%
 dplyr::select(condition, genes, log2fold_change) %>% 
  autoGSEA(TERM2GENE = VaxSigDB_Genes_filtered, 
           geneset_name = "VAX SigDB filtered",
           minGSSize = minGSSize,
           maxGSSize = maxGSSize,
           pvalueCutoff = pvalueCutoff_gsea,
           pAdjustMethod = pAdjustMethod) 

#Unite all
degs_GSEA_ready = bind_rows(degs_GSEA_ImmuneGO_General,
                            degs_GSEA_ImmuneGO_Specific,
                            degs_GSEA_Cellmarker_Immune,
                            degs_GSEA_BTM_Immune,
                            degs_GSEA_VAX_filtered)

#Save
write_csv(degs_GSEA_ready, 
          file = here("Example", paste0(filename, "_GSEA_VAXGO_", today(), ".csv")))

view(degs_GSEA_ready)

```

### Single sample GSEA (ssGSEA)

#### VaxGO
```{r}
#Import files
ann_vaccines_samples_example <- read_csv(here("Example", "Example_annotations_samples.csv"),      
                                 col_types = cols(`0` = col_skip()))

normalized_counts_example <- readRDS(here("Example", "all_matrices_normalized_counts.rds")) %>% 
  dplyr::select(A02_0d:A37_7d)

normalized_counts_example_all <- readRDS(here("Example", "all_matrices_normalized_counts.rds"))

normalized_counts_example %>%
  rownames_to_column("genes") %>% 
  write_csv(file = here("Example" , "Example_normalized_counts.csv"))


############## Inputs

ssgsea_gene = normalized_counts_example_all 
metadata = ann_vaccines_samples 
filename = "my_condition"
go_dataset = "ImmuneGO"

#Extract sample names
sample_names = ssgsea_gene %>% 
  as.data.frame() %>% 
  colnames() %>% 
  as.data.frame() %>% 
  rename(sample_names = '.')
```

##### Perform ssGSEA
```{r}
#ImmuneGO General -------
genelist_immunego_general = ImmuneGO_genes_general %>%
 dplyr::select(process, genes) %>% 
  filter(!process %in% c("TCR REPERTOIRE", "BCR REPERTOIRE"))
genelist_immunego_general = split(genelist_immunego_general$genes, genelist_immunego_general$process) 

nesmat_result_immunego_general = ssgsea(inmat = ssgsea_gene, 
                                        groups = genelist_immunego_general) %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  relocate(sample, .before = everything()) %>% 
  cbind(sample_names) %>% 
 dplyr::select(-sample) %>% 
  column_to_rownames("sample_names") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  relocate(process, .before=everything()) %>% 
  pivot_longer(cols = -process, names_to = "sample", values_to = "nes") %>%
  mutate(pvalue = z2p(nes), #Convert NES into pvalue
         qvalue = p.adjust(pvalue, method = "BH"),
         logq = - log10(qvalue),
         geneset_name = "ImmuneGO General") %>%
  merge(metadata, by= "sample", all.x=T) %>%
  merge(ImmuneGO_genes_general, by = "process", all.x=T) %>% 
 dplyr::select(!genes) %>% 
  distinct()

#ImmuneGO Specific -------
genelist_immunego_specific = ImmuneGO_genes_specific %>%
 dplyr::select(process, genes)

genelist_immunego_specific = split(genelist_immunego_specific$genes, genelist_immunego_specific$process) 

nesmat_result_immunego_specific = ssgsea(inmat = ssgsea_gene, 
                                        groups = genelist_immunego_specific) %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  relocate(sample, .before = everything()) %>% 
  cbind(sample_names) %>% 
 dplyr::select(-sample) %>% 
  column_to_rownames("sample_names") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  relocate(process, .before=everything()) %>% 
  pivot_longer(cols = -process, names_to = "sample", values_to = "nes") %>%
  mutate(pvalue = z2p(nes), #Convert NES into pvalue
         qvalue = p.adjust(pvalue, method = "BH"),
         logq = - log10(qvalue),
         geneset_name = "ImmuneGO specific") %>%
  inner_join(metadata, by= "sample") %>%
  inner_join(ImmuneGO_genes_specific, by = "process") %>% 
 dplyr::select(!genes) %>% 
  distinct()



#CellMarker immune-------
genelist_CellMarker_genes = CellMarker_genes %>%dplyr::select(process, genes)
genelist_CellMarker_genes = split(genelist_CellMarker_genes$genes, genelist_CellMarker_genes$process) 

nesmat_result_CellMarker = ssgsea(inmat = ssgsea_gene, 
                                        groups = genelist_CellMarker_genes) %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  relocate(sample, .before = everything()) %>% 
  cbind(sample_names) %>% 
 dplyr::select(-sample) %>% 
  column_to_rownames("sample_names") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  relocate(process, .before=everything()) %>% 
  pivot_longer(cols = -process, names_to = "sample", values_to = "nes") %>%
  mutate(pvalue = z2p(nes), #Convert NES into pvalue
         qvalue = p.adjust(pvalue, method = "BH"),
         logq = - log10(qvalue),
         geneset_name = "CellMarker Immune") %>%
  inner_join(metadata, by= "sample") %>%
  inner_join(CellMarker_genes, by = "process") %>% 
 dplyr::select(!genes) %>% 
  distinct()


#BTM immune-------
genelist_btm_genes = btm_genes %>%dplyr::select(process, genes)
genelist_btm_genes = split(genelist_btm_genes$genes, genelist_btm_genes$process) 

nesmat_result_BTM = ssgsea(inmat = ssgsea_gene, 
                                        groups = genelist_btm_genes) %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  relocate(sample, .before = everything()) %>% 
  cbind(sample_names) %>% 
 dplyr::select(-sample) %>% 
  column_to_rownames("sample_names") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  relocate(process, .before=everything()) %>% 
  pivot_longer(cols = -process, names_to = "sample", values_to = "nes") %>%
  mutate(pvalue = z2p(nes), #Convert NES into pvalue
         qvalue = p.adjust(pvalue, method = "BH"),
         logq = - log10(qvalue),
         geneset_name = "BTM Immune") %>%
  inner_join(metadata, by= "sample") %>%
  inner_join(btm_genes, by = "process") %>% 
 dplyr::select(!genes) %>% 
  distinct()

#VAX MSigDB selected-------
genelist_VaxSigDB_Genes = VaxSigDB_Genes_filtered %>%dplyr::select(process, genes)
genelist_VaxSigDB_Genes = split(genelist_VaxSigDB_Genes$genes, genelist_VaxSigDB_Genes$process) 

nesmat_result_VaxSigDB = ssgsea(inmat = ssgsea_gene, 
                                        groups = genelist_VaxSigDB_Genes) %>% 
  as.data.frame() %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("sample") %>% 
  relocate(sample, .before = everything()) %>% 
  cbind(sample_names) %>% 
 dplyr::select(-sample) %>% 
  column_to_rownames("sample_names") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("process") %>% 
  relocate(process, .before=everything()) %>% 
  pivot_longer(cols = -process, names_to = "sample", values_to = "nes") %>%
  mutate(pvalue = z2p(nes), #Convert NES into pvalue
         qvalue = p.adjust(pvalue, method = "BH"),
         logq = - log10(qvalue),
         geneset_name = "VaxSigDB") %>%
  inner_join(metadata, by= "sample") %>%
  inner_join(VaxSigDB_Genes_filtered, by = "process") %>% 
 dplyr::select(!genes) %>% 
  distinct()


# Unite all
nesmat_result_all = bind_rows(nesmat_result_immunego_general,
                              nesmat_result_immunego_specific,
                              nesmat_result_CellMarker,
                              nesmat_result_BTM,
                              nesmat_result_VaxSigDB)



#save
write.csv(nesmat_result_all, file = here("Example", paste0(filename, sep = "_", go_dataset, "_ssgsea_results.csv")))

head(nesmat_result_all)
```

```{r fig.height=10, fig.width=10}
nesmat_result_immunego_general %>% 
  mutate(process = case_when(process == "CELLULAR ADAPTIVE IMMUNE SYSTEM" ~ "CELLULAR ADAP",
                             process == "HUMORAL ADAPTIVE IMMUNE SYSTEM" ~ "HUMORAL ADAP",
                             process == "IMMUNOGLOBULIN MEDIATED RESPONSE	" ~ "IMMUNOGLOBULIN",
                             .default = process)) %>% 
  ggplot() +
  aes(x = condition, y = nes, fill = condition) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Accent", direction = 1) +
  ggthemes::theme_few() +
  theme(
    legend.position = "top",
    axis.text.x = element_text(size = 0L)
  ) +
  facet_wrap(vars(process), scales = "free") +
  ggsci::scale_fill_npg()
```


```{r fig.height=5, fig.width=5}
#PCA -----
# install.packages("ggfortify")
# library(ggfortify)
nesmat_result_immunego_general_matrix = nesmat_result_immunego_general %>% 
  dplyr::select(sample, process, nes) %>% 
  pivot_wider(names_from = "process",
              values_from = "nes") %>% 
    column_to_rownames("sample")

labels = nesmat_result_immunego_general_matrix %>% 
  rownames_to_column("sample") %>% 
  inner_join(nesmat_result_immunego_general %>% 
               dplyr::select(sample, condition, type, day, week) %>% distinct(),
               by = "sample") 

pca_res <- prcomp(nesmat_result_immunego_general_matrix, scale. = TRUE)

ssgsea_pca_type = autoplot(pca_res,  data = labels) +
  geom_point(aes(fill = type, label = condition), colour="black",pch=21, size = 3) +
  theme_few()+
  scale_fill_manual(values = ann_vaxsig_colors$Platform)

ssgsea_pca_day = autoplot(pca_res,  data = labels) +
  geom_point(aes(fill = day), colour="black",pch=21, size = 3) +
  theme_few()+
  scale_fill_stepsn(colors = c(
    "0" = "white",
    "1" = "#caf0f8",
    "2" = "#0087BF",
    "3" = "#90e0ef",
    "4" = "#6CD5EA",
    "5" = "#48cae4",
    "6" = "#00b4d8",
    "7" = "#0096c7",
    "10" = "#0087BF",
    "11" = "#0087BF",
    "14" = "#0077b6",
    "26" = "#015BA0",
    "28" = "#023e8a",
    "51" = "#03045e"))

```


# 4. Data visualization

### Volcano plot

```{r}
plot_volcano = conditions_genes %>% 
  mutate(log_q = -log10(padj)) %>% 
   filter(condition %in% "BNT (V2, D1)") %>%
 ggplot() +
  aes(x = log2fold_change, y = log_q, colour = log2fold_change, label = genes) +
  geom_point()  +
  theme_ggstatsplot() +
  theme(legend.position = "top") +
  facet_wrap(vars(condition)) +
  labs(title = "Volcano plot",
       color = "L2FC") +
  scale_colour_gradient2()

plot_volcano

ggplotly(plot_volcano)
```

### Chord diagram

#### Shared
```{r}
#Filters 
filter_shared = 1
filter_pvalue = 0.10
color_flourish = "type"

# Create table for flourish
shared_genes_df_mirror %>% 
  filter(Shared > filter_shared,
         pvalue < filter_pvalue) %>% 
 dplyr::select(Cond1, Cond2, Shared, Total_Genes_Cond1, Percentage_Shared_Cond1, pvalue:"-log(p)") %>% 
  write_csv(file = here("Example",  paste0(filename,"_Flourish_Circos_Links.csv")))

library(chorddiag)

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
all_shared = chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
all_shared
```

```{r}
matrix_vaccines_week1 <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines_week1 %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
week1 = chorddiag(matrix_vaccines_week1,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
week1
```


##### Weeks
Prepare tables
```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 7 ------
links_df_W7 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_week7 = links_df_W7 %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w7 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w7 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```
Plot
```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 7
chordDiagram(mat_week7, grid.col = grid.col_w7, 
             annotationTrack = "grid", 
            big.gap = 50,
             group = group_w7,
             small.gap = 3,
             link.zindex = rank(mat_week7),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week7))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 7")

dev.off()
circos.clear()

```

##### Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, Shared)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "Shared", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

png(filename = here("Figures","ChordDiagram_Covid19_Types_All.png"), 
    width = 5, height = 5, units = "in", res = 300)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 10,
             small.gap = 3,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state
```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 50,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```


#### Jaccard distance
##### Interactive
```{r}

shared_genes_df_mirror = All_covid_sharedgenes_Fisher_Jaccard

matrix_vaccines <- shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance) %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

types = shared_genes_df_mirror %>% 
  dplyr::select(condition = Cond1) %>% 
  distinct() %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "condition") %>% 
  dplyr::select(type)

colors = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column("type") %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(condition, type), by = "type") %>% 
  inner_join(matrix_vaccines %>% 
               as.data.frame() %>% 
               colnames() %>% as.data.frame() %>% rename(condition = "."),
             by = "condition") %>% 
  pull(color)

# Build the chord diagram:
chorddiag(matrix_vaccines,
          groupColors = colors,
          type = "directional",
          width = NULL,
          height = NULL,
          margin = 100,
          showGroupnames = TRUE,
          groupThickness = 0.1,
          groupPadding = 2,
          groupnamePadding = 1,
          groupnameFontsize = 10,
          groupedgeColor = NULL,
          chordedgeColor = NULL,
          categoryNames = NULL,
          categorynamePadding = 100,
          categorynameFontsize = 28,
          showTicks = TRUE,
          tickInterval = NULL,
          ticklabelFontsize = 10,
          fadeLevel = 0.1,
          showTooltips = TRUE,
          showZeroTooltips = TRUE,
          tooltipNames = NULL,
          tooltipUnit = NULL,
          tooltipFontsize = 12,
          tooltipGroupConnector = " &#x25B6; ",
          precision = NULL,
          clickAction = NULL,
          clickGroupAction = NULL
)
```

##### Static
Prepare tables
```{r fig.height=5, fig.width=5}
#Week 1 ------
links_df_W1 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 1) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week1 = links_df_W1 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()
grid.col_w1 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)
group_w1 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W1,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 2 ------
links_df_W2 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 2) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week2 = links_df_W2 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w2 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w2 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W2,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)


#Week 4 ------
links_df_W4 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 4) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week4 = links_df_W4 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w4 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w4 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W4,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Week 7 ------
links_df_W7 = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(week == 7) %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_week7 = links_df_W7 %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(Shared = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_w7 = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_w7 = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_W7,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

```


Plot
```{r fig.height= 5, fig.width=10}
#Plot
png(filename = here("Figures","ChordDiagram_Covid19_Weeks_1-2-4-7_jaccard.png"), 
    width = 12, height = 14, units = "in", res = 300)

par(mfrow = c(2, 2))
#WEEK 1
chordDiagram(mat_week1, 
             grid.col = grid.col_w1, 
             annotationTrack = "grid", 
             directional = -1,
             big.gap = 6,
             transparency = 0,
             small.gap = 3,
             link.zindex = rank(mat_week1),
             h.ratio = 0.7, 
             group = group_w1,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week1))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},#Label face
  bg.border = NA) 
title("Week 1")

# WEEK 2
chordDiagram(mat_week2, grid.col = grid.col_w2, 
             annotationTrack = "grid", 
            big.gap = 6,
             group = group_w2,
             small.gap = 3,
             link.zindex = rank(mat_week2),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week2))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 2")


# WEEK 4
chordDiagram(mat_week4, grid.col = grid.col_w4, 
             annotationTrack = "grid", 
            big.gap = 6,
             group = group_w4,
             small.gap = 3,
             link.zindex = rank(mat_week4),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week4))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 4")

# WEEK 7
chordDiagram(mat_week7, grid.col = grid.col_w7, 
             annotationTrack = "grid", 
            big.gap = 6,
             group = group_w7,
             small.gap = 3,
             link.zindex = rank(mat_week7),
             h.ratio = 0.7, 
             directional = -1,
             transparency = 0,
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_week7))))))
#Labels
circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.8, #Label size
      font = 0.1)},
  bg.border = NA)

title("Week 7")

dev.off()
circos.clear()

```

##### Types
Prepare tables
```{r fig.height= 10, fig.width=10}
#Types
###### All -----
links_df = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types = links_df %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

# Vaccination only -------
links_df_vac = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "V") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_vac = links_df_vac %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_vac = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_vac = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_vac,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)

#Infection only
links_df_inf = shared_genes_df_mirror %>% 
  filter(pvalue < 0.05,
         Shared > 1) %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond1 = condition),
             by = "Cond1") %>% 
  inner_join(annotation_conditions %>% 
               filter(disease_vac == "I") %>% 
               dplyr::select(Cond2 = condition),
             by = "Cond2") %>% 
  dplyr::select(Cond1, Cond2, jaccard_distance)

mat_types_inf = links_df_inf %>% 
  pivot_wider(names_from = "Cond2", values_from = "jaccard_distance", values_fill = list(jaccard_distance = NA)) %>% 
  column_to_rownames("Cond1") %>%
  dplyr::select(sort(names(.))) %>% 
  as.matrix()

grid.col_types_inf = ann_vaxsig_colors$Platform %>%
  as.data.frame() %>%
  rownames_to_column(color_flourish) %>%
  rename(color = ".") %>% 
  inner_join(annotation_conditions %>% 
 dplyr::select(Cond1 = condition, type), by = "type") %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, color) %>% 
  distinct() %>% 
  pull(color, Cond1)

group_types_inf = annotation_conditions %>% 
  dplyr::select(Cond1 = condition, type) %>% 
  inner_join(links_df_inf,
             by = "Cond1") %>% 
  dplyr::select(Cond1, type) %>% 
  distinct() %>% 
  pull(type, Cond1)
```

Plot
All conditions and stats
```{r fig.height= 5, fig.width=5}
#Plot

#Types

tiff(filename = here("Figures","ChordDiagram_Covid19_Types_All_jaccard_distance.tiff"), 
    width = 10, height = 10, units = "in", res = 600)

#Infection and vaccination
chordDiagram(mat_types, grid.col = grid.col_types,
             annotationTrack = "grid",  transparency = 0,
             big.gap = 3,
             small.gap = 0.5,
             directional = -1, 
             group = group_types,
             link.zindex = rank(mat_types),
              h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA)
title("Infection and Vaccination")

dev.off()
circos.clear()
```

By state
```{r fig.height= 5, fig.width=15}

png(filename = here("Figures","ChordDiagram_Covid19_Types_Inf_Vac_jaccard_distance.png"), 
    width = 6, height = 12, units = "in", res = 300)

par(mfrow = c(2, 1))
#Vaccination
chordDiagram(mat_types_vac, grid.col = grid.col_types_vac, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 3,
             small.gap = 1,
                          directional = -1,
             group = group_types,
             link.zindex = rank(mat_types_vac),
             h.ratio = 0.7, 
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_vac))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Vaccination only")

#Infection
chordDiagram(mat_types_inf, grid.col = grid.col_types_inf, 
             annotationTrack = "grid", transparency = 0,
             big.gap = 6,
             small.gap = 3,
            directional = -1,
             group = group_types,
             h.ratio = 0.7, 
             link.zindex = rank(mat_types_inf),
             preAllocateTracks = list(track.height = 0.5 * max(strwidth(unlist(dimnames(mat_types_inf))))))

circos.track(
  track.index = 1,
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter,
      CELL_META$ylim[1],
      CELL_META$sector.index,
      facing = "clockwise",
      niceFacing = TRUE,
      adj = c(0, 0.5),
      cex = 0.5, #Label size
      font = 0.1
      )},
  bg.border = NA) 
title("Infection only")
circos.clear()
dev.off()
```





### Heatmap (overlap counts) (Terminar)

```{r}

filter_pvalue_heat = 0.10

matrix_data = shared_genes_df_mirror %>% 
  filter(pvalue <= filter_pvalue_heat) %>% 
  distinct() %>% 
 dplyr::select(Cond1, Cond2, Shared) %>% 
  pivot_wider(names_from = "Cond1",
              values_from = "Shared") %>% 
  column_to_rownames("Cond2") %>% 
  as.matrix() %>% 
  replace(is.na(.), 0)

# Column and row annotation
######## Annotations
annotation_heatmap = annotation_conditions %>% 
 dplyr::select(columns_annotation) %>% 
  distinct()

#Columns
ann_cols_heatmap = matrix_data %>% 
  colnames() %>% 
  data.frame() %>% 
  rename(condition = '.') %>% 
  inner_join(annotation_heatmap, by = "condition") %>% 
  distinct() %>% 
  arrange(condition) %>% 
  column_to_rownames("condition") 
  # mutate(immune_system = str_to_upper(immune_system)) %>% 
  #dplyr::select(immune_system)

matrix_data = matrix_data %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "condition") %>% 
  inner_join(ann_cols_heatmap %>% rownames_to_column("condition"), by = "condition") %>% 
 dplyr::select(!c(immune_system)) %>% 
  arrange(module_title) %>% 
  column_to_rownames("condition") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Rows Immune ----
ann_rows_heatmap = ann_cols_heatmap

mat = matrix_data %>% 
  as.data.frame() %>% 
  rownames_to_column(var= "module_title") %>% 
  inner_join(ann_rows_heatmap %>% rownames_to_column("module_title"), by = "module_title") %>% 
 dplyr::select(!c(immune_system)) %>% 
  arrange(module_title) %>% 
  column_to_rownames("module_title") %>% 
  as.data.frame() %>% 
  mutate_if(is.character, as.numeric) %>%
  as.matrix() 

#Check dimensions
dim(mat)
dim(ann_cols_heatmap)
dim(ann_rows_heatmap)

colors_immune = list(immune_system = col_immune)

```


```{r fig.width= 10, fig.height=8}
#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = colors_immune,
                       annotation_name_side = "right")

row_ha = row_ha = HeatmapAnnotation(df = ann_rows_heatmap,
                       col = colors_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors
col_fun <- colorRamp2(c(0, 100), c("white", "#ed6a5a"))

file = "BTM_Modules_Overlapping_ImmuneSystem"

width_image = 20
height_image = 20
width = unit(10, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = here("Figures", paste0(file, sep ="_", "Complexheatmap.png"))

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                        # #cell_fun = function(j, i, x, y, width, height, fill) {
                        #                     if(mat[i, j] > 0)
                        #                     grid.text(sprintf("%.f", mat[i, j]), 
                        #                               x, y, 
                        #                               gp = gpar(fontsize = 5))},
                        show_column_names = TRUE,
                        column_title = file,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "black",
                        name = "Shared",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(0, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = F,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

heatmap_plot

dev.off()


```
 
### Heatmap (Jaccard distance) (Terminar)

```{r fig.width= 10, fig.height=8}

mat = jaccard.matrix

#Heatmap annotation
ha = HeatmapAnnotation(df = ann_cols_heatmap, 
                       col = colors_immune,
                       annotation_name_side = "right")

row_ha = row_ha = HeatmapAnnotation(df = ann_rows_heatmap,
                       col = colors_immune,
                       which= "row",
                       show_annotation_name = F,
                       show_legend = F)

# Values colors

max_value = mat %>% 
   replace(. == 1.00000, 0) %>% 
   max()

col_fun <- colorRamp2(c(0, max_value), c("white", "#ed6a5a"))

file = "BTM_Modules_Jaccard_ImmuneSystem_"
width_image = 20
height_image = 20
width = unit(10, "cm")
height = unit(10, "cm")
column_names_gp = gpar(fontsize = 10)
row_names_gp = gpar(fontsize = 10)
rect_gp = gpar(col = "gray80", lwd = 0.5)

fileimageheatmap_grouped = here("Figures", paste0(file, sep ="_", "Complexheatmap.png"))

png(file = fileimageheatmap_grouped, 
    width = width_image, 
    height = height_image, 
    units="cm", 
    res=900)

heatmap_plot = Heatmap(mat,
                        top_annotation = ha,
                        left_annotation = row_ha,
                        show_row_names = TRUE,
                        row_names_side = "right",
                        show_heatmap_legend = TRUE,
                        heatmap_legend_param = list(direction = "horizontal"),
                        col = col_fun, #color
                       cell_fun = function(j, i, x, y, width, height, fill) {
                         if (!is.na(mat[i, j]) && mat[i, j] > 0) {
                           grid.text(sprintf("%.2f", mat[i, j]), x, y, gp = gpar(fontsize = 5))
                         }
                       },
                       
                        show_column_names = TRUE,
                        column_title = file,
                        column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                        column_names_rot = 45,
                        column_names_gp = column_names_gp,
                        rect_gp = rect_gp,
                        na_col = "black",
                        name = "Jaccard distance",
                        cluster_rows = TRUE,
                        row_names_gp = row_names_gp,
                        row_dend_width = unit(1, "cm"),
                        row_split = NULL,
                        column_split = NULL,
                        row_gap = unit(2, "mm"),
                        cluster_columns = TRUE,
                        column_gap = unit(8, "mm"),
                        show_column_dend = F,
                        show_row_dend = T,
                        row_dend_side = "left",
                        column_dend_side = "top",
                        clustering_distance_rows = "euclidean",
                        border = TRUE,
                        width = width,
                        height = height)

heatmap_plot = draw(heatmap_plot, 
     annotation_legend_side = "left", 
     heatmap_legend_side = "bottom")

dev.off()

heatmap_plot

```
